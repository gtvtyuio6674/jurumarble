<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® íŒŒí‹°ê²Œì„ - ì˜¨ë¼ì¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    *{font-family:'Noto Sans KR',sans-serif;margin:0;padding:0;box-sizing:border-box}
    .title-font{font-family:'Black Han Sans',sans-serif}
    
    /* ë©”ì¸ í™ˆ ë°°ê²½ - ë„¤ì˜¨ íŒŒí‹° */
    .bg-party{
      background:linear-gradient(135deg,#0f0c29 0%,#302b63 50%,#24243e 100%);
      position:relative;overflow:hidden;
    }
    .bg-party::before{
      content:'';position:absolute;inset:0;
      background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    
    /* ì£¼ë£¨ë§ˆë¸” ë°°ê²½ - ìˆ ì§‘/í ëŠë‚Œ */
    .bg-beer{
      background:linear-gradient(180deg,#1a0a00 0%,#2d1a0a 30%,#4a2c17 60%,#2d1a0a 100%);
      position:relative;overflow:hidden;
    }
    .bg-beer::before{
      content:'';position:absolute;inset:0;
      background:radial-gradient(ellipse at 20% 20%,rgba(255,180,50,0.15) 0%,transparent 50%),
                 radial-gradient(ellipse at 80% 80%,rgba(255,150,30,0.1) 0%,transparent 50%),
                 radial-gradient(ellipse at 50% 50%,rgba(139,69,19,0.2) 0%,transparent 70%);
    }
    .bg-beer::after{
      content:'ğŸº';position:absolute;font-size:200px;opacity:0.03;top:10%;right:-50px;transform:rotate(15deg);
    }
    
    /* ë£°ë › ë°°ê²½ - ì¹´ì§€ë…¸ ëŠë‚Œ */
    .bg-roulette{
      background:linear-gradient(135deg,#0a0015 0%,#1a0030 25%,#2d1050 50%,#1a0030 75%,#0a0015 100%);
      position:relative;overflow:hidden;
    }
    .bg-roulette::before{
      content:'';position:absolute;inset:0;
      background:radial-gradient(ellipse at 30% 20%,rgba(168,85,247,0.2) 0%,transparent 50%),
                 radial-gradient(ellipse at 70% 80%,rgba(236,72,153,0.15) 0%,transparent 50%),
                 repeating-linear-gradient(45deg,transparent,transparent 35px,rgba(255,255,255,0.02) 35px,rgba(255,255,255,0.02) 70px);
    }
    .bg-roulette::after{
      content:'ğŸ°';position:absolute;font-size:180px;opacity:0.05;bottom:5%;left:-30px;transform:rotate(-10deg);
    }
    
    /* ë¼ì´ì–´ ê²Œì„ ë°°ê²½ - ë¯¸ìŠ¤í„°ë¦¬/ì–´ë‘  */
    .bg-liar{
      background:linear-gradient(180deg,#0a0a0a 0%,#1a0a0a 30%,#2a1015 60%,#0a0a0a 100%);
      position:relative;overflow:hidden;
    }
    .bg-liar::before{
      content:'';position:absolute;inset:0;
      background:radial-gradient(ellipse at 50% 0%,rgba(220,38,38,0.15) 0%,transparent 50%),
                 radial-gradient(ellipse at 20% 80%,rgba(239,68,68,0.1) 0%,transparent 40%),
                 radial-gradient(ellipse at 80% 60%,rgba(185,28,28,0.1) 0%,transparent 40%);
    }
    .bg-liar::after{
      content:'ğŸ­';position:absolute;font-size:200px;opacity:0.04;top:20%;right:-60px;transform:rotate(20deg);
    }
    
    /* ì§„ì‹¤ê²Œì„ ë°°ê²½ - ì‹ ë¹„ë¡œìš´ ëŠë‚Œ */
    .bg-truth{
      background:linear-gradient(135deg,#0c1929 0%,#1e3a5f 40%,#0d2137 100%);
      position:relative;overflow:hidden;
    }
    .bg-truth::before{
      content:'';position:absolute;inset:0;
      background:radial-gradient(ellipse at 50% 30%,rgba(251,191,36,0.15) 0%,transparent 50%),
                 radial-gradient(ellipse at 20% 70%,rgba(6,182,212,0.1) 0%,transparent 40%),
                 radial-gradient(ellipse at 80% 80%,rgba(59,130,246,0.1) 0%,transparent 40%);
    }
    .bg-truth::after{
      content:'ğŸ¯';position:absolute;font-size:180px;opacity:0.05;bottom:10%;right:-40px;transform:rotate(-15deg);
    }
    
    /* ê·¸ë¦¼ ê²Œì„ ë°°ê²½ - ì•„íŠ¸ ìŠ¤íŠœë””ì˜¤ */
    .bg-draw{
      background:linear-gradient(135deg,#0f2027 0%,#203a43 40%,#2c5364 100%);
      position:relative;overflow:hidden;
    }
    .bg-draw::before{
      content:'';position:absolute;inset:0;
      background:radial-gradient(ellipse at 30% 20%,rgba(34,197,94,0.15) 0%,transparent 50%),
                 radial-gradient(ellipse at 70% 70%,rgba(16,185,129,0.1) 0%,transparent 40%),
                 radial-gradient(ellipse at 50% 90%,rgba(5,150,105,0.1) 0%,transparent 40%);
    }
    .bg-draw::after{
      content:'ğŸ¨';position:absolute;font-size:180px;opacity:0.05;top:15%;left:-40px;transform:rotate(-20deg);
    }
    
    .bg-lobby{background:linear-gradient(180deg,rgba(0,0,0,0.4) 0%,rgba(0,0,0,0.2) 50%,rgba(0,0,0,0.4) 100%)}
    
    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes float{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-15px) rotate(2deg)}}
    @keyframes float-reverse{0%,100%{transform:translateY(0) rotate(2deg)}50%{transform:translateY(-12px) rotate(-2deg)}}
    @keyframes bounce-in{0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.05)}100%{transform:scale(1);opacity:1}}
    @keyframes fade-scale{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
    @keyframes slide-up{0%{transform:translateY(50px);opacity:0}100%{transform:translateY(0);opacity:1}}
    @keyframes dice-roll{0%{transform:rotate(0deg) scale(1)}50%{transform:rotate(-20deg) scale(1.1)}100%{transform:rotate(0deg) scale(1)}}
    @keyframes result-pop{0%{transform:scale(0);opacity:0}100%{transform:scale(1);opacity:1}}
    @keyframes golden-glow{0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.5)}50%{box-shadow:0 0 40px rgba(255,215,0,0.8)}}
    @keyframes twinkle{0%,100%{opacity:0.3}50%{opacity:1}}
    @keyframes arrow-spin{0%{transform:translate(-50%,-50%) rotate(0deg)}100%{transform:translate(-50%,-50%) rotate(var(--spin-deg))}}
    @keyframes pulse-glow{0%,100%{box-shadow:0 0 20px rgba(251,191,36,0.5)}50%{box-shadow:0 0 40px rgba(251,191,36,0.8)}}
    @keyframes bomb-shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    @keyframes countdown-pulse{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
    @keyframes neon-pulse{0%,100%{text-shadow:0 0 10px currentColor,0 0 20px currentColor}50%{text-shadow:0 0 20px currentColor,0 0 40px currentColor,0 0 60px currentColor}}
    @keyframes sparkle{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
    
    .animate-float{animation:float 4s ease-in-out infinite}
    .animate-float-reverse{animation:float-reverse 5s ease-in-out infinite}
    .animate-bounce-in{animation:bounce-in 0.5s ease-out}
    .animate-fade-scale{animation:fade-scale 0.6s ease-out forwards}
    .animate-slide-up{animation:slide-up 0.5s ease-out forwards}
    .animate-dice-roll{animation:dice-roll 0.15s ease-in-out infinite}
    .animate-result-pop{animation:result-pop 0.6s ease-out forwards}
    .animate-golden-glow{animation:golden-glow 1.5s ease-in-out infinite}
    .animate-twinkle{animation:twinkle 2s ease-in-out infinite}
    .arrow-spin{animation:arrow-spin 3s cubic-bezier(0.2,0.8,0.3,1) forwards}
    .pulse-glow{animation:pulse-glow 1.5s ease-in-out infinite}
    .animate-bomb-shake{animation:bomb-shake 0.5s ease-in-out infinite}
    .animate-countdown{animation:countdown-pulse 1s ease-in-out infinite}
    .animate-neon{animation:neon-pulse 2s ease-in-out infinite}
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card-glass{background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.2)}
    .card-wood{background:linear-gradient(145deg,#5a4030 0%,#4a3525 50%,#3a2a1a 100%);border:3px solid #6d5040;box-shadow:0 10px 30px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.1)}
    .card-dark{background:linear-gradient(145deg,#2d2d44 0%,#1a1a2e 50%,#16162a 100%);border:2px solid #3d3d5c;box-shadow:0 8px 32px rgba(0,0,0,0.4)}
    .card-purple{background:linear-gradient(145deg,#2a1040 0%,#1a0828 50%,#10051a 100%);border:2px solid #5c3d8c;box-shadow:0 0 30px rgba(139,92,246,0.2)}
    .card-golden{background:linear-gradient(145deg,#ffd700 0%,#ffb800 50%,#ff9500 100%);border:3px solid #ffe44d;box-shadow:0 0 30px rgba(255,215,0,0.4)}
    .card-liar{background:linear-gradient(145deg,#2a1a1a 0%,#1a1010 50%,#100808 100%);border:2px solid #5c3030;box-shadow:0 0 20px rgba(239,68,68,0.15)}
    .card-truth{background:linear-gradient(145deg,#1e3a5f 0%,#152238 50%,#0d1520 100%);border:2px solid #2d5a8a;box-shadow:0 0 20px rgba(59,130,246,0.15)}
    .card-draw{background:linear-gradient(145deg,#2d4a2d 0%,#1a3a1a 50%,#0d200d 100%);border:2px solid #3d6a3d;box-shadow:0 0 20px rgba(34,197,94,0.15)}
    
    /* ê²Œì„ ì¹´ë“œ */
    .game-card{background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.15);transition:all 0.4s;backdrop-filter:blur(10px)}
    .game-card:hover{transform:translateY(-8px) scale(1.02);border-color:rgba(255,255,255,0.4);box-shadow:0 20px 40px rgba(0,0,0,0.3)}
    
    /* íƒ€ì¼ ìŠ¤íƒ€ì¼ */
    .tile-drink{background:linear-gradient(135deg,#D97706,#B45309)}.tile-game{background:linear-gradient(135deg,#059669,#047857)}
    .tile-bonus{background:linear-gradient(135deg,#2563EB,#1D4ED8)}.tile-move{background:linear-gradient(135deg,#7C3AED,#6D28D9)}
    .tile-special{background:linear-gradient(135deg,#F59E0B,#D97706)}.tile-free{background:linear-gradient(135deg,#6B7280,#4B5563)}
    .tile-start{background:linear-gradient(135deg,#10B981,#059669)}.tile-performance{background:linear-gradient(135deg,#EC4899,#DB2777)}
    .tile-island{background:linear-gradient(135deg,#0ea5e9,#0284c7)}
    .tile-toIsland{background:linear-gradient(135deg,#f97316,#ea580c)}
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-primary{background:linear-gradient(180deg,#8b5cf6,#7c3aed);border:2px solid #6d28d9;box-shadow:0 4px 0 #5b21b6,0 0 20px rgba(139,92,246,0.3)}
    .btn-beer{background:linear-gradient(180deg,#F4A836,#D4891C);border:2px solid #B8731A;box-shadow:0 4px 0 #8B5A14,0 0 15px rgba(244,168,54,0.3)}
    .btn-purple{background:linear-gradient(180deg,#a855f7,#9333ea);border:2px solid #7e22ce;box-shadow:0 4px 0 #6b21a8,0 0 15px rgba(168,85,247,0.3)}
    .btn-liar{background:linear-gradient(180deg,#ef4444,#dc2626);border:2px solid #b91c1c;box-shadow:0 4px 0 #991b1b,0 0 15px rgba(239,68,68,0.3)}
    .btn-truth{background:linear-gradient(180deg,#f59e0b,#d97706);border:2px solid #b45309;box-shadow:0 4px 0 #92400e,0 0 15px rgba(245,158,11,0.3)}
    .btn-draw{background:linear-gradient(180deg,#22c55e,#16a34a);border:2px solid #15803d;box-shadow:0 4px 0 #166534,0 0 15px rgba(34,197,94,0.3)}
    .btn-danger{background:linear-gradient(180deg,#ef4444,#dc2626);border:2px solid #b91c1c;box-shadow:0 4px 0 #991b1b}
    .btn-secondary{background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.3)}
    .btn-ghost{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)}
    
    /* ì…ë ¥ í•„ë“œ */
    .input-dark{background:rgba(0,0,0,0.5);border:2px solid rgba(139,92,246,0.3);color:white}
    .input-dark:focus{border-color:#8b5cf6;outline:none;box-shadow:0 0 15px rgba(139,92,246,0.3)}
    .input-beer{background:rgba(0,0,0,0.4);border:2px solid rgba(244,168,54,0.3);color:white}
    .input-beer:focus{border-color:#F4A836;outline:none}
    .input-liar{background:rgba(0,0,0,0.4);border:2px solid rgba(239,68,68,0.3);color:white}
    .input-liar:focus{border-color:#ef4444;outline:none}
    .input-truth{background:rgba(0,0,0,0.4);border:2px solid rgba(245,158,11,0.3);color:white}
    .input-truth:focus{border-color:#f59e0b;outline:none}
    .input-draw{background:rgba(0,0,0,0.4);border:2px solid rgba(34,197,94,0.3);color:white}
    .input-draw:focus{border-color:#22c55e;outline:none}
    
    .player-token{box-shadow:0 3px 6px rgba(0,0,0,0.4);border:2px solid rgba(255,255,255,0.5)}
    .roulette-wheel{transition:transform 4s cubic-bezier(0.2,0.8,0.3,1)}
    
    .liar-card-container{perspective:1000px}
    .liar-card-inner{position:relative;width:100%;height:100%;transition:transform 0.8s;transform-style:preserve-3d}
    .liar-card-inner.flipped{transform:rotateY(180deg)}
    .liar-card-front,.liar-card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:1rem}
    .liar-card-back{transform:rotateY(180deg)}
    
    .scroll-area{max-height:60vh;overflow-y:auto}
    .star{position:absolute;background:white;border-radius:50%;pointer-events:none}
    
    .chat-toggle{position:fixed;bottom:20px;right:20px;z-index:40}
    .chat-panel{position:fixed;bottom:90px;right:20px;width:300px;max-height:400px;z-index:40;transition:all 0.3s}
    .chat-panel.hidden{opacity:0;transform:translateY(20px);pointer-events:none}
    
    .admin-btn{position:fixed;top:10px;left:10px;width:40px;height:40px;z-index:100;cursor:pointer;opacity:0.01}
    .maintenance-screen{position:fixed;inset:0;background:linear-gradient(135deg,#1a1a2e,#0f0f1a);display:flex;align-items:center;justify-content:center;z-index:9999}
    
    .draw-canvas{background:white;border-radius:8px;border:3px solid #3d6a3d;cursor:crosshair;touch-action:none;max-width:100%}
    .color-palette{display:flex;flex-wrap:wrap;gap:4px;justify-content:center}
    .color-btn{width:24px;height:24px;border-radius:4px;border:2px solid transparent;cursor:pointer;transition:all 0.2s}
    .color-btn:hover{transform:scale(1.1)}
    .color-btn.active{border-color:white;transform:scale(1.2);box-shadow:0 0 10px currentColor}
    
    /* íŒŒí‹°í´ íš¨ê³¼ */
    .particle{position:absolute;pointer-events:none;border-radius:50%}
  </style>
</head>
<body>
<div id="app"></div>
<script>
const firebaseConfig={apiKey:"AIzaSyCafzk3QueRsvj4DiMht6bTyHs0_HT5Iuc",authDomain:"test-e3974.firebaseapp.com",databaseURL:"https://test-e3974-default-rtdb.firebaseio.com",projectId:"test-e3974",storageBucket:"test-e3974.firebasestorage.app",messagingSenderId:"572983111486",appId:"1:572983111486:web:ce4e3f897f8faa66c4866f",measurementId:"G-S8J76VQ7MF"};
let db=null,isFirebaseReady=false;
try{firebase.initializeApp(firebaseConfig);db=firebase.database();isFirebaseReady=true}catch(e){console.log('Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...')}

const ADMIN_ID='gtv22700',ADMIN_PW='gtvtyuio6674';
const SOUNDS={click:'data:audio/wav;base64,UklGRl4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YToAAAAPD3J/f39ycg8P',dice:'data:audio/wav;base64,UklGRoAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVwAAABwcHB/f39/f3BwUFBQQEBAQEBQUHBwf39/f3BwUFBQYGBwcH9/f39wcFBQUEBAUFBwcH9/f39wcA==',mission:'data:audio/wav;base64,UklGRpAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YWwAAABQUGBwf39/f3BwYFBQQEBAUGBwf39/cGBQQEBQYHB/f39wYFBAQFBgcH9/f3BgUEBAUGBwf39/cGBQQEBQYHB/f39wYFBAQA==',win:'data:audio/wav;base64,UklGRsAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YZwAAAAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDA=',golden:'data:audio/wav;base64,UklGRuAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YbwAAAAgMEBQYHB/f39/f3BwYFBAMCAgMEBQYHB/f39/f3BwYFBAMCAgMEBQYHB/f39/f3BwYFBAMCAgMEBQYHB/f39/f3BwYFBAMCAgMEBQYHB/f39/f3BwYFBAMCAgMEBQYHB/f39/f3BwYFBAMCAgMEBQYHB/f39/cA==',join:'data:audio/wav;base64,UklGRnAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YUwAAABQUGBwf39/cGBQUFBgcH9/f3BgUFBQYHB/f39wYFBQUGBwf39/cGBQUFBgcH9/f3BgUA==',success:'data:audio/wav;base64,UklGRqAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YXwAAAAwQFBgcH9/f39wcGBQQDAwQFBgf39/f3BgUEBAUGBwf39/cGBQQFBgcH9/f3BgUEBQYHB/f39wYFBAUGBwf39/cGBQQA==',kick:'data:audio/wav;base64,UklGRnQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVAAAAB/f29fT0BAQFBfb39/f29fT0BAT19vf39vX09AQE9fb39/b19PQEBPXw==',flip:'data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YUAAAABAQFBYYG9/f39vYFhQQEBIUFhob39/b2hYUEBASFBYaG9/f29oWFBASA==',discuss:'data:audio/wav;base64,UklGRoQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YWAAAABAUGBwf39/cGBQQEBQYHB/f39wYFBAQFBgcH9/f3BgUEBAUGBwf39/cGBQQEBQYHB/f39wYFBA',vote:'data:audio/wav;base64,UklGRlwAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YTgAAABQYHB/f39wYFBQYHB/f39wYFBQYHB/f39wYFBQYHB/f39wYFBA',reveal:'data:audio/wav;base64,UklGRqQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYAAAAAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDA=',spin:'data:audio/wav;base64,UklGRrgAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YZQAAAAwQFBgcH9/cGBQQDBAUGBwf39wYFBAMEBQYHB/f3BgUEAwQFBgcH9/cGBQQDBAUGBwf39wYFBAMEBQYHB/f3BgUEAwQFBgcH9/cGBQQDBAUGBwf39wYFBAMEBQYHB/f3BgUA==',escape:'data:audio/wav;base64,UklGRsAAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YZwAAAAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDAwQFBgcH9/f39wcGBQQDA=',caught:'data:audio/wav;base64,UklGRnQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVAAAAB/f29fT0BAQFBfb39/f29fT0BAT19vf39vX09AQE9fb39/b19PQEBPX29/f29fT0BAQE9fb39/b19PQEA=',arrow:'data:audio/wav;base64,UklGRrgAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YZQAAAAgMEBQYHB4f39/f3h4cGhgUEAwICAwQFBgcHh/f394eHBoYFBAMCAgMEBQYHB4f39/eHhwaGBQQDAgIDBAUGBweH9/f3h4cGhgUEAwICAwQFBgcHh/f39/eHBoYFBAMCA=',chat:'data:audio/wav;base64,UklGRlgAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YTQAAAA4QEhQWGBob3B/f39wcGhgWFBIQDg4QEhQYGhwf39wcGBoYFhQSD8=',wrong:'data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YUAAAAB/f29fT0BAT19vf29fT0BAT19vf29fT0BAT19vf29fT0BAT19vf29fT0BA',bomb:'data:audio/wav;base64,UklGRsQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YaAAAAB/f39/f39/f39vb29vX19fX09PT09AQEBAMDAwMCAgICAQEBAQEBAQECAgICAwMDBAQEBQUFBgYGBwcHB/f39/f39/f3BwcGBgYFBQUEBAQDAwMCAgIBAQEA=='};
function playSound(type){try{new Audio(SOUNDS[type]||SOUNDS.click).play()}catch(e){}}

const UPDATE_LOGS=[
  {version:'v1.7.0',date:'2025ë…„ 12ì›” 11ì¼',changes:['ğŸ¨ ê·¸ë¦¼ê²Œì„ ëŒ€í­ ê°œì„  (ì§€ìš°ê°œ, 26ìƒ‰ íŒ”ë ˆíŠ¸, ë¼ìš´ë“œX)','ğŸ’£ í­íƒ„ ëŒë¦¬ê¸° 10ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´','ğŸï¸ ë¬´ì¸ë„ ìœ„ì¹˜ ë³€ê²½ (7â†’6) ë° íƒˆì¶œ ì„¤ëª… ì¶”ê°€','ğŸ”‘ í™©ê¸ˆì—´ì‡  ì „ë©´ ê°œí¸ (16ì¢…)','ğŸ”„ ì—­í• êµì²´ í”Œë ˆì´ì–´ ì„ íƒ ê¸°ëŠ¥','ğŸ¤– ë§¤í¬ë¡œ ê°ì§€ ìë™ ì¶”ë°©','ğŸ› ï¸ ì ê²€ ì¤‘ ê´€ë¦¬ì ì ‘ê·¼ ê°€ëŠ¥','ğŸ® ê²Œì„ë³„ í™”ë ¤í•œ ë°°ê²½ ì¶”ê°€']},
  {version:'v1.6.0',date:'2025ë…„ 12ì›” 11ì¼',changes:['ğŸ¯ ì§€ëª©ê²Œì„ í™”ì‚´í‘œ íŒì • ê°œì„ ','ğŸ¨ ê·¸ë¦¼ ì œì‹œì–´ ê²Œì„ ì¶”ê°€','âœ¨ ë¡œë¹„ UI ì—…ê·¸ë ˆì´ë“œ','ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… ì‹œìŠ¤í…œ']},
  {version:'v1.5.0',date:'2025ë…„ 12ì›” 10ì¼',changes:['ğŸ’¬ ê° ê²Œì„ë³„ ì±„íŒ… ì‹œìŠ¤í…œ','ğŸ› ï¸ ê´€ë¦¬ì ì ê²€ ëª¨ë“œ ì¶”ê°€','ğŸï¸ ë¬´ì¸ë„ íƒˆì¶œ ê·œì¹™','ğŸ†˜ êµ¬ì› íˆ¬í‘œ ì‹œìŠ¤í…œ']},
  {version:'v1.4.0',date:'2025ë…„ 12ì›” 10ì¼',changes:['ğŸ¯ ì§„ì‹¤ê²Œì„ í™”ì‚´í‘œ íƒ€ê²Ÿ ì‹œìŠ¤í…œ','ğŸ­ ë¼ì´ì–´ ê²Œì„ ê°œì„ ','ğŸ”‘ í™©ê¸ˆì—´ì‡  ë‹¤ì–‘í™”']},
  {version:'v1.3.0',date:'2025ë…„ 12ì›” 9ì¼',changes:['ğŸ† ì£¼ë£¨ë§ˆë¸” ìŠ¹ë¦¬ ì¡°ê±´','ğŸ‘‘ í˜¸ìŠ¤íŠ¸ ê´€ë¦¬ ê¸°ëŠ¥','ğŸ² ì£¼ì‚¬ìœ„ ì• ë‹ˆë©”ì´ì…˜']},
  {version:'v1.2.0',date:'2025ë…„ 12ì›” 9ì¼',changes:['ğŸ’• ì• êµëŒ€ì‚¬ 50ê°œ','ğŸ”Š íš¨ê³¼ìŒ ì¶”ê°€','ğŸ¡ ë£°ë › ê¸°ëŠ¥ ê°œì„ ']},
  {version:'v1.1.0',date:'2025ë…„ 12ì›” 8ì¼',changes:['ğŸ­ ë¼ì´ì–´ ê²Œì„ ì¶”ê°€','ğŸ¯ ì§„ì‹¤ê²Œì„ ì¶”ê°€','ğŸ“± ëª¨ë°”ì¼ ìµœì í™”']},
  {version:'v1.0.0',date:'2025ë…„ 12ì›” 7ì¼',changes:['ğŸº ì£¼ë£¨ë§ˆë¸” ì¶œì‹œ','ğŸ¡ ë£°ë › ê¸°ëŠ¥','ğŸ”¥ Firebase ë©€í‹°í”Œë ˆì´']}
];

const GAMES=[
  {id:'jurumarble',name:'ì£¼ë£¨ë§ˆë¸”',emoji:'ğŸº',desc:'ìˆ ê²Œì„ ë³´ë“œê²Œì„!',color:'from-amber-500 to-orange-600',glow:'rgba(245,158,11,0.4)',bg:'bg-beer',min:2,max:8},
  {id:'roulette',name:'ë£°ë ›',emoji:'ğŸ¡',desc:'ëœë¤ ë½‘ê¸°!',color:'from-purple-500 to-pink-500',glow:'rgba(168,85,247,0.4)',bg:'bg-roulette',solo:true},
  {id:'liar',name:'ë¼ì´ì–´ ê²Œì„',emoji:'ğŸ­',desc:'ê±°ì§“ë§ìŸì´ë¥¼ ì°¾ì•„ë¼!',color:'from-red-500 to-rose-600',glow:'rgba(239,68,68,0.4)',bg:'bg-liar',min:3,max:10},
  {id:'truth',name:'ì§„ì‹¤ê²Œì„',emoji:'ğŸ¯',desc:'ì§€ëª©ëœ ì‚¬ëŒì´ ë²Œì¹™!',color:'from-cyan-500 to-blue-500',glow:'rgba(6,182,212,0.4)',bg:'bg-truth',min:2,max:12},
  {id:'draw',name:'ê·¸ë¦¼ ì œì‹œì–´',emoji:'ğŸ¨',desc:'ê·¸ë¦¼ìœ¼ë¡œ ë§ì¶°ë¼!',color:'from-green-500 to-emerald-600',glow:'rgba(34,197,94,0.4)',bg:'bg-draw',min:3,max:10}
];

const AEGYO_LIST=[{id:1,level:'â˜…â˜†â˜†â˜†â˜†',text:'(ì–‘ì† ë¸Œì´í•˜ë©°) ì˜¤ë¹ ~ ì‚¬ë‘í•´ìš”~â™¥'},{id:2,level:'â˜…â˜†â˜†â˜†â˜†',text:'ì˜¤ë¹ ê°€ ì œì¼ ì¢‹ì•„~ (ë³¼ í•˜íŠ¸)'},{id:3,level:'â˜…â˜†â˜†â˜†â˜†',text:'(ëˆˆ ê¹œë¹¡ê¹œë¹¡) ì˜¤ë¹ ~ ë­í•´?'},{id:4,level:'â˜…â˜†â˜†â˜†â˜†',text:'ì˜¤ë¹  ìµœê³ ! (ì—„ì§€ì²™)'},{id:5,level:'â˜…â˜†â˜†â˜†â˜†',text:'(ê³ ê°œ ê°¸ìš°ëš±) ì˜¤ë¹ ~ ë‚˜ ì˜ˆë»?'},{id:6,level:'â˜…â˜…â˜†â˜†â˜†',text:'ì˜¤ë¹ ~ ë‚˜ ì‹¬ì‹¬í•´~ ë†€ì•„ì¤˜~'},{id:7,level:'â˜…â˜…â˜†â˜†â˜†',text:'(íŒ”ì§± ë¼ë©°) ì˜¤ë¹  íŒ”! ë‚´êº¼~'},{id:8,level:'â˜…â˜…â˜†â˜†â˜†',text:'ì˜¤ë¹ ~ ë‚˜ ë°°ê³ íŒŒ~ ë°¥ ì‚¬ì¤˜~'},{id:9,level:'â˜…â˜…â˜†â˜†â˜†',text:'(ì–‘ ë³¼ ì†ìœ¼ë¡œ ê°ì‹¸ë©°) ì˜¤ë¹ ~ ë‚´ ë³¼ ë§ë‘ë§ë‘í•´~'},{id:10,level:'â˜…â˜…â˜†â˜†â˜†',text:'ì˜¤ë¹ ~ ì†ì¡ì•„ë„ ë¼? (ì† ë‚´ë°€ë©°)'},{id:11,level:'â˜…â˜…â˜…â˜†â˜†',text:'ì˜¤ë¹ ~ ë‚˜ ì—†ìœ¼ë©´ ì–´ë–¡í•´~ í¥!'},{id:12,level:'â˜…â˜…â˜…â˜†â˜†',text:'ì˜¤ë¹ ~ ë‚˜ ì¡¸ë ¤~ ë¬´ë¦ ë¹Œë ¤ì¤˜~'},{id:13,level:'â˜…â˜…â˜…â˜†â˜†',text:'(ì†ê°€ë½ í•˜íŠ¸) ì˜¤ë¹ ~ ë‚˜ ì‚¬ë‘í•˜ì§€~?'},{id:14,level:'â˜…â˜…â˜…â˜†â˜†',text:'ì˜¤ë¹ ~ ë½€ë½€~ (ë³¼ ë‚´ë°€ë©°)'},{id:15,level:'â˜…â˜…â˜…â˜…â˜†',text:'ì˜¤ë¹ ~ ê¿ˆì—ì„œ ë´¤ì–´~ ë„ˆë¬´ ì¢‹ì•˜ì–´~'},{id:16,level:'â˜…â˜…â˜…â˜…â˜†',text:'ì˜¤ë¹ ~ í‰ìƒ í•¨ê»˜ í•˜ì~ ì•½ì†!'},{id:17,level:'â˜…â˜…â˜…â˜…â˜…',text:'ì˜¤ë¹ ~ ë‚´ê°€ ì„¸ìƒì—ì„œ ì œì¼ ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒì´ì•¼~'},{id:18,level:'â˜…â˜…â˜…â˜…â˜…',text:'ìê¸°ê°€ ìˆì–´ì„œ ì„¸ìƒì´ ë¹›ë‚˜~'}];

const GOLDEN_KEYS=[
  {emoji:'ğŸ‘‘',text:'ì§€ëª©í•œ ì‚¬ëŒ ì• êµ ì‹œí‚¤ê¸°!',type:'aegyo-target'},
  {emoji:'ğŸ¦¸',text:'í‘ê¸°ì‚¬ê¶Œ! ì§€ëª©í•œ ì‚¬ëŒ ëŒ€ì‹  ìŒë£Œ ì„­ì·¨',type:'blackknight'},
  {emoji:'ğŸ’£',text:'í­íƒ„ ëŒë¦¬ê¸°! 10ì´ˆ ì•ˆì— ë‹¤ìŒ ì‚¬ëŒ ì§€ëª©',type:'bomb'},
  {emoji:'ğŸ”„',text:'ì—­í•  êµì²´! ì›í•˜ëŠ” ì‚¬ëŒê³¼ ìœ„ì¹˜ ë°”ê¾¸ê¸°',type:'swap-select'},
  {emoji:'ğŸª',text:'ì§„ì‹¤ ê³ ë°±! ê°€ì¥ ë¶€ë„ëŸ¬ì› ë˜ ìˆœê°„ ë§í•˜ê¸°',type:'truth-moment'},
  {emoji:'ğŸ‘»',text:'ë¬´ì¸ë„ ê¹Œë°©ê¶Œ íšë“!',type:'island-skip'},
  {emoji:'ğŸŒŸ',text:'ìŠ¤íƒ€ ë“±ì¥! ëª¨ë‘ê°€ ë‹¹ì‹ ì„ ì¹­ì°¬í•´ì•¼ í•¨',type:'praise'},
  {emoji:'ğŸ¬',text:'ëª…ëŒ€ì‚¬! ì˜í™”/ë“œë¼ë§ˆ ëŒ€ì‚¬ ë”°ë¼í•˜ê¸°',type:'movie-line'},
  {emoji:'ğŸ¤',text:'ë…¸ë˜ë°© íƒ€ì„! 1ì ˆ ë¶€ë¥´ê¸°',type:'sing'},
  {emoji:'ğŸ’€',text:'ë°ìŠ¤ë§¤ì¹˜! ì§€ëª©í•œ ì‚¬ëŒê³¼ ê°€ìœ„ë°”ìœ„ë³´',type:'rps'},
  {emoji:'ğŸ”®',text:'ì˜ˆì–¸ì! ë‹¤ìŒ ì£¼ì‚¬ìœ„ ìˆ«ì ë§ì¶”ê¸°',type:'predict'},
  {emoji:'ğŸ',text:'ëŸ­í‚¤ë°•ìŠ¤! í™©ê¸ˆì—´ì‡  ë‹¤ì‹œ ë½‘ê¸°',type:'lucky-box'},
  {emoji:'ğŸƒ',text:'ì¡°ì»¤! ì•„ë¬´ ë²Œì¹™ì´ë‚˜ ë©´ì œê¶Œ íšë“',type:'joker'},
  {emoji:'ğŸ»',text:'ê±´ë°°! ëª¨ë‘ í•œ ëª¨ê¸ˆì”© ë§ˆì‹œê¸°',type:'cheers'},
  {emoji:'ğŸ˜‚',text:'ê°œê·¸íƒ€ì„! 30ì´ˆ ì•ˆì— í•œ ëª…ì´ë¼ë„ ì›ƒê¸°ê¸°',type:'comedy'},
  {emoji:'ğŸµ',text:'ì½§ë…¸ë˜! ë…¸ë˜ í¥ì–¼ê±°ë ¤ì„œ ë§ì¶”ê¸°',type:'humming'}
];

const TILES=[
  {id:0,name:"ì¶œë°œ",type:"start",emoji:"ğŸš€",desc:"ì¶œë°œ!"},
  {id:1,name:"ì²«ì¸ìƒ",type:"drink",emoji:"ğŸ‘‹",desc:"ì˜† ì‚¬ëŒ ì²«ì¸ìƒ ë§í•˜ê¸°!"},
  {id:2,name:"ì• êµ ëŒ€ì‚¬",type:"performance",emoji:"ğŸ¥°",desc:"ì• êµ ëŒ€ì‚¬ 1ê°œ!"},
  {id:3,name:"3.6.9",type:"game",emoji:"ğŸ‘",desc:"369 ê²Œì„!"},
  {id:4,name:"ì´ˆì„±í€´ì¦ˆ",type:"game",emoji:"ğŸ”¤",desc:"ì´ˆì„±í€´ì¦ˆ!"},
  {id:5,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:6,name:"ë¬´ì¸ë„í–‰",type:"toIsland",emoji:"ğŸš¢",desc:"ë¬´ì¸ë„ë¡œ ì§í–‰!"},
  {id:7,name:"ì›ƒìŒì°¸ê¸°",type:"game",emoji:"ğŸ˜‚",desc:"30ì´ˆ ì›ƒìŒì°¸ê¸°!"},
  {id:8,name:"ì†”ì§í† í¬",type:"drink",emoji:"ğŸ¤«",desc:"ë¹„ë°€ í•˜ë‚˜ ê³µê°œ!"},
  {id:9,name:"ëˆˆì¹˜ê²Œì„",type:"game",emoji:"ğŸ‘€",desc:"ëˆˆì¹˜ê²Œì„!"},
  {id:10,name:"ë’¤ë¡œ 2ì¹¸",type:"move",emoji:"â¬…ï¸",desc:"ë‘ ì¹¸ ë’¤ë¡œ!"},
  {id:11,name:"TMI ê³µê°œ",type:"game",emoji:"ğŸ’¬",desc:"ì˜¤ëŠ˜ì˜ TMI!"},
  {id:12,name:"ì‰¬ì–´ê°€ê¸°",type:"free",emoji:"ğŸ˜´",desc:"ì‰¬ì–´ê°€ì„¸ìš”~"},
  {id:13,name:"ì¹­ì°¬íƒ€ì„",type:"drink",emoji:"ğŸ’•",desc:"ì˜† ì‚¬ëŒ ì¹­ì°¬!"},
  {id:14,name:"ì„±ëŒ€ëª¨ì‚¬",type:"performance",emoji:"ğŸ­",desc:"ì„±ëŒ€ëª¨ì‚¬!"},
  {id:15,name:"ì—…ë‹¤ìš´",type:"game",emoji:"ğŸ”¢",desc:"ìˆ«ì ì—…ë‹¤ìš´!"},
  {id:16,name:"ì´ìƒí˜•",type:"drink",emoji:"ğŸ’˜",desc:"ì´ìƒí˜• íƒ€ì… ê³ ë°±!"},
  {id:17,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:18,name:"ë¬´ì¸ë„",type:"island",emoji:"ğŸï¸",desc:"1,2ê°€ ë‚˜ì™€ì•¼ íƒˆì¶œ!"},
  {id:19,name:"ì†ë³‘í˜¸",type:"game",emoji:"âœ‹",desc:"ì†ê°€ë½ ê±¸ê¸°!"},
  {id:20,name:"ì£¼ì‚¬ìœ„ ë”",type:"bonus",emoji:"ğŸ²",desc:"í•œ ë²ˆ ë”!"},
  {id:21,name:"ë°¸ëŸ°ìŠ¤ê²Œì„",type:"drink",emoji:"âš–ï¸",desc:"ë°¸ëŸ°ìŠ¤ ê²Œì„!"},
  {id:22,name:"ëˆˆì‹¸ì›€",type:"game",emoji:"ğŸ‘ï¸",desc:"ëˆˆì‹¸ì›€! ë¨¼ì € ê¹œë¹¡ì´ë©´ ë²Œì¹™!"},
  {id:23,name:"ë°ˆ ì±Œë¦°ì§€",type:"performance",emoji:"ğŸ¤ª",desc:"ìœ í–‰í•˜ëŠ” ë°ˆ ë”°ë¼í•˜ê¸°!"},
  {id:24,name:"ë°•ìˆ˜ê²Œì„",type:"game",emoji:"ğŸ‘",desc:"369 ë°•ìˆ˜ì¹˜ê¸°!"},
  {id:25,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:26,name:"ì—°ë½ê³µê°œ",type:"drink",emoji:"ğŸ“±",desc:"ìµœê·¼ ì—°ë½í•œ ì‚¬ëŒ ê³µê°œ!"},
  {id:27,name:"ê³ ë°±ì—°ê¸°",type:"performance",emoji:"ğŸ’Œ",desc:"ê³ ë°±ì—°ê¸°!"},
  {id:28,name:"ëœë¤ê²Œì„",type:"game",emoji:"ğŸ°",desc:"ëœë¤ ê²Œì„!"},
  {id:29,name:"ë’¤ë¡œ 3ì¹¸",type:"move",emoji:"âª",desc:"ì„¸ ì¹¸ ë’¤ë¡œ!"},
  {id:30,name:"ë³„ëª…ì§“ê¸°",type:"performance",emoji:"ğŸ˜",desc:"ë³„ëª… ì§€ì–´ì£¼ê¸°! (1ì£¼ì¼ ì‚¬ìš©)"},
  {id:31,name:"ì²˜ìŒìœ¼ë¡œ",type:"move",emoji:"ğŸ”™",desc:"ì¶œë°œì ìœ¼ë¡œ!"}
];

const LIAR_TOPICS={'ìŒì‹':['í”¼ì','ì¹˜í‚¨','í–„ë²„ê±°','ì´ˆë°¥','ë¼ë©´','ë–¡ë³¶ì´','ì‚¼ê²¹ì‚´','ì§œì¥ë©´','ë¹„ë¹”ë°¥','ê¹€ì¹˜ì°Œê°œ'],'ë™ë¬¼':['ê°•ì•„ì§€','ê³ ì–‘ì´','ì‚¬ì','í˜¸ë‘ì´','ì½”ë¼ë¦¬','í­ê·„','í† ë¼','ì›ìˆ­ì´','ê¸°ë¦°','íŒë‹¤'],'ì§ì—…':['ì˜ì‚¬','ì„ ìƒë‹˜','ê²½ì°°ê´€','ìš”ë¦¬ì‚¬','ê°€ìˆ˜','ë°°ìš°','í”„ë¡œê·¸ë˜ë¨¸','ì†Œë°©ê´€','ë³€í˜¸ì‚¬','ê°„í˜¸ì‚¬'],'ì¥ì†Œ':['í•™êµ','ë³‘ì›','ê³µì›','ì˜í™”ê´€','ë„ì„œê´€','ì¹´í˜','í•´ë³€','ë†€ì´ê³µì›','ë§ˆíŠ¸','ê³µí•­'],'ìŠ¤í¬ì¸ ':['ì¶•êµ¬','ì•¼êµ¬','ë†êµ¬','í…Œë‹ˆìŠ¤','ìˆ˜ì˜','ê³¨í”„','ìŠ¤í‚¤','ë°°ë“œë¯¼í„´','íƒêµ¬','ë³¼ë§']};
const DRAW_WORDS={'ì‰¬ì›€':['ì‚¬ê³¼','ë°”ë‚˜ë‚˜','ì§‘','ìë™ì°¨','íƒœì–‘','ë‹¬','ë³„','ë‚˜ë¬´','ê½ƒ','ê³ ì–‘ì´','ê°•ì•„ì§€','ì±…','ì»µ','ì˜ì','ì‹œê³„'],'ë³´í†µ':['í”¼ì•„ë…¸','í—¬ë¦¬ì½¥í„°','ì†Œë°©ì°¨','í”¼ì','í–„ë²„ê±°','ì„ í’ê¸°','ëƒ‰ì¥ê³ ','ì»´í“¨í„°','ìš°ì‚°','ê¸°íƒ€','ì¹´ë©”ë¼','í…”ë ˆë¹„ì „'],'ì–´ë ¤ì›€':['ììœ ì˜ ì—¬ì‹ ìƒ','ì—í íƒ‘','ë¡¤ëŸ¬ì½”ìŠ¤í„°','ì ìˆ˜í•¨','ìš°ì£¼ë¹„í–‰ì‚¬','í”¼ë¼ë¯¸ë“œ','ë¬´ì§€ê°œ','ê³µë£¡','ë¡œë´‡','ìš©']};
const DRAW_COLORS=['#000000','#FFFFFF','#808080','#C0C0C0','#800000','#FF0000','#FF6B6B','#FFA500','#FFD700','#FFFF00','#808000','#00FF00','#008000','#00FFFF','#008080','#0000FF','#000080','#4169E1','#800080','#FF00FF','#FF69B4','#A52A2A','#D2691E','#F5DEB3','#8B4513','#2F4F4F'];
const RANDOM_GAMES=["í›ˆë¯¼ì •ìŒ!","ë”¸ê¸°ê²Œì„!","ì´ˆì„±í€´ì¦ˆ!","ì—…ë‹¤ìš´!","ì§„ì‹¤orê±°ì§“!","ë°•ìˆ˜ì¹˜ê¸°!","ëˆˆì¹˜ê²Œì„!","ì•„íŒŒíŠ¸!"];
const PLAYER_COLORS=['#EAB308','#3B82F6','#22C55E','#EF4444','#A855F7','#F97316','#06B6D4','#EC4899','#84CC16','#F43F5E','#8B5CF6','#14B8A6'];
const ROULETTE_COLORS=['#c53030','#c05621','#b7791f','#276749','#0d9488','#2b6cb0','#6b46c1','#b83280','#c53030','#5a7a23','#0891b2','#7c3aed'];

let state={screen:'home',game:null,roomCode:null,odPlyerId:null,playerName:'',room:null,localDice:1,showLeave:false,showUpdate:false,showAegyo:false,showChat:false,showAdmin:false,showMaintForm:false,showManage:false,showSwapSelect:false,showBomb:false,rouletteSlots:['í•­ëª©1','í•­ëª©2','í•­ëª©3','í•­ëª©4','í•­ëª©5','í•­ëª©6'],rouletteAngle:0,rouletteSpinning:false,rouletteResult:null,rouletteResultColor:null,liarFlipped:false,liarVote:null,liarGuess:'',chatMsg:'',hasIslandSkip:false,hasJoker:false,arrowAngle:0,arrowSpinning:false,maintType:'',maintenance:null,drawColor:'#000000',drawSize:5,isDrawing:false,drawGuess:'',isEraser:false,bombCountdown:10,bombActive:false,macroTracker:{},kickedByMacro:false,lastReadChatCount:0,liarDiscussTime:5,liarCount:1,drawTimeLeft:300,drawTimerActive:false,showDrawResult:false};
let roomRef=null,maintRef=null,canvasCtx=null,bombInterval=null;

function getValidSlots(){return state.rouletteSlots.filter(s=>s&&s.trim().length>0)}
function genCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}
function getTilePos(idx){const s=8;if(idx<s)return{x:s-idx,y:0};if(idx<s*2)return{x:0,y:idx-s};if(idx<s*3)return{x:idx-s*2,y:s};return{x:s,y:s*4-idx}}
function getOffset(i){const o=[[-10,-10],[10,-10],[-10,10],[10,10],[0,-14],[0,14],[-14,0],[14,0]];return o[i%8]}
function diceDots(v){const d={1:[[50,50]],2:[[30,30],[70,70]],3:[[30,30],[50,50],[70,70]],4:[[30,30],[70,30],[30,70],[70,70]],5:[[30,30],[70,30],[50,50],[30,70],[70,70]],6:[[30,25],[70,25],[30,50],[70,50],[30,75],[70,75]]};return(d[v]||d[1]).map(([x,y])=>'<circle cx="'+x+'" cy="'+y+'" r="8" fill="#1a1a2e"/>').join('')}

function checkMaintenance(){
  if(!isFirebaseReady)return;
  maintRef=db.ref('maintenance');
  maintRef.on('value',snap=>{
    const val=snap.val();
    state.maintenance=val&&val.active?val:null;
    render();
  });
}

function render(){
  if(state.maintenance&&!state.showMaintForm&&!state.showAdmin){
    document.getElementById('app').innerHTML=renderMaintenanceScreen();
    bindEvents();
    return;
  }
  let html='';
  if(state.screen==='home')html=renderHome();
  else if(state.screen==='lobby')html=renderLobby();
  else if(state.screen==='roulette')html=renderRoulette();
  else if(state.screen==='game')html=renderGame();
  document.getElementById('app').innerHTML=html;
  bindEvents();
}

function renderMaintenanceScreen(){
  const m=state.maintenance;
  const typeText=m.type==='maintenance'?'ì ê²€':m.type==='banned'?'ì‚¬ìš©ê¸ˆì§€':'ê°œë°œì¤‘';
  const emoji=m.type==='maintenance'?'ğŸ”§':m.type==='banned'?'ğŸš«':'ğŸ› ï¸';
  return '<div class="maintenance-screen"><div class="admin-btn" data-action="show-admin"></div><div class="text-center animate-fade-scale"><div class="text-8xl mb-6">'+emoji+'</div><h1 class="title-font text-5xl text-white mb-4 animate-neon">'+typeText+'</h1><div class="card-dark rounded-2xl p-6 max-w-lg mx-4"><p class="text-white/80 text-lg mb-4"><span class="text-yellow-400 font-bold">'+m.reason+'</span>(ìœ¼)ë¡œ ì¸í•´<br/><span class="text-red-400 font-bold">'+typeText+'</span> ì¤‘ì…ë‹ˆë‹¤.</p><div class="bg-black/30 rounded-xl p-4"><p class="text-white font-bold">'+m.dateFrom+' ~ '+m.dateTo+'</p><p class="text-cyan-400 font-bold text-lg">'+m.timeFrom+' ~ '+m.timeTo+'</p></div><p class="text-white/50 text-sm mt-4">ì ì‹œ í›„ ë‹¤ì‹œ ì ‘ì†í•´ì£¼ì„¸ìš”!</p></div></div></div>'+(state.showAdmin?renderAdminModal():'')+(state.showMaintForm?renderMaintFormModal():'');
}

function renderStars(){
  let stars='';
  for(let i=0;i<40;i++){
    const size=1+Math.random()*3;
    stars+='<div class="star animate-twinkle" style="left:'+Math.random()*100+'%;top:'+Math.random()*100+'%;width:'+size+'px;height:'+size+'px;animation-delay:'+Math.random()*3+'s;"></div>';
  }
  return stars;
}

function renderHome(){
  return '<div class="min-h-screen bg-party flex flex-col items-center justify-center p-4 relative overflow-hidden">'+renderStars()+'<div class="admin-btn" data-action="show-admin"></div><div class="absolute top-10 left-10 text-6xl opacity-30 animate-float">ğŸ®</div><div class="absolute bottom-20 right-10 text-5xl opacity-20 animate-float-reverse">ğŸ‰</div><div class="absolute top-1/4 right-20 text-4xl opacity-15 animate-float">âœ¨</div><div class="text-center mb-8 animate-fade-scale relative z-10"><h1 class="title-font text-5xl sm:text-6xl text-white mb-2 animate-neon" style="color:#a855f7">ğŸ® íŒŒí‹°ê²Œì„ ğŸ®</h1><p class="text-lg text-white/80">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì˜¨ë¼ì¸ íŒŒí‹°ê²Œì„!</p></div><div class="grid grid-cols-2 gap-4 max-w-md w-full relative z-10">'+GAMES.map((g,i)=>'<div data-action="select-game" data-game="'+g.id+'" class="game-card rounded-2xl p-4 cursor-pointer animate-slide-up" style="animation-delay:'+i*0.1+'s"><div class="text-4xl mb-2">'+g.emoji+'</div><h3 class="title-font text-lg text-white mb-1">'+g.name+'</h3><p class="text-white/60 text-xs mb-2">'+g.desc+'</p><span class="inline-block px-2 py-0.5 rounded-full text-xs font-bold bg-gradient-to-r '+g.color+' text-white">'+(g.solo?'ì†”ë¡œ':g.min+'-'+g.max+'ëª…')+'</span></div>').join('')+'</div><button data-action="show-update" class="fixed bottom-4 right-4 btn-ghost text-white/50 px-4 py-2 rounded-xl text-sm hover:bg-white/10">ğŸ“‹ ì—…ë°ì´íŠ¸</button>'+(state.showUpdate?renderUpdateModal():'')+(state.showAdmin?renderAdminModal():'')+(state.showMaintForm?renderMaintFormModal():'')+'</div>';
}

function renderUpdateModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" data-action="close-update"><div class="card-dark rounded-2xl p-6 max-w-lg w-full animate-bounce-in max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">ğŸ“‹ ì—…ë°ì´íŠ¸ ë‚´ì—­</h3><button data-action="close-update" class="text-white/50 text-2xl hover:text-white">&times;</button></div><div class="scroll-area space-y-4 overflow-y-auto" style="max-height:60vh">'+UPDATE_LOGS.map(l=>'<div class="border-l-4 border-purple-500 pl-4"><div class="flex items-center gap-2 mb-2"><span class="text-purple-400 font-bold">'+l.version+'</span><span class="text-white/50 text-sm">'+l.date+'</span></div><ul class="space-y-1">'+l.changes.map(c=>'<li class="text-white/80 text-sm">'+c+'</li>').join('')+'</ul></div>').join('')+'</div></div></div>';
}

function renderAdminModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" data-action="close-admin"><div class="card-dark rounded-2xl p-6 max-w-sm w-full animate-bounce-in" onclick="event.stopPropagation()"><h3 class="text-xl font-bold text-white mb-4 text-center">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h3><div class="space-y-3"><input type="text" id="admin-id" placeholder="ì•„ì´ë””" class="input-dark w-full px-4 py-3 rounded-xl"><input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="input-dark w-full px-4 py-3 rounded-xl"><button data-action="admin-login" class="btn-primary w-full text-white font-bold py-3 rounded-xl">ë¡œê·¸ì¸</button></div></div></div>';
}

function renderMaintFormModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" data-action="close-maint-form"><div class="card-dark rounded-2xl p-6 max-w-md w-full animate-bounce-in" onclick="event.stopPropagation()"><h3 class="text-xl font-bold text-white mb-4 text-center">ğŸ› ï¸ ì ê²€ ì„¤ì •</h3><div class="flex gap-2 mb-4"><button data-action="set-maint-type" data-type="maintenance" class="flex-1 py-2 rounded-xl font-bold '+(state.maintType==='maintenance'?'bg-yellow-500 text-black':'bg-black/30 text-white')+'">ğŸ”§ ì ê²€</button><button data-action="set-maint-type" data-type="banned" class="flex-1 py-2 rounded-xl font-bold '+(state.maintType==='banned'?'bg-red-500 text-white':'bg-black/30 text-white')+'">ğŸš« ê¸ˆì§€</button><button data-action="set-maint-type" data-type="dev" class="flex-1 py-2 rounded-xl font-bold '+(state.maintType==='dev'?'bg-blue-500 text-white':'bg-black/30 text-white')+'">ğŸ› ï¸ ê°œë°œ</button></div><div class="space-y-3"><input type="text" id="maint-reason" placeholder="ì‚¬ìœ  (ì˜ˆ: ì„œë²„ ì ê²€)" class="input-dark w-full px-4 py-2 rounded-xl"><div class="flex gap-2"><input type="text" id="maint-date-from" placeholder="ì‹œì‘ì¼ (12/11)" class="input-dark flex-1 px-3 py-2 rounded-xl"><input type="text" id="maint-date-to" placeholder="ì¢…ë£Œì¼ (12/11)" class="input-dark flex-1 px-3 py-2 rounded-xl"></div><div class="flex gap-2"><input type="text" id="maint-time-from" placeholder="ì‹œì‘ (14:00)" class="input-dark flex-1 px-3 py-2 rounded-xl"><input type="text" id="maint-time-to" placeholder="ì¢…ë£Œ (16:00)" class="input-dark flex-1 px-3 py-2 rounded-xl"></div><div class="flex gap-2"><button data-action="apply-maint" class="flex-1 btn-danger text-white font-bold py-3 rounded-xl">ğŸš¨ ì ìš©</button><button data-action="clear-maint" class="flex-1 btn-secondary text-white font-bold py-3 rounded-xl">âœ… í•´ì œ</button></div></div></div></div>';
}

function renderAegyoModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" data-action="close-aegyo"><div class="card-wood rounded-2xl p-6 max-w-xl w-full animate-bounce-in" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-2"><h3 class="text-xl font-bold text-amber-100">ğŸ’• ì• êµëŒ€ì‚¬ ëª¨ìŒì§‘</h3><button data-action="close-aegyo" class="text-amber-200/50 text-2xl hover:text-amber-100">&times;</button></div><p class="text-amber-300/80 text-xs mb-3 bg-black/20 rounded-lg p-2">â€» ë‹¹ì‚¬ì ì„±ë³„ì— ë”°ë¼ í˜¸ì¹­ì„ ë³€ê²½í•˜ì…”ì•¼ ë©ë‹ˆë‹¤.</p><div class="scroll-area space-y-2">'+AEGYO_LIST.map(a=>'<div class="bg-black/30 rounded-xl p-3"><div class="flex items-center gap-2 mb-1"><span class="text-amber-400 font-bold text-sm">'+a.id+'ë²ˆ</span><span class="text-yellow-300 text-xs">'+a.level+'</span></div><p class="text-amber-100 text-sm">'+a.text+'</p></div>').join('')+'</div></div></div>';
}

function renderChatToggle(){
  const chatCount=state.room?.chats?Object.keys(state.room.chats).length:0;
  const unreadCount=state.showChat?0:Math.max(0,chatCount-state.lastReadChatCount);
  return '<button data-action="toggle-chat" class="chat-toggle w-14 h-14 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white text-2xl flex items-center justify-center shadow-lg hover:scale-110 transition-transform relative">'+(state.showChat?'âœ•':'ğŸ’¬')+(unreadCount>0?'<span class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 rounded-full text-white text-xs font-bold flex items-center justify-center animate-bounce">'+unreadCount+'</span>':'')+'</button>';
}

function renderChatPanel(theme){
  const chats=state.room?.chats?Object.values(state.room.chats).sort((a,b)=>a.time-b.time):[];
  const players=state.room?.players||{};
  const cardClass=theme==='liar'?'card-liar':theme==='truth'?'card-truth':theme==='draw'?'card-draw':'card-wood';
  const inputClass=theme==='liar'?'input-liar':theme==='truth'?'input-truth':theme==='draw'?'input-draw':'input-beer';
  return '<div class="chat-panel '+(state.showChat?'':'hidden')+'"><div class="'+cardClass+' rounded-2xl p-4 h-full flex flex-col"><div class="text-white/80 font-bold text-sm mb-2">ğŸ’¬ ì±„íŒ…</div><div id="chat-box" class="flex-1 overflow-y-auto space-y-2 mb-2 min-h-[200px] max-h-[250px]">'+chats.map(c=>{const p=Object.values(players).find(x=>x.id===c.pid);const pIdx=Object.values(players).sort((a,b)=>a.order-b.order).findIndex(x=>x.id===c.pid);return'<div class="text-sm"><span class="font-bold" style="color:'+PLAYER_COLORS[pIdx>=0?pIdx:0]+'">'+(p?.name||'?')+'</span><span class="text-white/80 ml-1">'+c.msg+'</span></div>'}).join('')+'</div><div class="flex gap-2"><input type="text" id="chat-input" maxlength="100" placeholder="ë©”ì‹œì§€..." class="'+inputClass+' flex-1 px-3 py-2 rounded-lg text-sm"><button data-action="send-chat" class="bg-white/20 text-white px-3 py-2 rounded-lg text-sm hover:bg-white/30">ì „ì†¡</button></div></div></div>';
}

function renderLobby(){
  const g=state.game;
  if(!g)return'';
  const bgClass=g.bg||'bg-party';
  const btnClass=g.id==='jurumarble'?'btn-beer':g.id==='liar'?'btn-liar':g.id==='truth'?'btn-truth':g.id==='draw'?'btn-draw':'btn-primary';
  const inputClass=g.id==='jurumarble'?'input-beer':g.id==='liar'?'input-liar':g.id==='truth'?'input-truth':g.id==='draw'?'input-draw':'input-dark';
  const cardClass=g.id==='jurumarble'?'card-wood':g.id==='liar'?'card-liar':g.id==='truth'?'card-truth':g.id==='draw'?'card-draw':'card-glass';
  
  if(!state.room){
    return '<div class="min-h-screen '+bgClass+' flex items-center justify-center p-4 relative overflow-hidden">'+renderStars()+'<div class="absolute top-10 right-10 text-5xl opacity-30 animate-float">'+g.emoji+'</div><div class="absolute bottom-10 left-10 text-4xl opacity-20 animate-float-reverse">âœ¨</div><div class="'+cardClass+' rounded-3xl p-8 w-full max-w-md animate-fade-scale relative z-10"><button data-action="go-home" class="btn-ghost text-white/70 px-3 py-1 rounded-lg mb-4 hover:bg-white/10">â† ë’¤ë¡œ</button><div class="text-center mb-6"><span class="text-6xl mb-2 block animate-float">'+g.emoji+'</span><h2 class="title-font text-3xl text-white mt-2">'+g.name+'</h2><p class="text-white/50 text-sm mt-1">'+g.desc+'</p></div><div class="mb-4"><label class="block text-white/70 text-sm mb-2">ë‹‰ë„¤ì„ (ìµœëŒ€ 10ì)</label><input type="text" id="pname" maxlength="10" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" class="'+inputClass+' w-full px-4 py-3 rounded-xl text-lg"></div><div class="mb-6"><label class="block text-white/70 text-sm mb-2">ë°© ì½”ë“œ (ì°¸ê°€ì‹œ)</label><input type="text" id="rcode" maxlength="6" placeholder="ì—†ìœ¼ë©´ ìƒˆ ë°© ìƒì„±" class="'+inputClass+' w-full px-4 py-3 rounded-xl text-center tracking-widest uppercase"></div><button data-action="join-or-create" class="'+btnClass+' w-full text-white text-xl font-bold py-4 rounded-2xl hover:scale-105 transition-transform">ğŸ® ì…ì¥í•˜ê¸°</button></div></div>';
  }
  
  const players=Object.values(state.room.players||{}).sort((a,b)=>a.order-b.order);
  const isHost=state.room.hostId===state.odPlyerId;
  const canStart=players.length>=g.min;
  const discussTime=state.room.discussTime||5;
  const liarCount=state.room.liarCount||1;
  const maxLiars=Math.max(1,Math.floor(players.length/2)-1);
  
  let settingsHtml='';
  if(g.id==='liar'&&isHost){
    settingsHtml='<div class="bg-black/20 rounded-2xl p-4 mb-4 border border-white/10"><p class="text-white/70 text-sm mb-3">âš™ï¸ ê²Œì„ ì„¤ì •</p><div class="flex gap-2 mb-3"><span class="text-white/50 text-xs w-20">íšŒì˜ì‹œê°„</span><button data-action="set-discuss-time" data-time="5" class="flex-1 py-1 rounded-lg text-sm '+(discussTime===5?'bg-red-500 text-white':'bg-black/30 text-white/70')+'">5ë¶„</button><button data-action="set-discuss-time" data-time="10" class="flex-1 py-1 rounded-lg text-sm '+(discussTime===10?'bg-red-500 text-white':'bg-black/30 text-white/70')+'">10ë¶„</button><button data-action="set-discuss-time" data-time="15" class="flex-1 py-1 rounded-lg text-sm '+(discussTime===15?'bg-red-500 text-white':'bg-black/30 text-white/70')+'">15ë¶„</button></div><div class="flex gap-2 items-center"><span class="text-white/50 text-xs w-20">ë¼ì´ì–´ ìˆ˜</span><button data-action="set-liar-count" data-count="-1" class="w-8 h-8 rounded-lg bg-black/30 text-white">-</button><span class="flex-1 text-center text-white font-bold">'+liarCount+'ëª…</span><button data-action="set-liar-count" data-count="1" class="w-8 h-8 rounded-lg bg-black/30 text-white">+</button><span class="text-white/30 text-xs">(ìµœëŒ€ '+maxLiars+')</span></div></div>';
  }else if(g.id==='liar'&&!isHost){
    settingsHtml='<div class="bg-black/20 rounded-2xl p-3 mb-4 border border-white/10"><p class="text-white/50 text-sm">âš™ï¸ íšŒì˜ì‹œê°„: <span class="text-white font-bold">'+discussTime+'ë¶„</span> | ë¼ì´ì–´: <span class="text-white font-bold">'+liarCount+'ëª…</span></p></div>';
  }
  
  return '<div class="min-h-screen '+bgClass+' p-4 relative overflow-hidden">'+renderStars()+'<div class="absolute top-20 right-10 text-6xl opacity-20 animate-float">'+g.emoji+'</div><div class="absolute bottom-20 left-10 text-5xl opacity-15 animate-float-reverse">ğŸŠ</div><div class="max-w-2xl mx-auto relative z-10"><div class="'+cardClass+' rounded-3xl p-6 animate-fade-scale"><div class="flex justify-between items-center mb-4"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg hover:bg-red-500/20">ğŸšª ë‚˜ê°€ê¸°</button><div class="text-center flex-1"><span class="text-4xl">'+g.emoji+'</span><h2 class="title-font text-2xl text-white">'+g.name+'</h2></div><div class="w-20"></div></div><div class="bg-black/20 rounded-2xl p-4 mb-4 text-center border border-white/10"><p class="text-white/50 text-sm">ë°© ì½”ë“œ</p><p class="title-font text-4xl text-white tracking-wider">'+state.roomCode+'</p><button data-action="copy-code" class="mt-2 text-white/60 text-sm hover:text-white">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button></div>'+settingsHtml+'<div class="mb-4"><p class="text-white/70 text-sm mb-2">í”Œë ˆì´ì–´ ('+players.length+'/'+g.max+')</p><div class="grid grid-cols-2 gap-2">'+players.map((p,i)=>'<div class="player-item flex items-center gap-2 bg-black/30 rounded-xl p-2 border border-white/10 '+(p.id===state.odPlyerId?'ring-2 ring-white/50':'')+'"><div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background:'+PLAYER_COLORS[i]+';">'+p.name[0]+'</div><span class="flex-1 text-white text-sm truncate">'+p.name+'</span>'+(p.id===state.room.hostId?'<span class="text-yellow-400 text-xs">ğŸ‘‘</span>':'')+(isHost&&p.id!==state.odPlyerId?'<button data-action="kick" data-pid="'+p.id+'" class="text-red-400 text-xs px-2 py-1 rounded hover:bg-red-500/20">ì¶”ë°©</button>':'')+'</div>').join('')+'</div></div>'+(isHost?'<button data-action="start-game" '+(canStart?'':'disabled')+' class="'+btnClass+' w-full text-white text-xl font-bold py-4 rounded-2xl '+(canStart?'hover:scale-105 transition-transform':'opacity-50 cursor-not-allowed')+'">'+(canStart?'ğŸ® ê²Œì„ ì‹œì‘':'â³ '+g.min+'ëª… ì´ìƒ í•„ìš”')+'</button>':'<div class="text-center text-white/50 py-4"><div class="animate-pulse">í˜¸ìŠ¤íŠ¸ê°€ ê²Œì„ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...</div></div>')+'</div></div>'+(state.showLeave?renderLeaveModal():'')+'</div>';
}

function renderRoulette(){
  const validSlots=getValidSlots();
  const validCount=validSlots.length;
  const canSpin=!state.rouletteSpinning&&validCount>=2;
  const segAngle=validCount>0?360/validCount:360;
  
  return '<div class="min-h-screen bg-roulette p-4 relative overflow-hidden">'+renderStars()+'<div class="absolute top-20 left-10 text-6xl opacity-20 animate-float">ğŸ°</div><div class="absolute bottom-20 right-10 text-5xl opacity-15 animate-float-reverse">ğŸ’</div><div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-6"><button data-action="go-home" class="btn-ghost text-white/70 px-4 py-2 rounded-xl hover:bg-white/10">â† ë’¤ë¡œ</button><h1 class="title-font text-3xl text-purple-400 flex-1 text-center animate-neon" style="color:#a855f7">ğŸ¡ ë£°ë › ğŸ¡</h1><div class="w-16"></div></div><div class="flex flex-col lg:flex-row gap-6 items-center"><div class="relative flex flex-col items-center"><div class="absolute -top-3 left-1/2 -translate-x-1/2 z-20 text-4xl" style="filter:drop-shadow(0 0 10px gold)">â–¼</div><div class="relative w-72 h-72 lg:w-80 lg:h-80"><svg viewBox="0 0 200 200" class="roulette-wheel w-full h-full" id="roulette-wheel" style="transform:rotate('+state.rouletteAngle+'deg)"><circle cx="100" cy="100" r="98" fill="#1a1a2e" stroke="#6b21a8" stroke-width="4"/>'+(validCount>0?validSlots.map((s,i)=>{const st=i*segAngle-90,en=st+segAngle,la=segAngle>180?1:0;const x1=100+95*Math.cos(st*Math.PI/180),y1=100+95*Math.sin(st*Math.PI/180),x2=100+95*Math.cos(en*Math.PI/180),y2=100+95*Math.sin(en*Math.PI/180);const ma=(st+segAngle/2)*Math.PI/180,tx=100+60*Math.cos(ma),ty=100+60*Math.sin(ma);return'<path d="M100,100 L'+x1+','+y1+' A95,95 0 '+la+',1 '+x2+','+y2+' Z" fill="'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'" stroke="#1a1a2e" stroke-width="1"/><text x="'+tx+'" y="'+ty+'" fill="white" font-size="'+(validCount>8?8:10)+'" font-weight="bold" text-anchor="middle" transform="rotate('+(st+segAngle/2+90)+','+tx+','+ty+')">'+(s.length>6?s.slice(0,6)+'â€¦':s)+'</text>'}).join(''):'<text x="100" y="100" fill="white" font-size="12" text-anchor="middle">í•­ëª© ì…ë ¥</text>')+'<circle cx="100" cy="100" r="22" fill="#2d1b4e" stroke="#9333ea" stroke-width="3"/><circle cx="100" cy="100" r="10" fill="#a855f7"/></svg></div><div class="mt-4 w-full text-center min-h-[70px]">'+(state.rouletteResult?'<div class="animate-result-pop"><p class="text-purple-300 text-sm mb-1">ğŸ‰ ë‹¹ì²¨! ğŸ‰</p><p class="title-font text-2xl" style="color:'+state.rouletteResultColor+'">'+state.rouletteResult+'</p></div>':'<p class="text-white/30 text-sm">'+(state.rouletteSpinning?'ğŸŒ€ ëŒì•„ê°€ëŠ” ì¤‘...':'ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤')+'</p>')+'</div><button data-action="spin" '+(canSpin?'':'disabled')+' class="mt-2 w-full btn-purple text-white text-lg font-bold py-3 rounded-2xl '+(canSpin?'hover:scale-105 transition-transform':'opacity-50 cursor-not-allowed')+'">'+(state.rouletteSpinning?'ğŸŒ€ ëŒì•„ê°€ëŠ” ì¤‘...':'ğŸ¯ ëŒë¦¬ê¸°!')+'</button></div><div class="card-purple rounded-2xl p-4 flex-1 w-full max-w-md"><h3 class="text-purple-300 font-bold mb-3">ğŸ° í•­ëª© ì„¤ì • ('+validCount+'ê°œ)</h3><div class="space-y-2 max-h-56 overflow-y-auto mb-3">'+state.rouletteSlots.map((s,i)=>'<div class="flex gap-2 items-center"><div class="w-3 h-3 rounded" style="background:'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'"></div><input type="text" data-slot="'+i+'" value="'+s+'" placeholder="í•­ëª© '+(i+1)+'" class="input-dark flex-1 px-3 py-2 rounded-lg text-sm"><button data-action="remove-slot" data-idx="'+i+'" class="text-red-400 px-2 hover:text-red-300 '+(state.rouletteSlots.length<=2?'opacity-30 cursor-not-allowed':'')+'">âœ•</button></div>').join('')+'</div><button data-action="add-slot" class="w-full btn-secondary text-purple-300 py-2 rounded-xl hover:bg-white/10">+ í•­ëª© ì¶”ê°€</button></div></div></div></div>';
}

function renderGame(){
  if(!state.room)return'';
  if(state.game?.id==='liar')return renderLiarGame();
  if(state.game?.id==='truth')return renderTruthGame();
  if(state.game?.id==='draw')return renderDrawGame();
  return renderJurumarble();
}

function renderLeaveModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-dark rounded-2xl p-6 max-w-sm w-full animate-bounce-in text-center"><h3 class="text-xl font-bold text-white mb-4">ğŸšª ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</h3><p class="text-white/60 text-sm mb-6">'+(state.room?.hostId===state.odPlyerId?'í˜¸ìŠ¤íŠ¸ê°€ ë‚˜ê°€ë©´ ë°©ì´ ì‚­ì œë©ë‹ˆë‹¤.':'ê²Œì„ì—ì„œ ë‚˜ê°‘ë‹ˆë‹¤.')+'</p><div class="flex gap-3"><button data-action="cancel-leave" class="flex-1 btn-secondary text-white py-3 rounded-xl hover:bg-white/20">ì·¨ì†Œ</button><button data-action="leave-room" class="flex-1 btn-danger text-white py-3 rounded-xl">ë‚˜ê°€ê¸°</button></div></div></div>';
}

function renderManageModal(){
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" data-action="close-manage"><div class="card-dark rounded-2xl p-6 max-w-sm w-full animate-bounce-in" onclick="event.stopPropagation()"><h3 class="text-xl font-bold text-white mb-4 text-center">ğŸ‘‘ í”Œë ˆì´ì–´ ê´€ë¦¬</h3><div class="space-y-2 max-h-60 overflow-y-auto">'+players.map((p,i)=>'<div class="flex items-center gap-2 bg-black/30 rounded-xl p-2"><div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold" style="background:'+PLAYER_COLORS[i]+'">'+p.name[0]+'</div><span class="flex-1 text-white">'+p.name+'</span>'+(p.id===state.room.hostId?'<span class="text-yellow-400 text-xs">ğŸ‘‘í˜¸ìŠ¤íŠ¸</span>':'<button data-action="kick" data-pid="'+p.id+'" class="btn-danger text-white text-xs px-3 py-1 rounded">ì¶”ë°©</button>')+'</div>').join('')+'</div><button data-action="close-manage" class="mt-4 w-full btn-secondary text-white py-2 rounded-xl">ë‹«ê¸°</button></div></div>';
}

function renderTruthGame(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const isHost=room.hostId===state.odPlyerId;
  const playerCount=players.length;const tableRadius=120;const angleStep=360/playerCount;
  const targetPlayer=room.arrowTarget?players.find(p=>p.id===room.arrowTarget):null;
  let displayAngle=state.arrowAngle||0;
  const arrowSvg='<svg width="80" height="80" viewBox="0 0 80 80" class="'+(state.arrowSpinning?'arrow-spin':'')+'" style="--spin-deg:'+displayAngle+'deg;"><defs><linearGradient id="arrowGold" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#fde047"/><stop offset="50%" style="stop-color:#fbbf24"/><stop offset="100%" style="stop-color:#f59e0b"/></linearGradient><filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><polygon points="40,5 50,30 45,30 45,65 35,65 35,30 30,30" fill="url(#arrowGold)" stroke="#92400e" stroke-width="2" filter="url(#glow)"/><circle cx="40" cy="65" r="10" fill="#78350f" stroke="#451a03" stroke-width="2"/></svg>';
  
  return '<div class="min-h-screen bg-truth p-4 relative overflow-hidden">'+renderStars()+'<div class="absolute top-20 right-10 text-6xl opacity-15 animate-float">ğŸ¯</div><div class="absolute bottom-20 left-10 text-5xl opacity-10 animate-float-reverse">â­</div><div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-4"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg hover:bg-red-500/20">ğŸšª</button><h1 class="title-font text-3xl text-amber-400 flex-1 text-center">ğŸ¯ ì§€ëª©ê²Œì„ ğŸ¯</h1><div class="flex items-center gap-2"><span class="text-white/30 text-sm">'+state.roomCode+'</span>'+(isHost?'<button data-action="show-manage" class="text-yellow-400 text-sm hover:text-yellow-300">ğŸ‘‘ê´€ë¦¬</button>':'')+'</div></div><div class="flex flex-col items-center"><div class="relative" style="width:300px;height:300px;"><div class="absolute inset-0 rounded-full bg-gradient-to-br from-slate-800 via-slate-700 to-slate-900 border-8 border-amber-600/50 shadow-2xl" style="box-shadow:0 0 60px rgba(251,191,36,0.2),inset 0 0 30px rgba(0,0,0,0.5)"></div>'+players.map((p,i)=>{const angle=(angleStep*i-90)*Math.PI/180;const x=150+tableRadius*Math.cos(angle)-28;const y=150+tableRadius*Math.sin(angle)-28;const isTarget=room.arrowTarget===p.id;return'<div class="absolute flex flex-col items-center transition-all duration-500 '+(isTarget?'scale-125 z-20':'')+'" style="left:'+x+'px;top:'+y+'px;width:56px;"><div class="relative"><div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg player-token '+(isTarget?'ring-4 ring-amber-400 pulse-glow':'')+'" style="background:'+PLAYER_COLORS[i]+';">'+p.name[0]+'</div>'+(isTarget?'<div class="absolute -top-2 -right-2 text-2xl animate-bounce">ğŸ¯</div>':'')+'</div><span class="text-white text-xs mt-1 truncate w-full text-center '+(isTarget?'text-amber-300 font-bold':'')+'">'+p.name+'</span></div>'}).join('')+'<div class="absolute left-1/2 top-1/2" style="transform:translate(-50%,-50%);">'+arrowSvg+'</div></div><div class="mt-6 text-center min-h-[100px]">'+(room.arrowTarget&&targetPlayer?'<div class="animate-result-pop"><div class="text-6xl mb-2">ğŸ¯</div><p class="text-amber-300 text-lg mb-1">ê±¸ë¦° ì‚¬ëŒ!</p><p class="title-font text-4xl text-amber-400">'+targetPlayer.name+'</p></div>':(state.arrowSpinning?'<div class="text-4xl animate-spin mb-2">ğŸŒ€</div><p class="text-amber-300 text-lg">ëŒì•„ê°€ëŠ” ì¤‘...</p>':'<p class="text-white/40 text-lg">í™”ì‚´í‘œë¥¼ ëŒë ¤ì£¼ì„¸ìš”!</p>'))+'</div>'+(isHost?'<div class="flex gap-3 mt-4"><button data-action="spin-arrow" '+(state.arrowSpinning||room.arrowTarget?'disabled':'')+' class="btn-truth text-white text-xl font-bold py-4 px-10 rounded-2xl '+(state.arrowSpinning||room.arrowTarget?'opacity-50 cursor-not-allowed':'hover:scale-105 transition-transform')+'">ğŸ¯ ëŒë¦¬ê¸°!</button>'+(room.arrowTarget?'<button data-action="reset-arrow" class="btn-secondary text-amber-300 py-4 px-6 rounded-2xl hover:bg-white/10">ğŸ”„ ë‹¤ì‹œ</button>':'')+'</div>':'<p class="text-white/50 mt-4">í˜¸ìŠ¤íŠ¸ê°€ ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>')+'</div></div>'+renderChatToggle()+renderChatPanel('truth')+(state.showLeave?renderLeaveModal():'')+(state.showManage?renderManageModal():'')+'</div>';
}

function renderJurumarble(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const curr=players[room.turn%players.length];
  const isMyTurn=curr?.id===state.odPlyerId;
  const isHost=room.hostId===state.odPlyerId;
  const sz=70,gap=2,side=8,bsz=(side+1)*(sz+gap)+20;
  const finishedCount=players.filter(p=>p.finished).length;
  const gameEnded=finishedCount>=players.length-1;
  const myPlayer=players.find(p=>p.id===state.odPlyerId);
  const isTrappedOnIsland=myPlayer&&myPlayer.islandTurn>0;
  
  return '<div class="min-h-screen bg-beer p-2 overflow-auto relative">'+renderStars()+'<div class="absolute top-10 right-10 text-8xl opacity-10">ğŸº</div><div class="max-w-5xl mx-auto"><div class="flex justify-between items-center mb-2 flex-wrap gap-2"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg hover:bg-red-500/20">ğŸšª</button><h1 class="title-font text-xl sm:text-2xl text-amber-400">ğŸº ì£¼ë£¨ë§ˆë¸” ğŸº</h1><div class="flex items-center gap-2"><span class="text-amber-200/50 text-sm">'+state.roomCode+'</span>'+(isHost?'<button data-action="show-manage" class="text-yellow-400 text-sm hover:text-yellow-300">ğŸ‘‘ê´€ë¦¬</button>':'')+'</div></div><div class="card-wood rounded-2xl p-2 mb-3"><div class="flex flex-wrap gap-1 justify-center items-center mb-2">'+players.map((p,i)=>'<div class="flex items-center gap-1 px-2 py-1 rounded-lg '+(curr?.id===p.id?'bg-amber-500/30 ring-2 ring-amber-400':p.finished?'bg-green-500/20':'bg-black/20')+'"><div class="w-5 h-5 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><span class="text-white text-xs">'+p.name+(p.finished?' ğŸ†':'')+(p.islandTurn>0?' ğŸï¸':'')+'</span></div>').join('')+'</div><p class="text-amber-200 text-center text-sm">'+(gameEnded?'ğŸ† ê²Œì„ ì¢…ë£Œ!':curr?.finished?'ë‹¤ìŒ ì°¨ë¡€...':'ğŸ² '+curr?.name+'ë‹˜ ì°¨ë¡€')+'</p></div><div class="flex flex-col lg:flex-row gap-3"><div class="flex-1 overflow-x-auto"><div class="relative mx-auto" style="width:'+bsz+'px;height:'+bsz+'px;min-width:'+bsz+'px;">'+TILES.map(t=>{const pos=getTilePos(t.id);const l=pos.x*(sz+gap)+10,tp=pos.y*(sz+gap)+10;return'<div class="absolute rounded-lg tile-'+t.type+' flex flex-col items-center justify-center text-center p-1 border-2 border-black/30 shadow-lg" style="width:'+sz+'px;height:'+sz+'px;left:'+l+'px;top:'+tp+'px;"><span class="text-lg leading-none">'+t.emoji+'</span><span class="text-white text-[8px] font-bold leading-tight">'+t.name+'</span></div>'}).join('')+players.map((p,i)=>{if(p.finished)return'';const pos=getTilePos(p.position);const off=getOffset(i);const pl=pos.x*(sz+gap)+10+sz/2-12+off[0],pt=pos.y*(sz+gap)+10+sz/2-12+off[1];return'<div class="absolute w-6 h-6 rounded-full player-token flex items-center justify-center text-white text-xs font-bold transition-all duration-500 '+(curr?.id===p.id?'ring-2 ring-white':'')+'" style="left:'+pl+'px;top:'+pt+'px;background:'+PLAYER_COLORS[i]+';z-index:'+(10+i)+';">'+p.name[0]+'</div>'}).join('')+'</div></div><div class="lg:w-64 space-y-3"><div class="card-wood rounded-xl p-3"><div class="flex items-center justify-center gap-3 mb-3"><svg viewBox="0 0 100 100" class="w-16 h-16 '+(room.rolling?'animate-dice-roll':'')+'"><rect x="5" y="5" width="90" height="90" rx="15" fill="#FFF8E7" stroke="#8B5A14" stroke-width="3"/>'+diceDots(state.localDice)+'</svg></div><button data-action="roll-dice" '+(isMyTurn&&!room.rolling&&!curr?.finished?'':'disabled')+' class="btn-beer w-full text-white font-bold py-3 rounded-xl text-lg '+(isMyTurn&&!room.rolling&&!curr?.finished?'hover:scale-105 transition-transform':'opacity-50 cursor-not-allowed')+'">'+(room.rolling?'ğŸ² êµ´ë¦¬ëŠ” ì¤‘...':isTrappedOnIsland?'ğŸï¸ íƒˆì¶œ ë„ì „!':'ğŸ² ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°')+'</button></div>'+(state.hasIslandSkip||state.hasJoker?'<div class="card-wood rounded-xl p-3"><p class="text-amber-300 text-sm mb-1">ğŸ´ ë³´ìœ  ì¹´ë“œ</p>'+(state.hasIslandSkip?'<span class="inline-block bg-cyan-500/30 text-cyan-300 px-2 py-1 rounded text-xs mr-1">ğŸ‘» ë¬´ì¸ë„ ê¹Œë°©ê¶Œ</span>':'')+(state.hasJoker?'<span class="inline-block bg-purple-500/30 text-purple-300 px-2 py-1 rounded text-xs">ğŸƒ ì¡°ì»¤</span>':'')+'</div>':'')+'<button data-action="show-aegyo" class="btn-secondary w-full text-amber-300 py-2 rounded-xl text-sm hover:bg-white/10">ğŸ’• ì• êµëŒ€ì‚¬ ë³´ê¸°</button></div></div></div>'+renderChatToggle()+renderChatPanel('beer')+(room.showMission?renderMissionModal():'')+(room.rescueVoting?renderRescueModal():'')+(state.showLeave?renderLeaveModal():'')+(state.showAegyo?renderAegyoModal():'')+(state.showManage?renderManageModal():'')+(state.showSwapSelect?renderSwapSelectModal():'')+(state.showBomb?renderBombModal():'')+(gameEnded?renderGameEndModal(players):'')+'</div>';
}

function renderDrawGame(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const isHost=room.hostId===state.odPlyerId;
  const phase=room.drawPhase||'waiting';
  const drawerId=room.drawerId;
  const isDrawer=drawerId===state.odPlyerId;
  const drawer=players.find(p=>p.id===drawerId);
  const word=room.drawWord||'';
  const guesses=room.guesses||{};
  const scores=room.drawScores||{};
  const correctOrder=room.correctOrder||[];
  const endTime=room.drawEndTime||0;
  const remaining=Math.max(0,Math.floor((endTime-Date.now())/1000));
  const progress=(remaining/300)*100;
  const timeStr=Math.floor(remaining/60)+':'+(remaining%60<10?'0':'')+(remaining%60);
  const colorPalette=DRAW_COLORS.map(c=>'<button data-action="set-draw-color" data-color="'+c+'" class="color-btn '+(state.drawColor===c&&!state.isEraser?'active':'')+'" style="background:'+c+';'+(c==='#FFFFFF'?'border:1px solid #ccc;':'')+'"></button>').join('');
  const nonDrawerCount=players.filter(p=>p.id!==drawerId).length;
  const allGuessed=correctOrder.length>=nonDrawerCount;
  const roundEnded=room.drawRoundEnded||remaining<=0||allGuessed;
  const myGuess=guesses[state.odPlyerId];
  const alreadyCorrect=myGuess?.correct;
  const winner=checkDrawWinner();
  if(winner&&phase==='drawing'){
    return '<div class="min-h-screen bg-draw p-4 relative overflow-hidden flex items-center justify-center">'+renderStars()+'<div class="card-draw rounded-3xl p-8 max-w-lg w-full animate-bounce-in text-center"><div class="text-6xl mb-4">ğŸ†</div><h2 class="title-font text-3xl text-green-400 mb-4">ê²Œì„ ì¢…ë£Œ!</h2><p class="text-white text-xl mb-6"><span class="text-yellow-400 font-bold">'+winner.name+'</span>ë‹˜ì´ 100ì  ë‹¬ì„±!</p><div class="space-y-2 mb-6">'+players.sort((a,b)=>(scores[b.id]||0)-(scores[a.id]||0)).map((p,i)=>{const pIdx=players.findIndex(pl=>pl.id===p.id);return'<div class="flex items-center gap-3 bg-black/30 rounded-xl p-3"><span class="text-2xl">'+(i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'')+'</span><div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background:'+PLAYER_COLORS[pIdx]+'">'+p.name[0]+'</div><span class="flex-1 text-white font-bold">'+p.name+'</span><span class="text-green-400 font-bold text-xl">'+(scores[p.id]||0)+'ì </span></div>'}).join('')+'</div>'+(isHost?'<button data-action="back-to-lobby" class="btn-draw text-white text-lg font-bold py-3 px-8 rounded-2xl hover:scale-105 transition-transform">ğŸ  ëŒ€ê¸°ì‹¤ë¡œ</button>':'<p class="text-white/50">í˜¸ìŠ¤íŠ¸ê°€ ëŒ€ê¸°ì‹¤ë¡œ ì´ë™í•©ë‹ˆë‹¤</p>')+'</div></div>';
  }
  return '<div class="min-h-screen bg-draw p-4 relative overflow-hidden">'+renderStars()+'<div class="absolute top-20 right-10 text-6xl opacity-15 animate-float">ğŸ¨</div><div class="absolute bottom-20 left-10 text-5xl opacity-10 animate-float-reverse">ğŸ–Œï¸</div><div class="max-w-5xl mx-auto relative z-10"><div class="flex justify-between items-center mb-4"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg hover:bg-red-500/20">ğŸšª</button><h1 class="title-font text-3xl text-green-400 flex-1 text-center">ğŸ¨ ê·¸ë¦¼ ì œì‹œì–´ ğŸ¨</h1><div class="flex items-center gap-2"><span class="text-white/30 text-sm">'+state.roomCode+'</span>'+(isHost?'<button data-action="show-manage" class="text-yellow-400 text-sm hover:text-yellow-300">ğŸ‘‘ê´€ë¦¬</button>':'')+'</div></div><div class="flex flex-col lg:flex-row gap-4">'+(phase==='waiting'?'<div class="flex-1 card-draw rounded-2xl p-6 text-center"><div class="text-6xl mb-4 animate-float">ğŸ¨</div><p class="text-green-300 text-xl mb-4">ê·¸ë¦¼ ì œì‹œì–´ ê²Œì„</p><p class="text-white/70 mb-2">ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  ë§ì¶”ëŠ” ê²Œì„!</p><div class="bg-black/30 rounded-xl p-3 mb-4 text-left"><p class="text-green-300 text-sm mb-1">ğŸ† ì ìˆ˜ ê·œì¹™</p><p class="text-white/70 text-xs">1ë“±: 15ì  | 2ë“±: 10ì  | 3ë“±: 5ì </p><p class="text-white/70 text-xs">ë‚˜ë¨¸ì§€ ì •ë‹µ: 3ì  | ëª»ë§ì¶¤: -2ì </p><p class="text-yellow-400 text-xs mt-1">100ì  ë¨¼ì € ë‹¬ì„± ì‹œ ìŠ¹ë¦¬!</p></div>'+(isHost?'<button data-action="start-game" class="btn-draw text-white text-lg font-bold py-3 px-8 rounded-2xl hover:scale-105 transition-transform">ğŸ–Œï¸ ê²Œì„ ì‹œì‘</button>':'<p class="text-white/50">í˜¸ìŠ¤íŠ¸ê°€ ì‹œì‘í•©ë‹ˆë‹¤</p>')+'</div>':'<div class="flex-1"><div class="card-draw rounded-2xl p-4 mb-4"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-2">'+(isDrawer?'<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">ğŸ–Œï¸ ë‚´ ì°¨ë¡€!</span><span class="text-green-300">ì œì‹œì–´: <strong class="text-white text-lg">'+word+'</strong></span>':'<span class="text-green-300">ê·¸ë¦¬ëŠ” ì‚¬ëŒ: <strong class="text-white">'+(drawer?.name||'?')+'</strong></span>')+'</div><div class="flex items-center gap-2"><span class="text-2xl font-bold '+(remaining<=30?'text-red-500 animate-pulse':'text-white')+'">â±ï¸'+timeStr+'</span></div></div><div class="w-full h-2 bg-black/50 rounded-full overflow-hidden mb-3"><div class="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all duration-1000" style="width:'+progress+'%"></div></div>'+(roundEnded&&!isDrawer?'<div class="bg-yellow-500/20 rounded-xl p-3 mb-3 text-center"><p class="text-yellow-400 font-bold">ì •ë‹µ: '+word+'</p></div>':'')+'<div class="flex justify-center bg-white/5 rounded-xl p-2 relative"><canvas id="draw-canvas" width="400" height="300" class="draw-canvas"></canvas></div>'+(isDrawer?'<div class="mt-3 space-y-2"><div class="flex items-center gap-2 mb-2"><div class="w-8 h-8 rounded-full flex items-center justify-center" style="background:'+(state.isEraser?'white':state.drawColor)+';width:'+Math.min(state.drawSize,30)+'px;height:'+Math.min(state.drawSize,30)+'px;border:2px solid #888"></div><span class="text-white/70 text-sm">'+(state.isEraser?'ì§€ìš°ê°œ':'íœ')+' ë¯¸ë¦¬ë³´ê¸°</span></div><div class="color-palette">'+colorPalette+'</div><div class="flex items-center justify-center gap-4 mt-2"><button data-action="toggle-eraser" class="px-3 py-1 rounded-lg text-sm transition-all '+(state.isEraser?'bg-pink-500 text-white ring-2 ring-white':'bg-white/20 text-white hover:bg-white/30')+'">ğŸ§½ ì§€ìš°ê°œ</button><div class="flex items-center gap-2"><label class="text-white/70 text-sm">êµµê¸°: '+state.drawSize+'px</label><input type="range" id="draw-size" min="2" max="30" value="'+state.drawSize+'" class="w-24"></div><button data-action="clear-canvas" class="btn-secondary text-white px-4 py-1 rounded-lg text-sm hover:bg-white/20">ğŸ—‘ï¸ ì „ì²´ ì§€ìš°ê¸°</button></div></div>':'<div class="flex gap-2 mt-3"><input type="text" id="draw-guess" placeholder="'+(alreadyCorrect?'âœ“ ì •ë‹µ!':'ì •ë‹µ ì…ë ¥...')+'" class="input-draw flex-1 px-4 py-2 rounded-xl" '+(roundEnded||alreadyCorrect?'disabled':'')+'><button data-action="submit-guess" class="btn-draw px-6 py-2 rounded-xl text-white font-bold '+(roundEnded||alreadyCorrect?'opacity-50 cursor-not-allowed':'hover:scale-105 transition-transform')+'" '+(roundEnded||alreadyCorrect?'disabled':'')+'>ì œì¶œ</button></div>')+'</div></div>')+'<div class="lg:w-64"><div class="card-draw rounded-2xl p-4"><h3 class="text-green-300 font-bold mb-3">ğŸ“Š ì ìˆ˜íŒ (100ì  ëª©í‘œ)</h3><div class="space-y-2">'+players.sort((a,b)=>(scores[b.id]||0)-(scores[a.id]||0)).map((p,i)=>{const pIdx=players.findIndex(pl=>pl.id===p.id);const rank=correctOrder.indexOf(p.id);const rankEmoji=rank===0?'ğŸ¥‡':rank===1?'ğŸ¥ˆ':rank===2?'ğŸ¥‰':rank>=0?'âœ“':'';return'<div class="flex items-center gap-2 p-1 rounded-lg '+(p.id===drawerId?'bg-green-500/20':'')+'"><div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" style="background:'+PLAYER_COLORS[pIdx]+'">'+p.name[0]+'</div><span class="flex-1 text-white text-sm truncate">'+p.name+'</span><span class="text-green-400 font-bold">'+(scores[p.id]||0)+'</span>'+(p.id===drawerId?'<span class="text-xs">ğŸ–Œï¸</span>':'<span class="text-xs">'+rankEmoji+'</span>')+'</div>'}).join('')+'</div>'+(isHost&&roundEnded&&phase==='drawing'?'<button data-action="end-draw-round" class="mt-4 w-full btn-draw text-white py-2 rounded-xl hover:scale-105 transition-transform animate-pulse">â­ï¸ ë‹¤ìŒ ë¼ìš´ë“œ</button>':'')+'</div></div></div></div>'+renderChatToggle()+renderChatPanel('draw')+(state.showLeave?renderLeaveModal():'')+(state.showManage?renderManageModal():'')+'</div>';
}

function renderSwapSelectModal(){
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-golden rounded-2xl p-6 max-w-sm w-full animate-bounce-in text-center"><div class="text-5xl mb-3">ğŸ”„</div><h3 class="title-font text-2xl text-amber-900 mb-2">ì—­í•  êµì²´!</h3><p class="text-amber-800 mb-4">ìœ„ì¹˜ë¥¼ ë°”ê¿€ ì‚¬ëŒì„ ì„ íƒí•˜ì„¸ìš”</p><div class="space-y-2 max-h-60 overflow-y-auto">'+players.filter(p=>p.id!==state.odPlyerId&&!p.finished).map((p)=>{const pIdx=players.findIndex(pl=>pl.id===p.id);return'<button data-action="swap-with" data-pid="'+p.id+'" class="w-full flex items-center gap-3 bg-amber-100/50 hover:bg-amber-200/50 rounded-xl p-3 transition-colors"><div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background:'+PLAYER_COLORS[pIdx]+'">'+p.name[0]+'</div><span class="text-amber-900 font-bold">'+p.name+'</span><span class="text-amber-700 text-sm ml-auto">'+p.position+'ì¹¸</span></button>'}).join('')+'</div><button data-action="close-swap" class="mt-4 bg-amber-700 text-white font-bold py-2 px-6 rounded-xl hover:bg-amber-800">ì·¨ì†Œ</button></div></div>';
}

function renderBombModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-golden rounded-2xl p-6 max-w-sm w-full animate-bounce-in text-center '+(state.bombCountdown<=3&&state.bombCountdown>0?'animate-bomb-shake':'')+'"><div class="text-6xl mb-3">'+(state.bombCountdown<=0?'ğŸ’¥':'ğŸ’£')+'</div><h3 class="title-font text-2xl text-amber-900 mb-2">'+(state.bombCountdown<=0?'í‘!':'í­íƒ„ ëŒë¦¬ê¸°!')+'</h3>'+(state.bombCountdown>0?'<p class="text-amber-800 mb-4">ì›í•˜ëŠ” ì‚¬ëŒ ì´ë¦„ ë¶€ë¥´ë©´ì„œ<br/>10ì´ˆ ì•ˆì— ê³„ì† ëŒë¦¬ì„¸ìš”!</p><div class="text-6xl font-black text-red-600 animate-countdown mb-4" style="text-shadow:0 0 20px rgba(220,38,38,0.5)">'+state.bombCountdown+'</div>':'<p class="text-amber-800 text-lg mb-2">ğŸ’¥ í­ë°œ! ğŸ’¥</p><p class="text-red-600 font-bold text-xl">ê±¸ë¦¬ì‹  ë¶„ì€ ìˆ  í•œì”! ğŸº</p>')+(state.bombCountdown<=0?'<button data-action="close-bomb" class="mt-4 bg-amber-700 text-white font-bold py-3 px-8 rounded-xl hover:bg-amber-800">í™•ì¸</button>':'')+'</div></div>';
}

function renderGameEndModal(players){
  const finished=players.filter(p=>p.finished).sort((a,b)=>a.finishOrder-b.finishOrder);
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-golden rounded-3xl p-6 max-w-md w-full animate-bounce-in text-center"><div class="text-6xl mb-4">ğŸ†</div><h3 class="title-font text-3xl text-amber-900 mb-4">ê²Œì„ ì¢…ë£Œ!</h3><div class="space-y-2 mb-6">'+finished.map((p,i)=>{const pIdx=players.findIndex(pl=>pl.id===p.id);return'<div class="flex items-center gap-3 bg-amber-100/50 rounded-xl p-2"><span class="text-2xl">'+(i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'ğŸ–ï¸')+'</span><div class="w-8 h-8 rounded-full" style="background:'+PLAYER_COLORS[pIdx]+'"></div><span class="font-bold text-amber-900">'+p.name+'</span></div>'}).join('')+'</div><button data-action="go-home" class="bg-amber-700 text-white font-bold py-3 px-8 rounded-xl hover:bg-amber-800">í™ˆìœ¼ë¡œ</button></div></div>';
}

function renderRescueModal(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const targetPlayer=players.find(p=>p.id===room.rescueTarget);
  const votes=room.rescueVotes||{};
  const voteCount=Object.keys(votes).length;
  const eligibleVoters=players.filter(p=>p.id!==room.rescueTarget&&!p.finished).length;
  const yesVotes=Object.values(votes).filter(v=>v===true).length;
  const noVotes=Object.values(votes).filter(v=>v===false).length;
  const myVote=votes[state.odPlyerId];
  const canVote=state.odPlyerId!==room.rescueTarget&&!players.find(p=>p.id===state.odPlyerId)?.finished;
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-wood rounded-3xl p-6 max-w-md w-full animate-bounce-in text-center"><div class="text-5xl mb-3">ğŸ†˜</div><h3 class="title-font text-2xl text-amber-100 mb-2">êµ¬ì› íˆ¬í‘œ</h3><p class="text-amber-200 mb-4"><strong class="text-amber-400">'+(targetPlayer?.name||'?')+'</strong>ë‹˜ì„<br/>ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ëŠ” ê²ƒì—ì„œ<br/>êµ¬ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p><p class="text-amber-300/70 text-sm mb-4">íˆ¬í‘œ: '+voteCount+'/'+eligibleVoters+'</p><div class="flex justify-center gap-8 mb-4"><div class="text-center"><div class="text-3xl font-bold text-green-400">'+yesVotes+'</div><div class="text-green-300 text-sm">ì°¬ì„±</div></div><div class="text-center"><div class="text-3xl font-bold text-red-400">'+noVotes+'</div><div class="text-red-300 text-sm">ë°˜ëŒ€</div></div></div>'+(canVote&&myVote===undefined?'<div class="flex gap-3"><button data-action="rescue-vote" data-vote="yes" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-500">âœ… êµ¬ì›</button><button data-action="rescue-vote" data-vote="no" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-500">âŒ ê¸°ê°</button></div>':'<p class="text-amber-300/70">'+(myVote!==undefined?'íˆ¬í‘œ ì™„ë£Œ!':'íˆ¬í‘œ ìê²© ì—†ìŒ')+'</p>')+'</div></div>';
}

function renderMissionModal(){
  const room=state.room,tile=TILES.find(t=>t.id===room.currentTileId);
  if(!tile)return'';
  const players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const curr=players[room.turn%players.length];
  const isMyTurn=curr?.id===state.odPlyerId;
  
  if(room.goldenKey){
    const gk=GOLDEN_KEYS.find(k=>k.type===room.goldenKey);
    let extraContent='';
    if(room.goldenKey==='lucky-box'&&isMyTurn)extraContent='<button data-action="reroll-golden-key" class="bg-amber-700 text-white font-bold py-2 px-6 rounded-xl mr-2 hover:bg-amber-600">ğŸ ë‹¤ì‹œ ë½‘ê¸°</button>';
    if(room.goldenKey==='swap-select'&&isMyTurn)extraContent='<button data-action="show-swap-select" class="bg-amber-700 text-white font-bold py-2 px-6 rounded-xl mr-2 hover:bg-amber-600">ğŸ”„ ì„ íƒí•˜ê¸°</button>';
    if(room.goldenKey==='bomb'&&isMyTurn&&!state.bombActive)extraContent='<button data-action="start-bomb" class="bg-red-600 text-white font-bold py-2 px-6 rounded-xl mr-2 hover:bg-red-500">ğŸ’£ ì‹œì‘!</button>';
    return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-golden rounded-3xl p-6 max-w-sm w-full animate-bounce-in animate-golden-glow text-center"><div class="text-6xl mb-4">'+(gk?.emoji||'ğŸ”‘')+'</div><h3 class="title-font text-2xl text-amber-900 mb-2">ğŸ”‘ í™©ê¸ˆì—´ì‡ ! ğŸ”‘</h3><p class="text-amber-800 text-lg mb-4 font-bold">'+(gk?.text||'íŠ¹ë³„!')+'</p>'+extraContent+(isMyTurn&&room.goldenKey!=='bomb'?'<button data-action="close-mission" class="bg-amber-700 text-white font-bold py-3 px-8 rounded-xl hover:bg-amber-800">í™•ì¸</button>':'')+(room.goldenKey!=='bomb'&&!isMyTurn?'<div class="text-amber-800/70 py-3">'+curr?.name+' í™•ì¸ ì¤‘...</div>':'')+'</div></div>';
  }
  
  if(tile.type==='island'&&!state.hasIslandSkip){
    return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="bg-gradient-to-b from-cyan-600 to-blue-800 rounded-3xl p-6 max-w-sm w-full animate-bounce-in text-center border-4 border-cyan-400" style="box-shadow:0 0 40px rgba(6,182,212,0.4)"><div class="text-6xl mb-4">ğŸï¸</div><h3 class="title-font text-2xl text-white mb-2">ë¬´ì¸ë„ì— ê°‡í˜”ìŠµë‹ˆë‹¤!</h3><div class="bg-black/30 rounded-xl p-4 mb-4"><p class="text-cyan-100 text-lg mb-2">ğŸ² íƒˆì¶œ ì¡°ê±´</p><p class="text-white font-bold text-xl">ì£¼ì‚¬ìœ„ 1 ë˜ëŠ” 2ê°€ ë‚˜ì™€ì•¼<br/>íƒˆì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p></div><p class="text-cyan-200 text-sm mb-4">ë‹¤ìŒ í„´ì— ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¤ì£¼ì„¸ìš”</p>'+(isMyTurn?'<button data-action="close-mission" class="bg-cyan-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-cyan-400">í™•ì¸</button>':'<div class="text-cyan-200/70 py-3">'+curr?.name+' í™•ì¸ ì¤‘...</div>')+'</div></div>';
  }
  
  if(tile.type==='toIsland'&&!state.hasIslandSkip){
    return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="bg-gradient-to-b from-orange-600 to-red-800 rounded-3xl p-6 max-w-sm w-full animate-bounce-in text-center border-4 border-orange-400" style="box-shadow:0 0 40px rgba(249,115,22,0.4)"><div class="text-6xl mb-4">ğŸš¢</div><h3 class="title-font text-2xl text-white mb-2">ë¬´ì¸ë„ ì§í–‰!</h3><div class="bg-black/30 rounded-xl p-4 mb-4"><p class="text-orange-100 text-lg mb-2">ğŸï¸ ë¬´ì¸ë„ë¡œ ì´ë™í•©ë‹ˆë‹¤!</p><p class="text-white font-bold">ì£¼ì‚¬ìœ„ 1 ë˜ëŠ” 2ê°€ ë‚˜ì™€ì•¼<br/>íƒˆì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p></div>'+(isMyTurn?'<button data-action="close-mission" class="bg-orange-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-orange-400">í™•ì¸</button>':'<div class="text-orange-200/70 py-3">'+curr?.name+' í™•ì¸ ì¤‘...</div>')+'</div></div>';
  }
  
  const randomGame=tile.type==='game'&&tile.id===28?RANDOM_GAMES[Math.floor(Math.random()*RANDOM_GAMES.length)]:'';
  const aegyo=tile.id===2?AEGYO_LIST[Math.floor(Math.random()*AEGYO_LIST.length)]:null;
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-wood rounded-3xl p-6 max-w-sm w-full animate-bounce-in text-center"><div class="text-5xl mb-4">'+tile.emoji+'</div><h3 class="title-font text-2xl text-amber-100 mb-2">'+tile.name+'</h3><p class="text-amber-200 mb-4">'+(randomGame||tile.desc)+'</p>'+(aegyo?'<div class="bg-black/30 rounded-xl p-3 mb-4 text-left max-h-32 overflow-y-auto"><p class="text-amber-300 text-xs mb-1">'+aegyo.id+'ë²ˆ '+aegyo.level+'</p><p class="text-amber-100 text-sm">'+aegyo.text+'</p></div>':'')+(isMyTurn?'<button data-action="close-mission" class="btn-beer text-white font-bold py-3 px-8 rounded-xl">í™•ì¸</button>':'<div class="text-amber-300/70 py-3">'+curr?.name+' í™•ì¸ ì¤‘...</div>')+'</div></div>';
}

function renderLiarGame(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const liarIds=room.liarIds||[room.liarId];
  const isLiar=liarIds.includes(state.odPlyerId),phase=room.phase;
  const isHost=room.hostId===state.odPlyerId;
  let content='';
  if(phase==='role')content=renderLiarRole(room,players,isLiar,isHost);
  else if(phase==='discuss')content=renderLiarDiscuss(room,players,isLiar,isHost);
  else if(phase==='vote')content=renderLiarVote(room,players,isHost);
  else if(phase==='reveal')content=renderLiarReveal(room,players);
  else if(phase==='result')content=renderLiarResult(room,players,isHost);
  return '<div class="min-h-screen bg-liar p-4 relative overflow-hidden">'+renderStars()+'<div class="absolute top-20 right-10 text-6xl opacity-15 animate-float">ğŸ­</div><div class="absolute bottom-20 left-10 text-5xl opacity-10 animate-float-reverse">ğŸ”</div><div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-4"><button data-action="show-leave" class="btn-ghost px-3 py-1 text-red-400 rounded-xl hover:bg-red-500/20">ğŸšª</button><h1 class="title-font text-3xl text-red-400 flex-1 text-center">ğŸ­ ë¼ì´ì–´ ê²Œì„ ğŸ­</h1><div class="flex items-center gap-2"><span class="text-white/30 text-sm">'+state.roomCode+'</span>'+(isHost?'<button data-action="show-manage" class="text-yellow-400 text-sm hover:text-yellow-300">ğŸ‘‘ê´€ë¦¬</button>':'')+'</div></div>'+content+'</div>'+renderChatToggle()+renderChatPanel('liar')+(state.showLeave?renderLeaveModal():'')+(state.showManage?renderManageModal():'')+'</div>';
}

function renderLiarRole(room,players,isLiar,isHost){
  const flippedPlayers=room.flippedPlayers||{};
  const allFlipped=players.every(p=>flippedPlayers[p.id]);
  const myFlipped=flippedPlayers[state.odPlyerId]||state.liarFlipped;
  return '<div class="text-center"><p class="text-white/70 mb-3">ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ì—­í• ì„ í™•ì¸í•˜ì„¸ìš”!</p><div class="flex justify-center mb-4"><div class="liar-card-container w-40 h-56 cursor-pointer" data-action="flip-card"><div class="liar-card-inner w-full h-full '+(myFlipped?'flipped':'')+'"><div class="liar-card-front bg-gradient-to-br from-gray-700 to-gray-900 border-4 border-gray-600 flex items-center justify-center shadow-xl"><span class="text-5xl">â“</span></div><div class="liar-card-back '+(isLiar?'bg-gradient-to-br from-red-600 to-red-900 border-red-500':'bg-gradient-to-br from-blue-600 to-blue-900 border-blue-500')+' border-4 flex flex-col items-center justify-center p-3 shadow-xl"><span class="text-4xl mb-2">'+(isLiar?'ğŸ¤¥':'ğŸ˜‡')+'</span><p class="text-xl font-black text-white mb-1">'+(isLiar?'ë¼ì´ì–´':'ì‹œë¯¼')+'</p>'+(!isLiar?'<div class="bg-black/30 rounded-lg px-3 py-1 w-full"><p class="text-white/70 text-xs">'+room.topic+'</p><p class="text-white text-lg font-bold">'+room.word+'</p></div>':'<p class="text-red-200 text-xs">ì œì‹œì–´ë¥¼ ëª¨ë¦…ë‹ˆë‹¤!</p>')+'</div></div></div></div><div class="card-liar rounded-2xl p-3 mb-4 max-w-sm mx-auto"><p class="text-white/70 text-xs mb-2">í™•ì¸ í˜„í™© ('+Object.keys(flippedPlayers).length+'/'+players.length+')</p><div class="flex flex-wrap justify-center gap-1">'+players.map((p,i)=>'<div class="flex items-center gap-1 '+(flippedPlayers[p.id]?'bg-green-500/20':'bg-black/30')+' rounded-full px-2 py-0.5"><div class="w-4 h-4 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><span class="text-white text-xs">'+p.name+'</span>'+(flippedPlayers[p.id]?'<span class="text-green-400 text-xs">âœ“</span>':'')+'</div>').join('')+'</div></div>'+(isHost?'<button data-action="start-discuss" '+(allFlipped?'':'disabled')+' class="btn-liar text-white text-lg font-bold py-3 px-6 rounded-2xl '+(allFlipped?'hover:scale-105 transition-transform':'opacity-50 cursor-not-allowed')+'">ğŸ’¬ í† ë¡  ì‹œì‘</button>':'<p class="text-white/50 text-sm">'+(allFlipped?'í˜¸ìŠ¤íŠ¸ê°€ í† ë¡ ì„ ì‹œì‘í•©ë‹ˆë‹¤...':'ëª¨ë‘ ì¹´ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”')+'</p>')+'</div>';
}

function renderLiarDiscuss(room,players,isLiar,isHost){
  const endTime=room.discussEndTime||0;
  const remaining=Math.max(0,Math.floor((endTime-Date.now())/1000));
  const minutes=Math.floor(remaining/60);
  const seconds=remaining%60;
  const timeStr=minutes+':'+(seconds<10?'0':'')+seconds;
  const progress=(remaining/(room.discussTime*60))*100;
  return '<div><div class="card-liar rounded-2xl p-4 mb-4 max-w-lg mx-auto text-center"><div class="text-3xl mb-2">ğŸ’¬</div><p class="text-red-400 text-xl font-bold mb-2">í† ë¡  ì‹œê°„!</p><div class="bg-black/30 rounded-xl p-3 mb-3"><div class="flex justify-between items-center mb-2"><span class="text-white/50 text-sm">ë‚¨ì€ ì‹œê°„</span><span class="text-2xl font-bold '+(remaining<=30?'text-red-500 animate-pulse':'text-white')+'">'+timeStr+'</span></div><div class="w-full h-3 bg-black/50 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-1000" style="width:'+progress+'%"></div></div></div><div class="bg-black/30 rounded-xl p-3 mb-3"><p class="text-white/50 text-sm">ì£¼ì œ</p><p class="text-white text-2xl font-bold">'+room.topic+'</p>'+(!isLiar?'<p class="text-green-400 mt-1">ì œì‹œì–´: <strong>'+room.word+'</strong></p>':'<p class="text-red-400 mt-1 text-sm">ğŸ¤¥ ë‹¹ì‹ ì€ ë¼ì´ì–´ì…ë‹ˆë‹¤!</p>')+'</div><p class="text-white/60 text-sm mb-4">ëˆ„ê°€ ë¼ì´ì–´ì¸ì§€ í† ë¡ í•˜ì„¸ìš”!</p>'+(isHost&&remaining<=0?'<button data-action="start-vote" class="btn-liar text-white font-bold py-2 px-6 rounded-xl hover:scale-105 transition-transform animate-pulse">ğŸ—³ï¸ íˆ¬í‘œ ì‹œì‘</button>':'')+(remaining>0?'<p class="text-yellow-400 text-sm">â° ì‹œê°„ì´ ëë‚˜ë©´ íˆ¬í‘œê°€ ì‹œì‘ë©ë‹ˆë‹¤</p>':'')+'</div></div>';
}

function renderLiarVote(room,players,isHost){
  const myVote=state.liarVote;
  const votes=room.votes||{};
  const voteCount=Object.keys(votes).length;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-4 mb-4 max-w-lg mx-auto"><div class="text-3xl mb-2">ğŸ—³ï¸</div><p class="text-red-400 text-xl font-bold mb-2">ë¼ì´ì–´ íˆ¬í‘œ!</p><p class="text-white/50 text-sm mb-3">íˆ¬í‘œ: '+voteCount+'/'+players.length+'</p><div class="grid grid-cols-3 gap-2">'+players.map((p,i)=>'<button data-action="vote" data-target="'+p.id+'" '+(p.id===state.odPlyerId?'disabled':'')+' class="p-2 rounded-xl border-2 transition-all '+(myVote===p.id||votes[state.odPlyerId]===p.id?'bg-red-500/30 border-red-500':'bg-black/30 border-white/20 hover:border-red-400')+' '+(p.id===state.odPlyerId?'opacity-40 cursor-not-allowed':'')+'"><div class="w-8 h-8 rounded-full mx-auto mb-1" style="background:'+PLAYER_COLORS[i]+'"></div><p class="text-white text-xs">'+p.name+'</p>'+(myVote===p.id||votes[state.odPlyerId]===p.id?'<p class="text-red-400 text-xs">âœ“</p>':'')+'</button>').join('')+'</div></div>'+(isHost?'<button data-action="reveal-votes" '+(voteCount<players.length?'disabled':'')+' class="btn-liar text-white font-bold py-3 px-6 rounded-2xl '+(voteCount<players.length?'opacity-50 cursor-not-allowed':'hover:scale-105 transition-transform')+'">ğŸ­ ê²°ê³¼ ê³µê°œ</button>':'<p class="text-white/40 text-sm">ëª¨ë“  íˆ¬í‘œê°€ ì™„ë£Œë˜ë©´ ê³µê°œë©ë‹ˆë‹¤</p>')+'</div>';
}

function renderLiarReveal(room,players){
  const votes=room.votes||{};
  const counts={};
  players.forEach(p=>counts[p.id]=0);
  Object.values(votes).forEach(v=>{if(counts[v]!==undefined)counts[v]++});
  const maxV=Math.max(...Object.values(counts),0);
  const mostVoted=Object.keys(counts).filter(k=>counts[k]===maxV);
  const liarIds=room.liarIds||[room.liarId];
  const liarCaught=liarIds.some(id=>mostVoted.includes(id));
  const liars=players.filter(p=>liarIds.includes(p.id));
  const isLiar=liarIds.includes(state.odPlyerId);
  const isHost=room.hostId===state.odPlyerId;
  const liarNames=liars.map(l=>l.name).join(', ');
  return '<div class="text-center"><div class="card-liar rounded-2xl p-4 mb-4 max-w-lg mx-auto"><p class="text-red-400 text-xl font-bold mb-3">ğŸ­ íˆ¬í‘œ ê²°ê³¼</p><div class="bg-black/30 rounded-xl p-3"><p class="text-white/70 text-sm">ë¼ì´ì–´ëŠ”...</p><p class="text-2xl font-black '+(liarCaught?'text-green-400':'text-red-400')+'">'+liarNames+' ğŸ¤¥</p><p class="text-lg mt-2 '+(liarCaught?'text-green-300':'text-red-300')+'">'+(liarCaught?'âœ… ë¼ì´ì–´ ë°œê°!':'âŒ ë¼ì´ì–´ ìŠ¹ë¦¬!')+'</p></div></div>'+(liarCaught&&isLiar?'<div class="card-liar rounded-2xl p-3 mb-4 max-w-sm mx-auto"><p class="text-white/70 text-sm mb-2">ğŸ¯ ì œì‹œì–´ë¥¼ ë§ì¶”ë©´ ì—­ì „!</p><input type="text" id="liar-guess" class="input-liar w-full px-3 py-2 rounded-xl mb-2 text-center" placeholder="ì œì‹œì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."><button data-action="liar-guess" class="btn-liar w-full py-2 rounded-xl hover:scale-105 transition-transform">ì œì¶œ!</button></div>':'')+(isHost&&!liarCaught?'<button data-action="show-result" class="btn-liar text-white font-bold py-3 px-6 rounded-2xl hover:scale-105 transition-transform">ğŸ“Š ìµœì¢… ê²°ê³¼</button>':'')+'</div>';
}

function renderLiarResult(room,players,isHost){
  const liarIds=room.liarIds||[room.liarId];
  const liars=players.filter(p=>liarIds.includes(p.id));
  const liarNames=liars.map(l=>l.name).join(', ');
  const liarWon=room.liarGuessCorrect===true||!room.liarCaught;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-6 mb-4 max-w-lg mx-auto animate-result-pop"><div class="text-6xl mb-3">'+(liarWon?'ğŸ˜ˆ':'ğŸ‰')+'</div><p class="text-3xl font-black '+(liarWon?'text-red-400':'text-green-400')+' mb-3">'+(liarWon?'ğŸ¤¥ ë¼ì´ì–´ ìŠ¹ë¦¬!':'ğŸ˜‡ ì‹œë¯¼ ìŠ¹ë¦¬!')+'</p><div class="bg-black/30 rounded-xl p-3 space-y-1"><p class="text-white/70">ë¼ì´ì–´: <span class="text-red-400 font-bold">'+liarNames+'</span></p><p class="text-white/70">ì£¼ì œ: <span class="text-white font-bold">'+room.topic+'</span></p><p class="text-white/70">ì •ë‹µ: <span class="text-green-400 font-bold text-xl">'+room.word+'</span></p></div></div>'+(isHost?'<button data-action="new-round" class="btn-liar text-white text-lg font-bold py-3 px-8 rounded-2xl hover:scale-105 transition-transform">ğŸ”„ ìƒˆ ë¼ìš´ë“œ</button>':'<p class="text-white/50">í˜¸ìŠ¤íŠ¸ê°€ ìƒˆ ë¼ìš´ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤</p>')+'</div>';
}

function bindEvents(){
  document.querySelectorAll('[data-action]').forEach(el=>{
    el.onclick=e=>{e.stopPropagation();handleAction(el.dataset.action,el.dataset)}
  });
  document.querySelectorAll('[data-slot]').forEach(el=>{
    el.oninput=e=>{const idx=parseInt(el.dataset.slot);if(!isNaN(idx))state.rouletteSlots[idx]=e.target.value}
  });
  const guessInput=document.getElementById('liar-guess');
  if(guessInput)guessInput.oninput=e=>state.liarGuess=e.target.value;
  const chatInput=document.getElementById('chat-input');
  if(chatInput){chatInput.onkeydown=e=>{if(e.key==='Enter')sendChat()};state.chatMsg='';chatInput.oninput=e=>state.chatMsg=e.target.value}
  const chatBox=document.getElementById('chat-box');
  if(chatBox)chatBox.scrollTop=chatBox.scrollHeight;
  const drawSizeInput=document.getElementById('draw-size');
  if(drawSizeInput)drawSizeInput.oninput=e=>state.drawSize=parseInt(e.target.value);
  const drawGuessInput=document.getElementById('draw-guess');
  if(drawGuessInput){drawGuessInput.oninput=e=>{state.drawGuess=e.target.value;checkMacro()};drawGuessInput.onkeydown=e=>{if(e.key==='Enter')submitDrawGuess()}}
  initDrawCanvas();
}

function checkMacro(){
  const now=Date.now();
  const pid=state.odPlyerId;
  if(!pid)return;
  if(!state.macroTracker[pid])state.macroTracker[pid]=[];
  state.macroTracker[pid].push(now);
  const recent=state.macroTracker[pid].filter(t=>now-t<3000);
  state.macroTracker[pid]=recent;
  if(recent.length>=10)kickByMacro();
}

function kickByMacro(){
  if(state.kickedByMacro)return;
  state.kickedByMacro=true;
  alert('ë§¤í¬ë¡œ ì˜ì‹¬ ì¦ìƒìœ¼ë¡œ ì¸í•´ ìë™ ì¶”ë°© ë˜ì—ˆìŠµë‹ˆë‹¤');
  leaveRoom();
  state.screen='home';
  render();
}

function initDrawCanvas(){
  const canvas=document.getElementById('draw-canvas');
  if(!canvas||!state.room)return;
  canvasCtx=canvas.getContext('2d');
  const isDrawer=state.room.drawerId===state.odPlyerId;
  if(!state.room.canvasData){
    canvasCtx.fillStyle='white';
    canvasCtx.fillRect(0,0,canvas.width,canvas.height);
  }else{
    const img=new Image();
    img.onload=()=>canvasCtx.drawImage(img,0,0);
    img.src=state.room.canvasData;
  }
  if(!isDrawer)return;
  let lastX=0,lastY=0;
  canvas.onmousedown=e=>{state.isDrawing=true;const rect=canvas.getBoundingClientRect();lastX=(e.clientX-rect.left)*(canvas.width/rect.width);lastY=(e.clientY-rect.top)*(canvas.height/rect.height);draw(lastX,lastY)};
  canvas.onmousemove=e=>{if(!state.isDrawing)return;const rect=canvas.getBoundingClientRect();const x=(e.clientX-rect.left)*(canvas.width/rect.width);const y=(e.clientY-rect.top)*(canvas.height/rect.height);drawLine(lastX,lastY,x,y);lastX=x;lastY=y};
  canvas.onmouseup=()=>{state.isDrawing=false;saveCanvas()};
  canvas.onmouseleave=()=>{state.isDrawing=false;saveCanvas()};
  canvas.ontouchstart=e=>{e.preventDefault();state.isDrawing=true;const rect=canvas.getBoundingClientRect();const touch=e.touches[0];lastX=(touch.clientX-rect.left)*(canvas.width/rect.width);lastY=(touch.clientY-rect.top)*(canvas.height/rect.height);draw(lastX,lastY)};
  canvas.ontouchmove=e=>{e.preventDefault();if(!state.isDrawing||!e.touches[0])return;const rect=canvas.getBoundingClientRect();const touch=e.touches[0];const x=(touch.clientX-rect.left)*(canvas.width/rect.width);const y=(touch.clientY-rect.top)*(canvas.height/rect.height);drawLine(lastX,lastY,x,y);lastX=x;lastY=y};
  canvas.ontouchend=()=>{state.isDrawing=false;saveCanvas()};
}

function draw(x,y){if(!canvasCtx)return;canvasCtx.fillStyle=state.isEraser?'white':state.drawColor;canvasCtx.beginPath();canvasCtx.arc(x,y,state.drawSize/2,0,Math.PI*2);canvasCtx.fill()}
function drawLine(x1,y1,x2,y2){if(!canvasCtx)return;canvasCtx.strokeStyle=state.isEraser?'white':state.drawColor;canvasCtx.lineWidth=state.drawSize;canvasCtx.lineCap='round';canvasCtx.beginPath();canvasCtx.moveTo(x1,y1);canvasCtx.lineTo(x2,y2);canvasCtx.stroke()}
function saveCanvas(){if(!roomRef||!canvasCtx)return;const canvas=document.getElementById('draw-canvas');if(canvas)roomRef.child('canvasData').set(canvas.toDataURL())}
function clearCanvas(){if(!canvasCtx)return;const canvas=document.getElementById('draw-canvas');canvasCtx.fillStyle='white';canvasCtx.fillRect(0,0,canvas.width,canvas.height);saveCanvas()}

function submitDrawGuess(){
  if(!roomRef||!state.drawGuess.trim()||!state.room)return;
  const guess=state.drawGuess.trim();
  const correct=guess.toLowerCase()===state.room.drawWord.toLowerCase();
  playSound(correct?'success':'wrong');
  roomRef.child('guesses/'+state.odPlyerId).set({text:guess,correct,time:Date.now()});
  if(correct){
    const currentOrder=state.room.correctOrder||[];
    const rank=currentOrder.length;
    let points=3;
    if(rank===0)points=15;
    else if(rank===1)points=10;
    else if(rank===2)points=5;
    const newScore=(state.room.drawScores?.[state.odPlyerId]||0)+points;
    roomRef.child('drawScores/'+state.odPlyerId).set(newScore);
    roomRef.child('correctOrder').set([...currentOrder,state.odPlyerId]);
  }
  state.drawGuess='';
  const input=document.getElementById('draw-guess');
  if(input)input.value='';
}

function handleAction(a,d){
  if(a!=='spin'&&a!=='flip-card'&&a!=='spin-arrow')playSound('click');
  switch(a){
    case 'go-home':state.screen='home';state.game=null;leaveRoom();render();break;
    case 'select-game':const g=GAMES.find(x=>x.id===d.game);if(g){state.game=g;state.screen=g.solo?'roulette':'lobby'}render();break;
    case 'join-or-create':joinOrCreate();break;
    case 'start-game':startGame();break;
    case 'copy-code':navigator.clipboard?.writeText(state.roomCode);break;
    case 'show-leave':state.showLeave=true;render();break;
    case 'cancel-leave':state.showLeave=false;render();break;
    case 'leave-room':leaveRoom();state.screen='home';render();break;
    case 'kick':kickPlayer(d.pid);render();break;
    case 'roll-dice':rollDice();break;
    case 'close-mission':closeMission();break;
    case 'add-slot':state.rouletteSlots.push('');render();break;
    case 'remove-slot':if(state.rouletteSlots.length>2){state.rouletteSlots.splice(parseInt(d.idx),1);render()}break;
    case 'spin':spinRoulette();break;
    case 'show-update':state.showUpdate=true;render();break;
    case 'close-update':state.showUpdate=false;render();break;
    case 'show-aegyo':state.showAegyo=true;render();break;
    case 'close-aegyo':state.showAegyo=false;render();break;
    case 'flip-card':flipLiarCard();break;
    case 'start-discuss':playSound('discuss');const discussEnd=Date.now()+(state.room.discussTime||5)*60*1000;updateRoom({phase:'discuss',discussEndTime:discussEnd});startLiarTimer(discussEnd);break;
    case 'start-vote':playSound('vote');updateRoom({phase:'vote',votes:{}});state.liarVote=null;break;
    case 'vote':playSound('vote');state.liarVote=d.target;if(roomRef)roomRef.child('votes/'+state.odPlyerId).set(d.target);render();break;
    case 'reveal-votes':revealVotes();break;
    case 'liar-guess':liarGuessWord();break;
    case 'show-result':showFinalResult();break;
    case 'new-round':newLiarRound();break;
    case 'send-chat':sendChat();break;
    case 'toggle-chat':state.showChat=!state.showChat;if(state.showChat){state.lastReadChatCount=state.room?.chats?Object.keys(state.room.chats).length:0}render();break;
    case 'spin-arrow':spinArrow();break;
    case 'reset-arrow':resetArrow();break;
    case 'rescue-vote':rescueVote(d.vote==='yes');break;
    case 'show-admin':state.showAdmin=true;render();break;
    case 'close-admin':state.showAdmin=false;render();break;
    case 'admin-login':adminLogin();break;
    case 'close-maint-form':state.showMaintForm=false;render();break;
    case 'set-maint-type':state.maintType=d.type;render();break;
    case 'apply-maint':applyMaintenance();break;
    case 'clear-maint':clearMaintenance();break;
    case 'show-manage':state.showManage=true;render();break;
    case 'close-manage':state.showManage=false;render();break;
    case 'start-draw-game':startDrawGame();break;
    case 'next-drawer':nextDrawer();break;
    case 'clear-canvas':clearCanvas();break;
    case 'submit-guess':submitDrawGuess();break;
    case 'toggle-eraser':state.isEraser=!state.isEraser;render();break;
    case 'set-draw-color':state.drawColor=d.color;state.isEraser=false;render();break;
    case 'show-swap-select':state.showSwapSelect=true;render();break;
    case 'close-swap':state.showSwapSelect=false;closeMission();break;
    case 'swap-with':swapWith(d.pid);break;
    case 'start-bomb':startBomb();break;
    case 'set-discuss-time':setDiscussTime(parseInt(d.time));break;
    case 'set-liar-count':adjustLiarCount(parseInt(d.count));break;
    case 'end-draw-round':endDrawRound();break;
    case 'back-to-lobby':backToLobby();break;
    case 'close-bomb':closeBomb();break;
    case 'reroll-golden-key':rerollGoldenKey();break;
  }
}

function adminLogin(){
  const id=document.getElementById('admin-id')?.value;
  const pw=document.getElementById('admin-pw')?.value;
  if(id===ADMIN_ID&&pw===ADMIN_PW){
    state.showAdmin=false;
    state.showMaintForm=true;
    state.maintType='maintenance';
    playSound('success');
  }else{
    playSound('wrong');
    alert('ë¡œê·¸ì¸ ì‹¤íŒ¨!');
  }
  render();
}

function applyMaintenance(){
  if(!isFirebaseReady)return;
  const reason=document.getElementById('maint-reason')?.value;
  const dateFrom=document.getElementById('maint-date-from')?.value;
  const dateTo=document.getElementById('maint-date-to')?.value;
  const timeFrom=document.getElementById('maint-time-from')?.value;
  const timeTo=document.getElementById('maint-time-to')?.value;
  if(!state.maintType||!reason||!dateFrom||!dateTo||!timeFrom||!timeTo){
    alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”!');
    return;
  }
  db.ref('maintenance').set({active:true,type:state.maintType,reason,dateFrom,dateTo,timeFrom,timeTo});
  state.showMaintForm=false;
  playSound('success');
  render();
}

function clearMaintenance(){
  if(!isFirebaseReady)return;
  db.ref('maintenance').set(null);
  state.showMaintForm=false;
  playSound('success');
  render();
}

function sendChat(){
  if(!roomRef||!state.chatMsg.trim())return;
  playSound('chat');
  roomRef.child('chats').push().set({pid:state.odPlyerId,msg:state.chatMsg.trim(),time:Date.now()});
  state.chatMsg='';
  const input=document.getElementById('chat-input');
  if(input)input.value='';
}

function flipLiarCard(){
  if(state.liarFlipped)return;
  playSound('flip');
  state.liarFlipped=true;
  if(roomRef)roomRef.child('flippedPlayers/'+state.odPlyerId).set(true);
  render();
}

function joinOrCreate(){
  const name=document.getElementById('pname')?.value?.trim();
  const code=document.getElementById('rcode')?.value?.toUpperCase()?.trim();
  if(!name)return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!');
  if(name.length>10)return alert('ë‹‰ë„¤ì„ì€ 10ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”!');
  if(!isFirebaseReady)return alert('Firebase ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!');
  state.playerName=name;
  if(code&&code.length===6){joinRoom(code)}else{createRoom()}
}

function createRoom(){
  state.roomCode=genCode();
  state.odPlyerId=genCode();
  const data={
    hostId:state.odPlyerId,
    gameId:state.game.id,
    status:'waiting',
    players:{[state.odPlyerId]:{id:state.odPlyerId,name:state.playerName,order:0,position:0,islandTurn:0,finished:false,finishOrder:0}},
    turn:0,rolling:false,showMission:false,currentTileId:null,
    phase:'role',flippedPlayers:{},chats:{},arrowTarget:null,finishCount:0,
    rescueVoting:false,rescueTarget:null,rescueVotes:{},
    drawPhase:'waiting',drawerId:null,drawWord:'',drawScores:{},guesses:{},canvasData:null,drawCorrect:false,
    discussTime:5,liarCount:1,discussEndTime:null,drawEndTime:null,drawRoundEnded:false,correctOrder:[]
  };
  roomRef=db.ref('rooms/'+state.roomCode);
  roomRef.set(data).then(()=>{
    subscribeRoom();
    playSound('success');
  }).catch(err=>{
    console.error('Room create error:',err);
    alert('ë°© ìƒì„± ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  });
}

function joinRoom(code){
  state.roomCode=code;
  state.odPlyerId=genCode();
  roomRef=db.ref('rooms/'+code);
  roomRef.once('value').then(snap=>{
    const val=snap.val();
    if(!val)return alert('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    if(val.status!=='waiting')return alert('ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
    const g=GAMES.find(x=>x.id===val.gameId);
    if(!g)return alert('ì•Œ ìˆ˜ ì—†ëŠ” ê²Œì„ì…ë‹ˆë‹¤!');
    const cnt=Object.keys(val.players||{}).length;
    if(cnt>=g.max)return alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');
    state.game=g;
    roomRef.child('players/'+state.odPlyerId).set({
      id:state.odPlyerId,name:state.playerName,order:cnt,position:0,islandTurn:0,finished:false,finishOrder:0
    }).then(()=>{
      subscribeRoom();
      playSound('join');
    }).catch(err=>{
      console.error('Join error:',err);
      alert('ì…ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    });
  }).catch(err=>{
    console.error('Room fetch error:',err);
    alert('ë°© ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
  });
}

function subscribeRoom(){
  if(!roomRef)return;
  roomRef.on('value',snap=>{
    const val=snap.val();
    if(!val){
      state.room=null;state.screen='home';
      playSound('kick');
      render();
      return;
    }
    const wasWaiting=!state.room||state.room.status==='waiting';
    const nowPlaying=val.status==='playing';
    const prevDiscussEnd=state.room?.discussEndTime;
    const prevDrawEnd=state.room?.drawEndTime;
    state.room=val;
    if(wasWaiting&&nowPlaying){
      state.screen='game';
      state.liarFlipped=false;
      state.liarVote=null;
      playSound('success');
    }
    if(val.diceValue&&val.diceValue!==state.localDice){
      state.localDice=val.diceValue;
    }
    if(val.discussEndTime&&val.discussEndTime!==prevDiscussEnd){
      startLiarTimer(val.discussEndTime);
    }
    if(val.drawEndTime&&val.drawEndTime!==prevDrawEnd){
      startDrawTimer(val.drawEndTime);
    }
    render();
  });
}

function leaveRoom(){
  if(!roomRef)return;
  const isHost=state.room?.hostId===state.odPlyerId;
  if(isHost){
    roomRef.remove();
  }else{
    roomRef.child('players/'+state.odPlyerId).remove();
  }
  roomRef.off();
  roomRef=null;
  state.room=null;
  state.showLeave=false;
  state.hasIslandSkip=false;
  state.hasJoker=false;
}

function updateRoom(data){if(roomRef)roomRef.update(data)}

function kickPlayer(pid){
  if(!roomRef||state.room?.hostId!==state.odPlyerId)return;
  playSound('kick');
  roomRef.child('players/'+pid).remove();
}

function startGame(){
  if(!roomRef||!state.room||state.room.hostId!==state.odPlyerId)return;
  const g=state.game;
  const players=Object.values(state.room.players);
  if(players.length<g.min)return;
  
  if(g.id==='liar'){
    const topics=Object.keys(LIAR_TOPICS);
    const topic=topics[Math.floor(Math.random()*topics.length)];
    const words=LIAR_TOPICS[topic];
    const word=words[Math.floor(Math.random()*words.length)];
    const liarCount=Math.min(state.room.liarCount||1,Math.floor(players.length/2)-1)||1;
    const shuffled=[...players].sort(()=>Math.random()-0.5);
    const liarIds=shuffled.slice(0,liarCount).map(p=>p.id);
    updateRoom({status:'playing',phase:'role',topic,word,liarId:liarIds[0],liarIds,flippedPlayers:{},votes:{},liarGuessCorrect:null,liarCaught:null,discussTime:state.room.discussTime||5});
  }else if(g.id==='truth'){
    updateRoom({status:'playing',arrowTarget:null});
  }else if(g.id==='draw'){
    const drawer=players[0];
    const difficulties=Object.keys(DRAW_WORDS);
    const diff=difficulties[Math.floor(Math.random()*difficulties.length)];
    const words=DRAW_WORDS[diff];
    const word=words[Math.floor(Math.random()*words.length)];
    const endTime=Date.now()+300000;
    updateRoom({status:'playing',drawPhase:'drawing',drawerId:drawer.id,drawWord:word,guesses:{},canvasData:null,drawCorrect:false,drawScores:{},drawEndTime:endTime,drawRoundEnded:false,correctOrder:[]});
  }else{
    updateRoom({status:'playing',turn:0,rolling:false,showMission:false,currentTileId:null,finishCount:0});
  }
  playSound('success');
}

function spinRoulette(){
  if(state.rouletteSpinning)return;
  const valid=getValidSlots();
  if(valid.length<2)return alert('ìµœì†Œ 2ê°œ ì´ìƒ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”!');
  state.rouletteSpinning=true;
  state.rouletteResult=null;
  playSound('spin');
  const spins=5+Math.floor(Math.random()*3);
  const finalAngle=Math.random()*360;
  const target=spins*360+finalAngle;
  state.rouletteAngle=target;
  render();
  setTimeout(()=>{
    const segAngle=360/valid.length;
    const norm=(360-(target%360)+90)%360;
    const idx=Math.floor(norm/segAngle)%valid.length;
    state.rouletteResult=valid[idx];
    state.rouletteResultColor=ROULETTE_COLORS[idx%ROULETTE_COLORS.length];
    state.rouletteSpinning=false;
    playSound('win');
    render();
  },4000);
}

function spinArrow(){
  if(state.arrowSpinning||!roomRef||state.room?.arrowTarget)return;
  state.arrowSpinning=true;
  playSound('arrow');
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  const targetIdx=Math.floor(Math.random()*players.length);
  const angleStep=360/players.length;
  const baseAngle=targetIdx*angleStep;
  const spins=4+Math.floor(Math.random()*2);
  const finalAngle=spins*360+baseAngle;
  state.arrowAngle=finalAngle;
  render();
  setTimeout(()=>{
    state.arrowSpinning=false;
    roomRef.update({arrowTarget:players[targetIdx].id});
    playSound('win');
  },3000);
}

function resetArrow(){
  if(!roomRef)return;
  state.arrowAngle=0;
  roomRef.update({arrowTarget:null});
  render();
}

function rollDice(){
  if(!roomRef||!state.room||state.room.rolling)return;
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  const curr=players[state.room.turn%players.length];
  if(curr.id!==state.odPlyerId||curr.finished)return;
  
  playSound('dice');
  updateRoom({rolling:true});
  
  const rollAnim=setInterval(()=>{
    state.localDice=Math.ceil(Math.random()*6);
    render();
  },100);
  
  setTimeout(()=>{
    clearInterval(rollAnim);
    const dice=Math.ceil(Math.random()*6);
    state.localDice=dice;
    
    if(curr.islandTurn>0){
      if(dice===1||dice===2){
        playSound('escape');
        roomRef.child('players/'+state.odPlyerId+'/islandTurn').set(0);
        roomRef.update({rolling:false,diceValue:dice,turn:state.room.turn+1,showMission:false});
      }else{
        playSound('caught');
        roomRef.child('players/'+state.odPlyerId+'/islandTurn').set(curr.islandTurn+1);
        roomRef.update({rolling:false,diceValue:dice,turn:state.room.turn+1,showMission:false});
      }
      return;
    }
    
    let newPos=curr.position+dice;
    
    if(newPos>=32){
      newPos=32;
      const newFinishCount=(state.room.finishCount||0)+1;
      roomRef.child('players/'+state.odPlyerId).update({position:newPos,finished:true,finishOrder:newFinishCount});
      roomRef.update({rolling:false,diceValue:dice,turn:state.room.turn+1,showMission:false,finishCount:newFinishCount});
      playSound('win');
      return;
    }
    
    const tile=TILES[newPos];
    let finalPos=newPos;
    let showMission=true;
    let goldenKey=null;
    
    if(tile.type==='move'){
      if(tile.id===10)finalPos=Math.max(0,newPos-2);
      else if(tile.id===29)finalPos=Math.max(0,newPos-3);
      else if(tile.id===31){
        const eligibleVoters=players.filter(p=>p.id!==state.odPlyerId&&!p.finished);
        if(eligibleVoters.length>0){
          roomRef.update({rescueVoting:true,rescueTarget:state.odPlyerId,rescueVotes:{}});
          showMission=false;
        }else{
          finalPos=0;
        }
      }
    }else if(tile.type==='special'){
      goldenKey=GOLDEN_KEYS[Math.floor(Math.random()*GOLDEN_KEYS.length)].type;
      if(goldenKey==='island-skip')state.hasIslandSkip=true;
      if(goldenKey==='joker')state.hasJoker=true;
      playSound('golden');
    }else if(tile.type==='island'){
      if(state.hasIslandSkip){
        state.hasIslandSkip=false;
        showMission=false;
      }else{
        roomRef.child('players/'+state.odPlyerId+'/islandTurn').set(1);
      }
    }else if(tile.type==='toIsland'){
      if(state.hasIslandSkip){
        state.hasIslandSkip=false;
        showMission=false;
      }else{
        finalPos=18;
        roomRef.child('players/'+state.odPlyerId+'/islandTurn').set(1);
      }
    }else if(tile.type==='bonus'){
      showMission=false;
      roomRef.child('players/'+state.odPlyerId+'/position').set(finalPos);
      roomRef.update({rolling:false,diceValue:dice,showMission:false,currentTileId:tile.id});
      return;
    }else if(tile.type==='free'||tile.type==='start'){
      showMission=false;
    }
    
    roomRef.child('players/'+state.odPlyerId+'/position').set(finalPos);
    roomRef.update({rolling:false,diceValue:dice,turn:state.room.turn+1,showMission,currentTileId:tile.id,goldenKey});
    
    if(showMission)playSound('mission');
  },1500);
}

function closeMission(){
  if(!roomRef)return;
  updateRoom({showMission:false,goldenKey:null});
}

function rescueVote(isYes){
  if(!roomRef)return;
  playSound('vote');
  roomRef.child('rescueVotes/'+state.odPlyerId).set(isYes);
  
  setTimeout(()=>{
    if(!state.room)return;
    const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
    const eligibleVoters=players.filter(p=>p.id!==state.room.rescueTarget&&!p.finished);
    const votes=state.room.rescueVotes||{};
    const voteCount=Object.keys(votes).length;
    
    if(voteCount>=eligibleVoters.length){
      const yesVotes=Object.values(votes).filter(v=>v===true).length;
      const noVotes=Object.values(votes).filter(v=>v===false).length;
      
      if(yesVotes>noVotes){
        playSound('escape');
      }else{
        roomRef.child('players/'+state.room.rescueTarget+'/position').set(0);
        playSound('caught');
      }
      roomRef.update({rescueVoting:false,rescueTarget:null,rescueVotes:{}});
    }
  },500);
}

function revealVotes(){
  if(!roomRef)return;
  playSound('reveal');
  const votes=state.room.votes||{};
  const players=Object.values(state.room.players);
  const counts={};
  players.forEach(p=>counts[p.id]=0);
  Object.values(votes).forEach(v=>{if(counts[v]!==undefined)counts[v]++});
  const maxV=Math.max(...Object.values(counts),0);
  const mostVoted=Object.keys(counts).filter(k=>counts[k]===maxV);
  const liarCaught=mostVoted.includes(state.room.liarId);
  updateRoom({phase:'reveal',liarCaught});
}

function liarGuessWord(){
  if(!roomRef||!state.liarGuess.trim())return;
  const correct=state.liarGuess.trim()===state.room.word;
  playSound(correct?'win':'wrong');
  updateRoom({phase:'result',liarGuessCorrect:correct});
  state.liarGuess='';
}

function showFinalResult(){
  if(!roomRef)return;
  updateRoom({phase:'result'});
}

function newLiarRound(){
  if(!roomRef)return;
  const players=Object.values(state.room.players);
  const topics=Object.keys(LIAR_TOPICS);
  const topic=topics[Math.floor(Math.random()*topics.length)];
  const words=LIAR_TOPICS[topic];
  const word=words[Math.floor(Math.random()*words.length)];
  const liarIdx=Math.floor(Math.random()*players.length);
  state.liarFlipped=false;
  state.liarVote=null;
  state.liarGuess='';
  updateRoom({phase:'role',topic,word,liarId:players[liarIdx].id,flippedPlayers:{},votes:{},liarGuessCorrect:null,liarCaught:null});
  playSound('success');
}

function startDrawGame(){
  if(!roomRef)return;
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  const drawer=players[0];
  const difficulties=Object.keys(DRAW_WORDS);
  const diff=difficulties[Math.floor(Math.random()*difficulties.length)];
  const words=DRAW_WORDS[diff];
  const word=words[Math.floor(Math.random()*words.length)];
  updateRoom({drawPhase:'drawing',drawerId:drawer.id,drawWord:word,guesses:{},canvasData:null,drawCorrect:false});
  playSound('success');
}

function nextDrawer(){
  if(!roomRef)return;
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  const currIdx=players.findIndex(p=>p.id===state.room.drawerId);
  const nextIdx=(currIdx+1)%players.length;
  const drawer=players[nextIdx];
  const difficulties=Object.keys(DRAW_WORDS);
  const diff=difficulties[Math.floor(Math.random()*difficulties.length)];
  const words=DRAW_WORDS[diff];
  const word=words[Math.floor(Math.random()*words.length)];
  updateRoom({drawerId:drawer.id,drawWord:word,guesses:{},canvasData:null,drawCorrect:false});
  playSound('success');
}

function swapWith(targetId){
  if(!roomRef)return;
  const myPlayer=state.room.players[state.odPlyerId];
  const targetPlayer=state.room.players[targetId];
  const myPos=myPlayer.position;
  const targetPos=targetPlayer.position;
  playSound('success');
  roomRef.child('players/'+state.odPlyerId+'/position').set(targetPos);
  roomRef.child('players/'+targetId+'/position').set(myPos);
  state.showSwapSelect=false;
  closeMission();
}

function startBomb(){
  state.bombActive=true;
  state.bombCountdown=10;
  state.showBomb=true;
  playSound('bomb');
  render();
  bombInterval=setInterval(()=>{
    state.bombCountdown--;
    if(state.bombCountdown<=0){
      clearInterval(bombInterval);
      bombInterval=null;
      playSound('bomb');
    }
    render();
  },1000);
}

function closeBomb(){
  state.showBomb=false;
  state.bombActive=false;
  if(bombInterval){
    clearInterval(bombInterval);
    bombInterval=null;
  }
  closeMission();
}

function rerollGoldenKey(){
  if(!roomRef)return;
  const newKey=GOLDEN_KEYS[Math.floor(Math.random()*GOLDEN_KEYS.length)].type;
  if(newKey==='island-skip')state.hasIslandSkip=true;
  if(newKey==='joker')state.hasJoker=true;
  playSound('golden');
  roomRef.update({goldenKey:newKey});
}

function setDiscussTime(time){
  if(!roomRef||state.room?.hostId!==state.odPlyerId)return;
  roomRef.update({discussTime:time});
}

function adjustLiarCount(delta){
  if(!roomRef||state.room?.hostId!==state.odPlyerId)return;
  const players=Object.values(state.room.players||{});
  const maxLiars=Math.max(1,Math.floor(players.length/2)-1);
  const current=state.room.liarCount||1;
  const newCount=Math.max(1,Math.min(maxLiars,current+delta));
  roomRef.update({liarCount:newCount});
}

function formatTime(seconds){
  const m=Math.floor(seconds/60);
  const s=seconds%60;
  return m+':'+(s<10?'0':'')+s;
}

let gameTimer=null;
let liarTimer=null;
let drawTimer=null;

function startLiarTimer(endTime){
  if(liarTimer)clearInterval(liarTimer);
  liarTimer=setInterval(()=>{
    const now=Date.now();
    const remaining=Math.max(0,Math.floor((endTime-now)/1000));
    if(remaining<=0){
      clearInterval(liarTimer);
      liarTimer=null;
    }
    render();
  },1000);
}

function startDrawTimer(endTime){
  if(drawTimer)clearInterval(drawTimer);
  drawTimer=setInterval(()=>{
    const now=Date.now();
    const remaining=Math.max(0,Math.floor((endTime-now)/1000));
    if(remaining<=0){
      clearInterval(drawTimer);
      drawTimer=null;
    }
    render();
  },1000);
}

function startGameTimer(endTime,callback){
  if(gameTimer)clearInterval(gameTimer);
  gameTimer=setInterval(()=>{
    const now=Date.now();
    const remaining=Math.max(0,Math.floor((endTime-now)/1000));
    state.drawTimeLeft=remaining;
    if(remaining<=0){
      clearInterval(gameTimer);
      gameTimer=null;
      if(callback)callback();
    }
    render();
  },1000);
}

function endDrawRound(){
  if(!roomRef||state.room?.hostId!==state.odPlyerId)return;
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  const correctOrder=state.room.correctOrder||[];
  const drawerId=state.room.drawerId;
  const scores=state.room.drawScores||{};
  
  players.forEach(p=>{
    if(p.id!==drawerId&&!correctOrder.includes(p.id)){
      const newScore=Math.max(0,(scores[p.id]||0)-2);
      roomRef.child('drawScores/'+p.id).set(newScore);
    }
  });
  
  const currIdx=players.findIndex(p=>p.id===drawerId);
  const nextIdx=(currIdx+1)%players.length;
  const drawer=players[nextIdx];
  const difficulties=Object.keys(DRAW_WORDS);
  const diff=difficulties[Math.floor(Math.random()*difficulties.length)];
  const words=DRAW_WORDS[diff];
  const word=words[Math.floor(Math.random()*words.length)];
  const endTime=Date.now()+300000;
  updateRoom({drawerId:drawer.id,drawWord:word,guesses:{},canvasData:null,drawCorrect:false,drawEndTime:endTime,drawRoundEnded:false,correctOrder:[]});
  playSound('success');
}

function backToLobby(){
  if(!roomRef)return;
  state.showDrawResult=false;
  updateRoom({status:'waiting',drawPhase:'waiting',drawerId:null,drawWord:'',guesses:{},canvasData:null,drawCorrect:false,drawScores:{},drawEndTime:null,correctOrder:[]});
}

function checkDrawWinner(){
  if(!state.room)return null;
  const scores=state.room.drawScores||{};
  const players=Object.values(state.room.players);
  for(const p of players){
    if((scores[p.id]||0)>=100)return p;
  }
  return null;
}

checkMaintenance();
render();
</script>
</body>
</html>
