<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® íŒŒí‹°ê²Œì„ - ì˜¨ë¼ì¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    *{font-family:'Noto Sans KR',sans-serif;margin:0;padding:0;box-sizing:border-box}
    .title-font{font-family:'Black Han Sans',sans-serif}
    .bg-party{background:linear-gradient(135deg,#0f0c29 0%,#302b63 50%,#24243e 100%);position:relative;overflow:hidden}
    .bg-party::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background-image:radial-gradient(circle at 20% 80%,rgba(120,119,198,0.3) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,119,198,0.2) 0%,transparent 50%),radial-gradient(circle at 40% 40%,rgba(100,200,255,0.15) 0%,transparent 40%);pointer-events:none}
    .bg-beer{background:linear-gradient(180deg,#1a0f00 0%,#2d1810 30%,#3d2817 60%,#2a1a0a 100%);position:relative}
    .bg-beer::before{content:'';position:absolute;inset:0;background-image:radial-gradient(ellipse at 30% 20%,rgba(255,180,50,0.15) 0%,transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(255,150,30,0.1) 0%,transparent 50%);pointer-events:none}
    .bg-roulette{background:linear-gradient(135deg,#0a0015 0%,#1a0030 25%,#2d1050 50%,#1a0030 75%,#0a0015 100%);position:relative}
    .bg-roulette::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle at 25% 25%,rgba(168,85,247,0.2) 0%,transparent 50%),radial-gradient(circle at 75% 75%,rgba(236,72,153,0.15) 0%,transparent 50%);pointer-events:none}
    .bg-liar{background:linear-gradient(135deg,#0a0a0a 0%,#1a0a0a 25%,#2a1015 50%,#1a0a0a 75%,#0a0a0a 100%);position:relative}
    .bg-liar::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle at 20% 30%,rgba(239,68,68,0.15) 0%,transparent 50%),radial-gradient(circle at 80% 70%,rgba(185,28,28,0.1) 0%,transparent 50%);pointer-events:none}
    .bg-truth{background:linear-gradient(135deg,#0a1628 0%,#1e3a5f 50%,#0d2137 100%);position:relative}
    .bg-truth::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle at 50% 50%,rgba(34,211,238,0.1) 0%,transparent 60%),radial-gradient(circle at 30% 70%,rgba(16,185,129,0.1) 0%,transparent 50%);pointer-events:none}
    @keyframes float{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-15px) rotate(2deg)}}
    @keyframes float-reverse{0%,100%{transform:translateY(0) rotate(2deg)}50%{transform:translateY(-20px) rotate(-2deg)}}
    @keyframes bounce-in{0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.05)}70%{transform:scale(0.9)}100%{transform:scale(1);opacity:1}}
    @keyframes fade-scale{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
    @keyframes slide-up{0%{transform:translateY(50px);opacity:0}100%{transform:translateY(0);opacity:1}}
    @keyframes dice-roll{0%{transform:rotate(0deg) scale(1)}25%{transform:rotate(20deg) scale(1.15)}50%{transform:rotate(-20deg) scale(1.1)}75%{transform:rotate(10deg) scale(1.15)}100%{transform:rotate(0deg) scale(1)}}
    @keyframes move-token{0%{transform:scale(1)}50%{transform:scale(1.3) translateY(-10px)}100%{transform:scale(1)}}
    @keyframes result-pop{0%{transform:scale(0) rotate(-180deg);opacity:0}50%{transform:scale(1.2) rotate(10deg)}100%{transform:scale(1) rotate(0deg);opacity:1}}
    @keyframes golden-glow{0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.5),0 0 40px rgba(255,215,0,0.3)}50%{box-shadow:0 0 40px rgba(255,215,0,0.8),0 0 60px rgba(255,215,0,0.5)}}
    @keyframes winner-glow{0%,100%{text-shadow:0 0 10px currentColor,0 0 20px currentColor}50%{text-shadow:0 0 20px currentColor,0 0 40px currentColor,0 0 60px currentColor}}
    @keyframes twinkle{0%,100%{opacity:0.3}50%{opacity:1}}
    @keyframes bottle-spin{0%{transform:rotate(0deg)}100%{transform:rotate(var(--spin-deg))}}
    @keyframes pulse-ring{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}
    .animate-float{animation:float 4s ease-in-out infinite}
    .animate-float-reverse{animation:float-reverse 5s ease-in-out infinite}
    .animate-bounce-in{animation:bounce-in 0.5s ease-out}
    .animate-fade-scale{animation:fade-scale 0.6s ease-out forwards}
    .animate-slide-up{animation:slide-up 0.5s ease-out forwards}
    .animate-dice-roll{animation:dice-roll 0.15s ease-in-out infinite}
    .animate-move{animation:move-token 0.5s ease-out}
    .animate-result-pop{animation:result-pop 0.6s ease-out forwards}
    .animate-golden-glow{animation:golden-glow 1.5s ease-in-out infinite}
    .animate-winner{animation:winner-glow 1s ease-in-out infinite}
    .animate-twinkle{animation:twinkle 2s ease-in-out infinite}
    .bottle-spin{animation:bottle-spin 4s cubic-bezier(0.2,0.8,0.3,1) forwards}
    .pulse-ring{animation:pulse-ring 1s ease-out infinite}
    .card-wood{background:linear-gradient(145deg,#5a4030 0%,#4a3525 50%,#3a2a1a 100%);border:3px solid #6d5040;box-shadow:0 10px 30px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.1)}
    .card-dark{background:linear-gradient(145deg,#2d2d44 0%,#1a1a2e 50%,#16162a 100%);border:2px solid #3d3d5c;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    .card-purple{background:linear-gradient(145deg,#2a1040 0%,#1a0828 50%,#10051a 100%);border:2px solid #5c3d8c;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .card-golden{background:linear-gradient(145deg,#ffd700 0%,#ffb800 50%,#ff9500 100%);border:3px solid #ffe44d;box-shadow:0 0 30px rgba(255,215,0,0.5)}
    .card-liar{background:linear-gradient(145deg,#2a1a1a 0%,#1a1010 50%,#100808 100%);border:2px solid #5c3030;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .card-truth{background:linear-gradient(145deg,#1e3a5f 0%,#152238 50%,#0d1520 100%);border:2px solid #2d5a8a;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .game-card{background:linear-gradient(145deg,rgba(255,255,255,0.12) 0%,rgba(255,255,255,0.04) 100%);border:2px solid rgba(255,255,255,0.15);transition:all 0.4s;backdrop-filter:blur(10px)}
    .game-card:hover{transform:translateY(-10px) scale(1.03);border-color:rgba(255,255,255,0.4);box-shadow:0 25px 50px rgba(0,0,0,0.4),0 0 30px var(--glow)}
    .tile-drink{background:linear-gradient(135deg,#D97706 0%,#B45309 100%)}.tile-game{background:linear-gradient(135deg,#059669 0%,#047857 100%)}
    .tile-bonus{background:linear-gradient(135deg,#2563EB 0%,#1D4ED8 100%)}.tile-move{background:linear-gradient(135deg,#7C3AED 0%,#6D28D9 100%)}
    .tile-special{background:linear-gradient(135deg,#F59E0B 0%,#D97706 100%)}.tile-free{background:linear-gradient(135deg,#6B7280 0%,#4B5563 100%)}
    .tile-start{background:linear-gradient(135deg,#10B981 0%,#059669 100%)}.tile-performance{background:linear-gradient(135deg,#EC4899 0%,#DB2777 100%)}
    .tile-island{background:linear-gradient(135deg,#0ea5e9 0%,#0284c7 100%)}
    .btn-primary{background:linear-gradient(180deg,#6366f1 0%,#4f46e5 100%);border:2px solid #4338ca;box-shadow:0 4px 0 #3730a3,0 6px 20px rgba(99,102,241,0.4)}
    .btn-beer{background:linear-gradient(180deg,#F4A836 0%,#D4891C 100%);border:2px solid #B8731A;box-shadow:0 4px 0 #8B5A14,0 6px 20px rgba(244,168,54,0.4)}
    .btn-purple{background:linear-gradient(180deg,#a855f7 0%,#9333ea 100%);border:2px solid #7e22ce;box-shadow:0 4px 0 #6b21a8,0 6px 20px rgba(168,85,247,0.4)}
    .btn-liar{background:linear-gradient(180deg,#ef4444 0%,#dc2626 100%);border:2px solid #b91c1c;box-shadow:0 4px 0 #991b1b,0 6px 20px rgba(239,68,68,0.4)}
    .btn-truth{background:linear-gradient(180deg,#06b6d4 0%,#0891b2 100%);border:2px solid #0e7490;box-shadow:0 4px 0 #155e75,0 6px 20px rgba(6,182,212,0.4)}
    .btn-danger{background:linear-gradient(180deg,#ef4444 0%,#dc2626 100%);border:2px solid #b91c1c;box-shadow:0 4px 0 #991b1b}
    .btn-secondary{background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.3)}
    .btn-ghost{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)}
    .input-dark{background:rgba(0,0,0,0.5);border:2px solid rgba(139,92,246,0.3);color:white}
    .input-dark:focus{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.2);outline:none}
    .input-beer{background:rgba(0,0,0,0.4);border:2px solid rgba(244,168,54,0.3);color:white}
    .input-beer:focus{border-color:#F4A836;box-shadow:0 0 0 3px rgba(244,168,54,0.3);outline:none}
    .input-liar{background:rgba(0,0,0,0.4);border:2px solid rgba(239,68,68,0.3);color:white}
    .input-liar:focus{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,0.2);outline:none}
    .input-truth{background:rgba(0,0,0,0.4);border:2px solid rgba(6,182,212,0.3);color:white}
    .input-truth:focus{border-color:#06b6d4;box-shadow:0 0 0 3px rgba(6,182,212,0.2);outline:none}
    .player-token{box-shadow:0 3px 6px rgba(0,0,0,0.4),inset 0 2px 4px rgba(255,255,255,0.3);border:2px solid rgba(255,255,255,0.5)}
    .roulette-wheel{transition:transform 4s cubic-bezier(0.2,0.8,0.3,1)}.roulette-wheel.reset{transition:none !important}
    .kick-btn{opacity:0;transition:opacity 0.2s}.player-item:hover .kick-btn{opacity:1}
    .liar-card-container{perspective:1000px}
    .liar-card-inner{position:relative;width:100%;height:100%;transition:transform 0.8s;transform-style:preserve-3d}
    .liar-card-inner.flipped{transform:rotateY(180deg)}
    .liar-card-front,.liar-card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:1rem}
    .liar-card-back{transform:rotateY(180deg)}
    .vote-bar{transition:width 1s ease-out}
    .update-scroll,.aegyo-scroll,.chat-scroll{max-height:60vh;overflow-y:auto}
    .update-scroll::-webkit-scrollbar,.aegyo-scroll::-webkit-scrollbar,.chat-scroll::-webkit-scrollbar{width:6px}
    .update-scroll::-webkit-scrollbar-track,.aegyo-scroll::-webkit-scrollbar-track,.chat-scroll::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:3px}
    .update-scroll::-webkit-scrollbar-thumb,.aegyo-scroll::-webkit-scrollbar-thumb,.chat-scroll::-webkit-scrollbar-thumb{background:rgba(139,92,246,0.5);border-radius:3px}
    .chat-box{max-height:200px;overflow-y:auto}
    .star{position:absolute;background:white;border-radius:50%}
  </style>
</head>
<body class="min-h-screen">
<div id="app"></div>
<script>
const AudioCtx=window.AudioContext||window.webkitAudioContext;let audioCtx=null;
function initAudio(){if(!audioCtx)audioCtx=new AudioCtx()}
function playSound(type){initAudio();if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);const t=audioCtx.currentTime;
const sounds={
click:()=>{o.frequency.setValueAtTime(800,t);o.frequency.exponentialRampToValueAtTime(600,t+0.1);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start();o.stop(t+0.1)},
success:()=>{o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+0.1);o.frequency.setValueAtTime(784,t+0.2);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.start();o.stop(t+0.3)},
spin:()=>{o.type='sawtooth';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(2000,t+0.5);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start();o.stop(t+0.5)},
win:()=>{[523,659,784,1047].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.3,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);os.start();os.stop(audioCtx.currentTime+0.2)},i*100)})},
dice:()=>{o.type='square';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(800,t+0.05);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start();o.stop(t+0.1)},
mission:()=>{o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(800,t+0.15);g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);o.start();o.stop(t+0.2)},
join:()=>{o.frequency.setValueAtTime(600,t);o.frequency.setValueAtTime(800,t+0.1);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);o.start();o.stop(t+0.2)},
kick:()=>{o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(150,t+0.3);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.start();o.stop(t+0.3)},
golden:()=>{[880,1108,1318,1760].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.2,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);os.start();os.stop(audioCtx.currentTime+0.15)},i*80)})},
reveal:()=>{[392,494,587,784].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.25,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.25);os.start();os.stop(audioCtx.currentTime+0.25)},i*120)})},
wrong:()=>{o.type='sawtooth';o.frequency.setValueAtTime(200,t);o.frequency.linearRampToValueAtTime(80,t+0.4);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);o.start();o.stop(t+0.4)},
vote:()=>{o.frequency.setValueAtTime(600,t);o.frequency.setValueAtTime(700,t+0.05);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start();o.stop(t+0.1)},
flip:()=>{o.type='sine';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(600,t+0.2);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);o.start();o.stop(t+0.2)},
discuss:()=>{[440,550,660].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.15,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);os.start();os.stop(audioCtx.currentTime+0.15)},i*100)})},
caught:()=>{[800,600,400,300].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.type='square';os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.2,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);os.start();os.stop(audioCtx.currentTime+0.15)},i*100)})},
escape:()=>{[300,400,500,700,900].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.2,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.12);os.start();os.stop(audioCtx.currentTime+0.12)},i*80)})},
bottle:()=>{o.type='sine';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(800,t+0.3);o.frequency.exponentialRampToValueAtTime(100,t+2);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.01,t+2);o.start();o.stop(t+2)},
chat:()=>{o.frequency.setValueAtTime(1000,t);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.05);o.start();o.stop(t+0.05)}
};if(sounds[type])sounds[type]()}

const firebaseConfig={apiKey:"AIzaSyCafzk3QueRsvj4DiMht6bTyHs0_HT5Iuc",authDomain:"test-e3974.firebaseapp.com",databaseURL:"https://test-e3974-default-rtdb.firebaseio.com",projectId:"test-e3974",storageBucket:"test-e3974.firebasestorage.app",messagingSenderId:"572983111486",appId:"1:572983111486:web:ce4e3f897f8faa66c4866f"};
let db=null,isFirebaseReady=false;
try{firebase.initializeApp(firebaseConfig);db=firebase.database();isFirebaseReady=true}catch(e){}

const UPDATE_LOGS=[
  {date:"2025ë…„ 12ì›” 11ì¼",version:"v1.4.0",changes:["ğŸ¾ ì§„ì‹¤ê²Œì„ (ì†Œì£¼ë³‘ ëŒë¦¬ê¸°) ì¶”ê°€","ğŸ’¬ ë¼ì´ì–´ ê²Œì„ ì±„íŒ… ê¸°ëŠ¥","ğŸ ì£¼ë£¨ë§ˆë¸” ì¢…ë£Œì¡°ê±´ & êµ¬ì›íˆ¬í‘œ","ğŸ² ì „ì²´ì ì¸ ì•ˆì •ì„± ê°œì„ "]},
  {date:"2025ë…„ 12ì›” 11ì¼",version:"v1.3.0",changes:["ğŸ² ì£¼ë£¨ë§ˆë¸” ê²Œì„íŒ í™•ëŒ€","ğŸï¸ ë¬´ì¸ë„ íŠ¸ë™ ì¶”ê°€","ğŸ”‘ í™©ê¸ˆì¹´ë“œ ë¦¬ë©”ì´í¬","ğŸ’• ì• êµëŒ€ì‚¬ 50ê°œ","ğŸ­ ë¼ì´ì–´ íš¨ê³¼ìŒ ì¶”ê°€"]}
];

const GAMES=[
  {id:'jurumarble',name:'ì£¼ë£¨ë§ˆë¸”',emoji:'ğŸº',desc:'ìˆ ì´ ìˆ ìˆ  ë„˜ì–´ê°€ëŠ” ë³´ë“œê²Œì„',color:'from-amber-500 to-orange-600',glow:'rgba(244,168,54,0.4)',bg:'bg-beer',min:2,max:12},
  {id:'truth',name:'ì§„ì‹¤ê²Œì„',emoji:'ğŸ¾',desc:'ì†Œì£¼ë³‘ ëŒë¦¬ê¸°! ëˆ„ê°€ ê±¸ë¦´ê¹Œ?',color:'from-cyan-500 to-teal-600',glow:'rgba(6,182,212,0.4)',bg:'bg-truth',min:2,max:12},
  {id:'roulette',name:'ë£°ë ›',emoji:'ğŸ¡',desc:'ìš´ëª…ì˜ ì›íŒ ëŒë¦¬ê¸°!',color:'from-purple-500 to-pink-600',glow:'rgba(168,85,247,0.4)',bg:'bg-roulette',solo:true},
  {id:'liar',name:'ë¼ì´ì–´ ê²Œì„',emoji:'ğŸ­',desc:'ê±°ì§“ë§ìŸì´ë¥¼ ì°¾ì•„ë¼!',color:'from-red-500 to-rose-600',glow:'rgba(239,68,68,0.4)',bg:'bg-liar',min:4,max:10}
];

const AEGYO_LIST=[
  {id:1,level:'â˜…â˜…â˜…â˜…â˜…',text:'ë‹¹ì‹ ëˆˆ 00ì´ì™€ ë§Œë‚˜ì„œ í–‰ë³µí•˜ë‹¤êµ¬ ë§í•˜ì—¬ë”° >ã…< ë‹¹ì‹œëˆˆ! 00ì´ì™€ ë‚¨ì€ìƒì„ í•¨ê»˜ë³´ë‚´ê³  ì‹¶ë‹¤êµ¬ ë§í•˜ì—¬ë”°!'},
  {id:2,level:'â˜…â˜…â˜…â˜†â˜†',text:'ìƒì–´ ìƒì–´ ìƒì–´ìƒì–´ ìƒì–´ ìƒì–´(ìƒì–´) ìƒì–´(ìƒì–´) ìƒì–´ìƒì–´ ë¬´ì§€ë¬´ì§€ ë˜ê°•í•˜ê³  ë„ˆë¬´ìµœê³  ìƒì–´â™¥'},
  {id:3,level:'â˜…â˜…â˜…â˜…â˜†',text:'ì˜¤ë¹ ì•„ì•™ ì˜¤ë¹ ë‚˜ ì˜¤ë¹  ìª¼ì•„í–‰~~ ì˜¤ë¹ ë„ ë‚˜ ì¡°ì•™?? ë‚œ ì˜ì›íˆ ì˜¤ë¹  ê³ì— ìˆì„ê¼¬ì–‘ ì˜¤ë¹  ë‚˜ ê¸°ì—½ì§•'},
  {id:4,level:'â˜…â˜…â˜…â˜†â˜†',text:'ì•„ì‰ê³¼ìì‚¬ì£ ëƒ¥_â™¥ ì˜¤ë¹ ë¼ê³  ë¶ˆëŸ¬ë‘ëŒ•? ìŸˆê¸°ì•¼ë½‘í˜¸! ëƒì˜¤ì˜¹ ë‚œ ìê¸°ì˜ ê¼¬ëƒ¥ì´ê°€ ë ë˜ìš”â—‹_â—‹'},
  {id:5,level:'â˜…â˜…â˜…â˜†â˜†',text:'ë‚˜ë¹ ë˜ë‚˜ë¹ ë˜ ë‚˜ë¹ ë˜~ ì´ë”°ë§Œí¼ ë‚˜ë¹ ë˜~ í•˜ëŠ˜ë§Œê¿ˆë•…ë§Œê¿ˆ ë‚˜ë¹ ë˜~ ê·¸ëŸ¬ë‹ˆê¹Œ ì‚¬ì£„í•´'},
  {id:6,level:'â˜…â˜…â˜…â˜…â˜†',text:'ë©ë© ! ì£¼ì¸ë‹˜ì„ ìœ„í•´ì„œë¼ë©´ â™¥ ë©ë©ì´ëŠ¥ ë­ë“± í• ëšœìˆì–´ìš”ë©!â™¥ í—¥í—¥í—¥í—¥~â™¥ ì‚°ì±…ê°€ì­ˆë–¼ì—¬!ë©!â™¥'},
  {id:7,level:'â˜…â˜…â˜…â˜†â˜†',text:'ìê¸°ì•¼ ìê¸°ì•¼ ìš°ë¦¬ìê¸° â—‹â—‹ì´ ì´ˆì½”ìš°ìœ  ë¨¹ê³ ì‹¶ì–´ ì¸„ë¦…~ì¸„ë¦…~ì´ˆì½”ì´ˆì½”~ì´ˆì½”ìš°ìœ ì‚¬ì¤˜~â˜…'},
  {id:8,level:'â˜…â˜…â˜…â˜…â˜…',text:'íŠ¸ìˆ˜ì¿¤ íŠ¸ìˆ˜ì¿¤ 00 ë¶€íƒ ë“¤ì–´ì¤„ ìˆ˜ ìˆëƒ¥? ì–´ì„œ ëˆˆ ë¹¨ë¦¬ ê°ìœ¼ë¼ëƒ¥ ì¸„~í•˜ ë”°ë‘í•´~â™¥'},
  {id:9,level:'â˜…â˜…â˜†â˜†â˜†',text:'ì´ˆì½œë¦¿ ì´ˆì½œë¦¿ ê¹Œë§›ì½” ì…ë§Œì—ì„œ ì‚´ì‚´ ë…¹ëŠ” ì´ˆì½œë¦¿ ë„ˆë¬´ë„ˆë¬´ ë§›ìˆì–´ìš” ê°€ë‚˜ ì´ˆì½œë¦¿ì´ ë„ˆë®¤ë„ˆë®¤ ì¢‹ì•„ìš”'},
  {id:10,level:'â˜…â˜…â˜…â˜†â˜†',text:'ë‹¬ë‹¬ ì´‰ì´‰í•œ 00ì• êµ ë°›ì•„ëŸ‡ ë§ˆì¹´ë¡± ì•— ëŒœë©” ëŒœë©” ì¸„íŒŒì¸•ìŠ¤ ì•— ëŒœë©”ëŒœë©” 00ì´ë¥¼ ì„¸ìƒì—ì„œ ì œì¼ ì‚¬ë‘í•´ì¤˜'},
  {id:11,level:'â˜…â˜…â˜…â˜…â˜†',text:'ì–´ ì˜¤ë¹  ì–´ë””ê°€? ë˜ ë‚˜ ë‘ê³  ì–´ë””ê°€ëŠ”ê±°ì•¼? ì—­ì‹œ ì‹«ì–´! ê°€ì§€ë§ˆ! ìŒ...ë‚œ ì˜¤ë¹ ì˜ ì‚¬ë‘?'},
  {id:12,level:'â˜…â˜…â˜…â˜…â˜†',text:'(ìˆ ì·¨í•œíˆ¬ë¡œ)ì˜¤ë¹ ì•¼~~ ì˜¤ë¹ ëŠ” ë‚´ ì–´ì¼€ ìƒê°í•˜ëŠ”ë°~â™¡ ì˜¤ëŠ˜ë¶€í„° 1ì¼ì´ë°ì´â™¡'},
  {id:13,level:'â˜…â˜…â˜…â˜†â˜†',text:'ë³€ì‹  ê·€ì—½ ë½ì§ 00 ì• êµì™€ ê·€ì—¬ì›€ìœ¼ë¡œ íŠ¸ìˆ˜ë“¤ì˜ ì§€ê°‘ì„ ì‚¬ë¡œì¡ì•„ë²„ë¦¬ê² ì–´ ë¿…â™¥ë¿…â™¥'},
  {id:14,level:'â˜…â˜…â˜…â˜…â˜†',text:'ê°œê»Œ~â™¥ë©ë©ë©~â™¥ ì•„ìŸ‰ì•„ìŸ‰ì•„ì¨–~â™¥ ë§ˆì‹œìª„~â™¥ì¥¬ì‰ë‹˜!â™¥ë©ë©!'},
  {id:15,level:'â˜…â˜…â˜…â˜…â˜…',text:'(ìš¸ë¨¹)ì˜¤..ë¹ ..ì € ì‚¬ëŒë“œë¦¬..00 ê´´ë¡œíˆì–´... 00 ì‚ì§ˆê¼¬ì–Œ! í... OOëš í• ê±°ì•¼...'}
];

const GOLDEN_KEYS=[
  {emoji:'ğŸ‘‘',text:'ì§€ëª©í•œ ì‚¬ëŒ ì• êµ ì‹œí‚¤ê¸°!',type:'aegyo-target'},
  {emoji:'ğŸ¦¸',text:'í‘ê¸°ì‚¬ê¶Œ! ì§€ëª©í•œ ì‚¬ëŒ ëŒ€ì‹  ìŒë£Œ ì„­ì·¨',type:'blackknight'},
  {emoji:'ğŸ¯',text:'ì§€ëª© í­íƒ„! 2ëª…ì—ê²Œ ê°ê° ë²Œì¹™',type:'double-target'},
  {emoji:'ğŸ”„',text:'ìˆœì„œ ì—­ì „! ê²Œì„ ë°©í–¥ ë°”ê¾¸ê¸°',type:'reverse'},
  {emoji:'ğŸ’£',text:'í­íƒ„ ëŒë¦¬ê¸°! 10ì´ˆ ì•ˆì— ë‹¤ìŒ ì‚¬ëŒ ì§€ëª©',type:'bomb'},
  {emoji:'ğŸ­',text:'ì—­í•  êµì²´! ë‹¤ìŒ ì°¨ë¡€ ì‚¬ëŒê³¼ ìœ„ì¹˜ ë°”ê¾¸ê¸°',type:'swap-next'},
  {emoji:'ğŸª',text:'ì„œì»¤ìŠ¤ íƒ€ì„! 30ì´ˆ ì¥ê¸°ìë‘',type:'talent'},
  {emoji:'ğŸ‘»',text:'ë¬´ì¸ë„ ê¹Œë°©ê¶Œ íšë“!',type:'island-skip'},
  {emoji:'ğŸŒŸ',text:'ìŠ¤íƒ€ ë“±ì¥! ëª¨ë‘ê°€ ë‹¹ì‹ ì„ ì¹­ì°¬í•´ì•¼ í•¨',type:'praise'},
  {emoji:'ğŸ¬',text:'ëª…ëŒ€ì‚¬! ì˜í™”/ë“œë¼ë§ˆ ëŒ€ì‚¬ ë”°ë¼í•˜ê¸°',type:'movie-line'},
  {emoji:'ğŸ¤',text:'ë…¸ë˜ë°© íƒ€ì„! 1ì ˆ ë¶€ë¥´ê¸°',type:'sing'},
  {emoji:'ğŸ’€',text:'ë°ìŠ¤ë§¤ì¹˜! ì§€ëª©í•œ ì‚¬ëŒê³¼ ê°€ìœ„ë°”ìœ„ë³´',type:'rps'},
  {emoji:'ğŸ”®',text:'ì˜ˆì–¸ì! ë‹¤ìŒ ì£¼ì‚¬ìœ„ ìˆ«ì ë§ì¶”ê¸°',type:'predict'},
  {emoji:'ğŸ‘¯',text:'ë”°ë¼ìŸì´! ë‹¤ìŒ ì‚¬ëŒì´ ë‹¹ì‹  í–‰ë™ ë”°ë¼í•´ì•¼ í•¨',type:'copycat'},
  {emoji:'ğŸ',text:'ì„ ë¬¼! ì•„ë¬´ í™©ê¸ˆì¹´ë“œ íš¨ê³¼ ì„ íƒ ê°€ëŠ¥',type:'gift'},
  {emoji:'âš¡',text:'ë²ˆê°œ! ëª¨ë‘ ë°•ìˆ˜ 3ë²ˆ, ê¼´ì°Œ ë²Œì¹™',type:'lightning'}
];

const TILES=[
  {id:0,name:"ì¶œë°œ",type:"start",emoji:"ğŸš€",desc:"ì¶œë°œ ì§€ì !"},
  {id:1,name:"ìŒì„±ì±„íŒ…",type:"drink",emoji:"ğŸ™ï¸",desc:"ìŒì„±ì±„íŒ…ì—ì„œ ì¸ì‚¬í•˜ê¸°!"},
  {id:2,name:"ì• êµ ëŒ€ì‚¬",type:"performance",emoji:"ğŸ¥°",desc:"ì• êµ ëŒ€ì‚¬ 1ê°œ!"},
  {id:3,name:"3.6.9",type:"game",emoji:"ğŸ‘",desc:"ë””ìŠ¤ì½”ë“œì—ì„œ 369 ê²Œì„!"},
  {id:4,name:"ì´ˆì„±í€´ì¦ˆ",type:"game",emoji:"ğŸ”¤",desc:"ì±„íŒ…ìœ¼ë¡œ ì´ˆì„±í€´ì¦ˆ!"},
  {id:5,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:6,name:"007",type:"game",emoji:"ğŸ”«",desc:"007ë¹µ!"},
  {id:7,name:"ë¬´ì¸ë„",type:"island",emoji:"ğŸï¸",desc:"1í„´ ì‰¬ì–´ê°€ê¸°!"},
  {id:8,name:"ì´ëª¨í‹°ì½˜",type:"drink",emoji:"ğŸ’¬",desc:"ê°€ì¥ ì›ƒê¸´ ì´ëª¨í‹°ì½˜!"},
  {id:9,name:"ëˆˆì¹˜ê²Œì„",type:"game",emoji:"ğŸ‘€",desc:"ì±„íŒ… ëˆˆì¹˜ê²Œì„!"},
  {id:10,name:"ë’¤ë¡œ 2ì¹¸",type:"move",emoji:"â¬…ï¸",desc:"ë‘ ì¹¸ ë’¤ë¡œ!"},
  {id:11,name:"TMI ê³µê°œ",type:"game",emoji:"ğŸ’¬",desc:"ì˜¤ëŠ˜ì˜ TMI!"},
  {id:12,name:"ì‰¬ì–´ê°€ê¸°",type:"free",emoji:"ğŸ˜´",desc:"ì‰¬ì–´ê°€ì„¸ìš”~"},
  {id:13,name:"ì¹­ì°¬íƒ€ì„",type:"drink",emoji:"ğŸ’•",desc:"ì˜† ì‚¬ëŒ ì¹­ì°¬!"},
  {id:14,name:"ì„±ëŒ€ëª¨ì‚¬",type:"performance",emoji:"ğŸ­",desc:"ì„±ëŒ€ëª¨ì‚¬!"},
  {id:15,name:"ì—…ë‹¤ìš´",type:"game",emoji:"ğŸ”¢",desc:"ìˆ«ì ì—…ë‹¤ìš´!"},
  {id:16,name:"ì§€ëª© ë²Œì¹™",type:"drink",emoji:"ğŸ‘‰",desc:"í•œ ëª… ì§€ëª©!"},
  {id:17,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:18,name:"ì´ëª¨ì§€ì„¤ëª…",type:"performance",emoji:"ğŸ˜‰",desc:"ì´ëª¨ì§€ë¡œ ì˜í™”ì„¤ëª…!"},
  {id:19,name:"ì†ë³‘í˜¸",type:"game",emoji:"âœ‹",desc:"ì†ê°€ë½ ê±¸ê¸°!"},
  {id:20,name:"ì£¼ì‚¬ìœ„ ë”",type:"bonus",emoji:"ğŸ²",desc:"í•œ ë²ˆ ë”!"},
  {id:21,name:"ë°¸ëŸ°ìŠ¤ê²Œì„",type:"drink",emoji:"âš–ï¸",desc:"ë°¸ëŸ°ìŠ¤ ê²Œì„!"},
  {id:22,name:"ëœë¤ì¹­ì°¬",type:"performance",emoji:"ğŸ‘",desc:"ëœë¤ ìœ ì € ì¹­ì°¬!"},
  {id:23,name:"ì•„íŒŒíŠ¸",type:"game",emoji:"ğŸ¢",desc:"ì•„íŒŒíŠ¸ ê²Œì„!"},
  {id:24,name:"ë…¸ë˜ë§ì¶”ê¸°",type:"game",emoji:"ğŸµ",desc:"ë…¸ë˜ 1ì´ˆ ë§ì¶”ê¸°!"},
  {id:25,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:26,name:"í”„ì‚¬ í‰ê°€",type:"drink",emoji:"ğŸ–¼ï¸",desc:"í”„ë¡œí•„ í‰ê°€!"},
  {id:27,name:"ê³ ë°±ì—°ê¸°",type:"performance",emoji:"ğŸ’Œ",desc:"ê³ ë°±ì—°ê¸°!"},
  {id:28,name:"ëœë¤ê²Œì„",type:"game",emoji:"ğŸ°",desc:"ëœë¤ ê²Œì„!"},
  {id:29,name:"ë’¤ë¡œ 3ì¹¸",type:"move",emoji:"âª",desc:"ì„¸ ì¹¸ ë’¤ë¡œ!"},
  {id:30,name:"ë³„ëª…ì§“ê¸°",type:"performance",emoji:"ğŸ˜",desc:"ë³„ëª… ì§€ì–´ì£¼ê¸°!"},
  {id:31,name:"ì²˜ìŒìœ¼ë¡œ",type:"move",emoji:"ğŸ”™",desc:"ì¶œë°œì ìœ¼ë¡œ!"}
];

const LIAR_TOPICS={
  'ìŒì‹':['í”¼ì','ì¹˜í‚¨','í–„ë²„ê±°','ì´ˆë°¥','ë¼ë©´','ë–¡ë³¶ì´','ì‚¼ê²¹ì‚´','ì§œì¥ë©´','ê¹€ì¹˜ì°Œê°œ','ë¶ˆê³ ê¸°'],
  'ë™ë¬¼':['ê°•ì•„ì§€','ê³ ì–‘ì´','ì‚¬ì','í˜¸ë‘ì´','ì½”ë¼ë¦¬','ê¸°ë¦°','í­ê·„','ëŒê³ ë˜','í† ë¼','íŒë‹¤'],
  'ì§ì—…':['ì˜ì‚¬','ì„ ìƒë‹˜','ê²½ì°°ê´€','ì†Œë°©ê´€','ìš”ë¦¬ì‚¬','ë³€í˜¸ì‚¬','ê°€ìˆ˜','ë°°ìš°','í”„ë¡œê·¸ë˜ë¨¸','ìš´ë™ì„ ìˆ˜'],
  'ì¥ì†Œ':['í•™êµ','ë³‘ì›','ê³µì›','ì˜í™”ê´€','ë„ì„œê´€','ë§ˆíŠ¸','ì¹´í˜','í•´ë³€','ë†€ì´ê³µì›','ê³µí•­'],
  'ê²Œì„':['ë¡¤','ë°°ê·¸','ì˜¤ë²„ì›Œì¹˜','ë§ˆì¸í¬ë˜í”„íŠ¸','ë°œë¡œë€íŠ¸','í”¼íŒŒ','ë©”ì´í”Œ','GTA','ì ¤ë‹¤','í¬ì¼“ëª¬'],
  'ë¸Œëœë“œ':['ì‚¼ì„±','ì• í”Œ','ë‚˜ì´í‚¤','ìŠ¤íƒ€ë²…ìŠ¤','ë§¥ë„ë‚ ë“œ','ì½”ì¹´ì½œë¼','êµ¬ê¸€','ë„·í”Œë¦­ìŠ¤','ìœ íŠœë¸Œ','ì•„ë§ˆì¡´']
};

const RANDOM_GAMES=["í›ˆë¯¼ì •ìŒ!","ë”¸ê¸°ê²Œì„!","ì´ˆì„±í€´ì¦ˆ!","ì—…ë‹¤ìš´!","ì§„ì‹¤orê±°ì§“!","ë°•ìˆ˜ì¹˜ê¸°!","ëˆˆì‹¸ì›€!","ì†ë³‘í˜¸!","ì•„íŒŒíŠ¸!"];
const PLAYER_COLORS=['#EAB308','#3B82F6','#22C55E','#EF4444','#A855F7','#F97316','#06B6D4','#EC4899','#84CC16','#F43F5E','#8B5CF6','#14B8A6'];
const ROULETTE_COLORS=['#c53030','#c05621','#b7791f','#276749','#0d9488','#2b6cb0','#6b46c1','#b83280','#c53030','#5a7a23','#0891b2','#7c3aed'];

let state={
  screen:'home',game:null,roomCode:null,odPlyerId:null,playerName:'',room:null,localDice:1,
  showLeave:false,showUpdate:false,showAegyo:false,showRescue:false,
  rouletteSlots:['í•­ëª©1','í•­ëª©2','í•­ëª©3','í•­ëª©4','í•­ëª©5','í•­ëª©6'],
  rouletteAngle:0,rouletteSpinning:false,rouletteResult:null,rouletteResultColor:null,
  liarFlipped:false,liarVote:null,liarGuess:'',liarChatMsg:'',
  hasIslandSkip:false,
  bottleAngle:0,bottleSpinning:false,bottleResult:null,
  rescueVote:null
};
let roomRef=null;

function getValidSlots(){return state.rouletteSlots.filter(s=>s&&s.trim().length>0)}
function genCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}
function getTilePos(idx){const s=8;if(idx<s)return{x:s-idx,y:0};if(idx<s*2)return{x:0,y:idx-s};if(idx<s*3)return{x:idx-s*2,y:s};return{x:s,y:s*4-idx}}
function getOffset(i){const o=[[-10,-10],[10,-10],[-10,10],[10,10],[0,-14],[0,14],[-14,0],[14,0]];return o[i%8]}
function diceDots(v){const d={1:[[50,50]],2:[[30,30],[70,70]],3:[[30,30],[50,50],[70,70]],4:[[30,30],[70,30],[30,70],[70,70]],5:[[30,30],[70,30],[50,50],[30,70],[70,70]],6:[[30,25],[70,25],[30,50],[70,50],[30,75],[70,75]]};return(d[v]||d[1]).map(([x,y])=>'<circle cx="'+x+'" cy="'+y+'" r="8" fill="#1a1a2e"/>').join('')}

function render(){document.getElementById('app').innerHTML=state.screen==='home'?renderHome():state.screen==='lobby'?renderLobby():state.screen==='roulette'?renderRoulette():state.screen==='game'?renderGame():'';bindEvents()}

function renderStars(){return Array(20).fill(0).map(()=>'<div class="star animate-twinkle" style="left:'+Math.random()*100+'%;top:'+Math.random()*100+'%;width:'+(1+Math.random()*2)+'px;height:'+(1+Math.random()*2)+'px;animation-delay:'+Math.random()*3+'s;"></div>').join('')}

function renderHome(){
  return '<div class="min-h-screen bg-party flex flex-col items-center justify-center p-4 relative overflow-hidden">'+renderStars()+'<div class="absolute top-10 left-10 text-6xl opacity-30 animate-float">ğŸ®</div><div class="absolute bottom-10 right-10 text-5xl opacity-20 animate-float-reverse">ğŸ²</div><div class="text-center mb-8 animate-fade-scale relative z-10"><h1 class="title-font text-5xl sm:text-6xl lg:text-7xl text-white mb-2" style="text-shadow:0 0 40px rgba(99,102,241,0.6);">ğŸ® íŒŒí‹°ê²Œì„ ğŸ®</h1><p class="text-lg text-indigo-200">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì˜¨ë¼ì¸ íŒŒí‹°ê²Œì„!</p></div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl w-full relative z-10">'+GAMES.map((g,i)=>'<div data-action="select-game" data-game="'+g.id+'" class="game-card rounded-2xl p-4 cursor-pointer animate-slide-up" style="animation-delay:'+i*0.1+'s;--glow:'+g.glow+'"><div class="text-5xl mb-3">'+g.emoji+'</div><h3 class="title-font text-xl text-white mb-1">'+g.name+'</h3><p class="text-white/60 text-xs mb-2">'+g.desc+'</p><span class="inline-block px-2 py-0.5 rounded-full text-xs font-bold bg-gradient-to-r '+g.color+' text-white">'+(g.solo?'ì†”ë¡œ':g.min+'-'+g.max+'ëª…')+'</span></div>').join('')+'</div><button data-action="show-update" class="fixed bottom-4 right-4 btn-ghost text-white/50 hover:text-white px-4 py-2 rounded-xl text-sm">ğŸ“‹ ì—…ë°ì´íŠ¸</button>'+(state.showUpdate?renderUpdateModal():'')+'</div>'}

function renderUpdateModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" data-action="close-update"><div class="card-dark rounded-2xl p-6 max-w-lg w-full animate-bounce-in" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">ğŸ“‹ ì—…ë°ì´íŠ¸ ë‚´ì—­</h3><button data-action="close-update" class="text-white/50 hover:text-white text-2xl">&times;</button></div><div class="update-scroll space-y-4">'+UPDATE_LOGS.map(l=>'<div class="border-l-4 border-indigo-500 pl-4"><div class="flex items-center gap-2 mb-2"><span class="text-indigo-400 font-bold">'+l.version+'</span><span class="text-white/50 text-sm">'+l.date+'</span></div><ul class="space-y-1">'+l.changes.map(c=>'<li class="text-white/80 text-sm">'+c+'</li>').join('')+'</ul></div>').join('')+'</div></div></div>'}

function renderAegyoModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" data-action="close-aegyo"><div class="card-wood rounded-2xl p-6 max-w-xl w-full animate-bounce-in" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-amber-100">ğŸ’• ì• êµëŒ€ì‚¬ ëª¨ìŒì§‘</h3><button data-action="close-aegyo" class="text-amber-200/50 hover:text-amber-100 text-2xl">&times;</button></div><div class="aegyo-scroll space-y-2">'+AEGYO_LIST.map(a=>'<div class="bg-black/30 rounded-xl p-3"><div class="flex items-center gap-2 mb-1"><span class="text-amber-400 font-bold text-sm">'+a.id+'ë²ˆ</span><span class="text-yellow-300 text-xs">'+a.level+'</span></div><p class="text-amber-100 text-sm">'+a.text+'</p></div>').join('')+'</div></div></div>'}

function renderLobby(){
  const g=state.game;if(!g)return'';
  const colors=g.id==='jurumarble'?{bg:'bg-beer',btn:'btn-beer',input:'input-beer'}:g.id==='liar'?{bg:'bg-liar',btn:'btn-liar',input:'input-liar'}:g.id==='truth'?{bg:'bg-truth',btn:'btn-truth',input:'input-truth'}:{bg:'bg-party',btn:'btn-primary',input:'input-dark'};
  if(!state.room){
    return '<div class="min-h-screen '+colors.bg+' flex items-center justify-center p-4"><div class="card-dark rounded-3xl p-8 w-full max-w-md animate-fade-scale"><button data-action="go-home" class="btn-ghost text-white/70 px-3 py-1 rounded-lg mb-4">â† ë’¤ë¡œ</button><div class="text-center mb-6"><span class="text-5xl">'+g.emoji+'</span><h2 class="title-font text-3xl text-white mt-2">'+g.name+'</h2></div><div class="mb-4"><label class="block text-white/70 text-sm mb-2">ë‹‰ë„¤ì„</label><input type="text" id="pname" maxlength="8" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" class="'+colors.input+' w-full px-4 py-3 rounded-xl text-lg"></div><div class="mb-6"><label class="block text-white/70 text-sm mb-2">ë°© ì½”ë“œ (ì°¸ê°€ì‹œ)</label><input type="text" id="rcode" maxlength="6" placeholder="ì—†ìœ¼ë©´ ìƒˆ ë°© ìƒì„±" class="'+colors.input+' w-full px-4 py-3 rounded-xl text-center tracking-widest uppercase"></div><button data-action="join-or-create" class="'+colors.btn+' w-full text-white text-xl font-bold py-4 rounded-2xl">ğŸ® ì…ì¥í•˜ê¸°</button></div></div>'}
  const players=Object.values(state.room.players||{}).sort((a,b)=>a.order-b.order);
  const isHost=state.room.hostId===state.odPlyerId;
  const canStart=players.length>=g.min;
  return '<div class="min-h-screen '+colors.bg+' p-4"><div class="max-w-2xl mx-auto"><div class="card-dark rounded-3xl p-6 animate-fade-scale"><div class="flex justify-between items-center mb-4"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg">ğŸšª ë‚˜ê°€ê¸°</button><div class="text-center flex-1"><span class="text-4xl">'+g.emoji+'</span><h2 class="title-font text-2xl text-white">'+g.name+'</h2></div><div class="w-20"></div></div><div class="bg-black/30 rounded-2xl p-4 mb-4 text-center"><p class="text-white/50 text-sm">ë°© ì½”ë“œ</p><p class="title-font text-4xl text-white tracking-wider">'+state.roomCode+'</p><button data-action="copy-code" class="mt-2 text-indigo-400 text-sm">ğŸ“‹ ë³µì‚¬</button></div><div class="mb-4"><p class="text-white/70 text-sm mb-2">í”Œë ˆì´ì–´ ('+players.length+'/'+g.max+')</p><div class="grid grid-cols-2 gap-2">'+players.map((p,i)=>'<div class="player-item flex items-center gap-2 bg-black/20 rounded-xl p-2 '+(p.id===state.odPlyerId?'ring-2 ring-indigo-500':'')+'"><div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" style="background:'+PLAYER_COLORS[i]+'">'+p.name[0]+'</div><span class="flex-1 text-white text-sm truncate">'+p.name+'</span>'+(p.id===state.room.hostId?'<span class="text-yellow-400 text-xs">ğŸ‘‘</span>':'')+(isHost&&p.id!==state.odPlyerId?'<button data-action="kick" data-pid="'+p.id+'" class="kick-btn text-red-400 text-xs px-2 py-1 rounded hover:bg-red-500/20">ì¶”ë°©</button>':'')+'</div>').join('')+'</div></div>'+(isHost?'<button data-action="start-game" '+(canStart?'':'disabled')+' class="'+colors.btn+' w-full text-white text-xl font-bold py-4 rounded-2xl '+(canStart?'':'opacity-50 cursor-not-allowed')+'">'+(canStart?'ğŸ® ê²Œì„ ì‹œì‘':'â³ '+g.min+'ëª… ì´ìƒ í•„ìš”')+'</button>':'<div class="text-center text-white/50 py-4">í˜¸ìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...</div>')+'</div></div>'+(state.showLeave?renderLeaveModal():'')+'</div>'}

function renderRoulette(){
  const validSlots=getValidSlots();const validCount=validSlots.length;const canSpin=!state.rouletteSpinning&&validCount>=2;const segAngle=validCount>0?360/validCount:360;
  return '<div class="min-h-screen bg-roulette p-4 relative overflow-hidden">'+renderStars()+'<div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-6"><button data-action="go-home" class="btn-ghost text-white/70 px-4 py-2 rounded-xl">â† ë’¤ë¡œ</button><h1 class="title-font text-3xl text-purple-400 flex-1 text-center">ğŸ¡ ë£°ë › ğŸ¡</h1><div class="w-16"></div></div><div class="flex flex-col lg:flex-row gap-6 items-center"><div class="relative flex flex-col items-center"><div class="absolute -top-3 left-1/2 -translate-x-1/2 z-20 text-4xl" style="filter:drop-shadow(0 0 15px rgba(255,255,255,0.9));">â–¼</div><div class="relative w-72 h-72 lg:w-80 lg:h-80"><svg viewBox="0 0 200 200" class="roulette-wheel w-full h-full" id="roulette-wheel" style="transform:rotate('+state.rouletteAngle+'deg)"><circle cx="100" cy="100" r="98" fill="#1a1a2e" stroke="#6b21a8" stroke-width="4"/>'+(validCount>0?validSlots.map((s,i)=>{const st=i*segAngle-90,en=st+segAngle,la=segAngle>180?1:0;const x1=100+95*Math.cos(st*Math.PI/180),y1=100+95*Math.sin(st*Math.PI/180),x2=100+95*Math.cos(en*Math.PI/180),y2=100+95*Math.sin(en*Math.PI/180);const ma=(st+segAngle/2)*Math.PI/180,tx=100+60*Math.cos(ma),ty=100+60*Math.sin(ma);return'<path d="M100,100 L'+x1+','+y1+' A95,95 0 '+la+',1 '+x2+','+y2+' Z" fill="'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'" stroke="#1a1a2e" stroke-width="1"/><text x="'+tx+'" y="'+ty+'" fill="white" font-size="'+(validCount>8?8:10)+'" font-weight="bold" text-anchor="middle" dominant-baseline="middle" transform="rotate('+(st+segAngle/2+90)+','+tx+','+ty+')">'+(s.length>6?s.slice(0,6)+'â€¦':s)+'</text>'}).join(''):'<text x="100" y="100" fill="white" font-size="12" text-anchor="middle">í•­ëª© ì…ë ¥</text>')+'<circle cx="100" cy="100" r="22" fill="#2d1b4e" stroke="#9333ea" stroke-width="3"/><circle cx="100" cy="100" r="10" fill="#a855f7"/></svg></div><div class="mt-4 w-full text-center min-h-[70px] flex items-center justify-center">'+(state.rouletteResult?'<div class="animate-result-pop"><p class="text-purple-300 text-sm mb-1">ğŸ‰ ë‹¹ì²¨! ğŸ‰</p><p class="title-font text-2xl animate-winner" style="color:'+state.rouletteResultColor+'">'+state.rouletteResult+'</p></div>':'<p class="text-white/30 text-sm">'+(state.rouletteSpinning?'ğŸŒ€ ëŒì•„ê°€ëŠ” ì¤‘...':'ê²°ê³¼ í‘œì‹œ')+'</p>')+'</div><button data-action="spin" '+(canSpin?'':'disabled')+' class="mt-2 w-full btn-purple text-white text-lg font-bold py-3 rounded-2xl '+(canSpin?'':'opacity-50 cursor-not-allowed')+'">'+(state.rouletteSpinning?'ğŸŒ€ ëŒì•„ê°€ëŠ” ì¤‘...':'ğŸ¯ ëŒë¦¬ê¸°!')+'</button></div><div class="card-purple rounded-2xl p-4 flex-1 w-full max-w-md"><h3 class="text-purple-300 font-bold mb-3" id="slot-count">ğŸ° í•­ëª© ('+validCount+'ê°œ)</h3><div class="space-y-2 max-h-56 overflow-y-auto mb-3">'+state.rouletteSlots.map((s,i)=>'<div class="flex gap-2 items-center"><div class="w-3 h-3 rounded" style="background:'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'"></div><input type="text" data-slot="'+i+'" value="'+s+'" placeholder="í•­ëª© '+(i+1)+'" class="input-dark flex-1 px-3 py-2 rounded-lg text-sm"><button data-action="remove-slot" data-idx="'+i+'" class="text-red-400 px-2 '+(state.rouletteSlots.length<=2?'opacity-30':'')+'">âœ•</button></div>').join('')+'</div><button data-action="add-slot" class="w-full btn-secondary text-purple-300 py-2 rounded-xl">+ í•­ëª© ì¶”ê°€</button></div></div></div></div>'}

function renderGame(){
  if(!state.room)return'';
  if(state.game?.id==='liar')return renderLiarGame();
  if(state.game?.id==='truth')return renderTruthGame();
  return renderJurumarble();
}

function renderTruthGame(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const isHost=room.hostId===state.odPlyerId;
  const tableRadius=120,playerRadius=30;
  const angleStep=360/players.length;
  
  return '<div class="min-h-screen bg-truth p-4 relative overflow-hidden">'+renderStars()+'<div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-4"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg">ğŸšª</button><h1 class="title-font text-3xl text-cyan-400 flex-1 text-center">ğŸ¾ ì§„ì‹¤ê²Œì„ ğŸ¾</h1><div class="text-white/30 text-sm w-20 text-right">'+state.roomCode+'</div></div><div class="flex flex-col items-center"><div class="relative" style="width:300px;height:300px;"><div class="absolute inset-0 rounded-full bg-gradient-to-br from-amber-900 to-amber-950 border-8 border-amber-800 shadow-2xl" style="box-shadow:inset 0 10px 30px rgba(0,0,0,0.5),0 10px 30px rgba(0,0,0,0.3);"></div>'+players.map((p,i)=>{const angle=(angleStep*i-90)*Math.PI/180;const x=150+tableRadius*Math.cos(angle)-playerRadius;const y=150+tableRadius*Math.sin(angle)-playerRadius;const pIdx=players.findIndex(pl=>pl.id===p.id);return'<div class="absolute flex flex-col items-center" style="left:'+x+'px;top:'+y+'px;width:'+(playerRadius*2)+'px;"><div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold player-token '+(room.bottleTarget===p.id?'ring-4 ring-cyan-400 animate-winner':'')+'" style="background:'+PLAYER_COLORS[pIdx]+'">'+p.name[0]+'</div><span class="text-white text-xs mt-1 truncate w-full text-center">'+p.name+'</span></div>'}).join('')+'<div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"><svg width="80" height="80" viewBox="0 0 80 80" class="'+(state.bottleSpinning?'bottle-spin':'')+'" style="--spin-deg:'+(state.bottleAngle||0)+'deg;transform:rotate('+state.bottleAngle+'deg);"><defs><linearGradient id="bottleGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#166534"/><stop offset="50%" style="stop-color:#22c55e"/><stop offset="100%" style="stop-color:#166534"/></linearGradient></defs><ellipse cx="40" cy="60" rx="12" ry="15" fill="url(#bottleGrad)" stroke="#14532d" stroke-width="2"/><rect x="36" y="20" width="8" height="40" fill="url(#bottleGrad)" stroke="#14532d" stroke-width="1"/><ellipse cx="40" cy="20" rx="6" ry="4" fill="#166534" stroke="#14532d" stroke-width="1"/><polygon points="40,5 36,20 44,20" fill="#dc2626"/></svg></div></div><div class="mt-6 text-center min-h-[80px]">'+(room.bottleTarget?'<div class="animate-result-pop"><p class="text-cyan-300 text-lg mb-2">ğŸ¯ ê±¸ë¦° ì‚¬ëŒ!</p><p class="title-font text-4xl text-white animate-winner">'+players.find(p=>p.id===room.bottleTarget)?.name+'</p></div>':(state.bottleSpinning?'<p class="text-cyan-300 text-lg">ğŸŒ€ ëŒì•„ê°€ëŠ” ì¤‘...</p>':'<p class="text-white/40">ì†Œì£¼ë³‘ì„ ëŒë ¤ì£¼ì„¸ìš”!</p>'))+'</div>'+(isHost?'<button data-action="spin-bottle" '+(state.bottleSpinning||room.bottleTarget?'disabled':'')+' class="mt-4 btn-truth text-white text-xl font-bold py-4 px-12 rounded-2xl '+(state.bottleSpinning||room.bottleTarget?'opacity-50 cursor-not-allowed':'')+'">ğŸ¾ ì†Œì£¼ë³‘ ëŒë¦¬ê¸°!</button>':'<p class="text-white/50 mt-4">í˜¸ìŠ¤íŠ¸ê°€ ëŒë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>')+(room.bottleTarget&&isHost?'<button data-action="reset-bottle" class="mt-3 btn-secondary text-cyan-300 py-2 px-6 rounded-xl">ğŸ”„ ë‹¤ì‹œ ëŒë¦¬ê¸°</button>':'')+'</div></div>'+(state.showLeave?renderLeaveModal():'')+'</div>'}

function renderJurumarble(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const curr=players[room.turn%players.length];
  const isMyTurn=curr?.id===state.odPlyerId;
  const isHost=room.hostId===state.odPlyerId;
  const sz=70,gap=2,side=8,bsz=(side+1)*(sz+gap)+20;
  const finishedCount=players.filter(p=>p.finished).length;
  const gameEnded=finishedCount>=players.length-1;
  
  return '<div class="min-h-screen bg-beer p-2 relative overflow-hidden"><div class="max-w-6xl mx-auto relative z-10"><div class="flex justify-between items-center mb-2 px-2"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg text-sm">ğŸšª</button><h1 class="title-font text-2xl text-amber-400 flex-1 text-center">ğŸº ì£¼ë£¨ë§ˆë¸”</h1><div class="text-amber-300/50 text-xs">'+state.roomCode+'</div></div>'+(gameEnded?renderGameEndModal(players):'')+'<div class="flex flex-col xl:flex-row gap-3 items-center justify-center"><div class="relative rounded-2xl p-2 overflow-auto" style="min-width:'+bsz+'px;min-height:'+bsz+'px;background:linear-gradient(145deg,#4a3525,#3a2a1a);box-shadow:inset 0 2px 10px rgba(0,0,0,0.5);">'+TILES.map((t,idx)=>{const pos=getTilePos(idx),here=players.filter(p=>p.position===idx&&!p.finished);return'<div class="absolute rounded-lg flex flex-col items-center justify-center tile-'+t.type+' border border-white/20 shadow-lg" style="width:'+sz+'px;height:'+sz+'px;left:'+(pos.x*(sz+gap)+10)+'px;top:'+(pos.y*(sz+gap)+10)+'px;"><span class="text-base">'+t.emoji+'</span><span class="text-[8px] font-bold text-white text-center px-0.5 drop-shadow leading-tight">'+t.name+'</span>'+here.map((p,pi)=>{const pIdx=players.findIndex(pl=>pl.id===p.id);const[ox,oy]=getOffset(pi);return'<div class="absolute w-6 h-6 rounded-full flex items-center justify-center text-[8px] font-bold text-white player-token '+(room.lastAction?.playerId===p.id?'animate-move':'')+'" style="background-color:'+PLAYER_COLORS[pIdx]+';transform:translate('+ox+'px,'+oy+'px);z-index:10;">'+p.name[0]+'</div>'}).join('')+'</div>'}).join('')+'</div><div class="card-wood rounded-2xl p-3 w-full xl:w-64"><div class="text-center mb-3 p-3 rounded-xl '+(isMyTurn?'bg-amber-500/30 ring-2 ring-amber-400':'bg-black/20')+'"><p class="text-amber-300/70 text-xs mb-1">í˜„ì¬ ì°¨ë¡€</p><p class="text-xl font-black '+(isMyTurn?'text-amber-400':'text-amber-100')+'">'+(curr?.name||'')+(curr?.finished?' âœ…':'')+'</p>'+(isMyTurn&&!curr?.finished?'<p class="text-amber-400 text-xs mt-1">ğŸ² ì£¼ì‚¬ìœ„!</p>':'')+'</div><div class="flex justify-center mb-3"><button data-action="roll-dice" '+(!isMyTurn||room.rolling||curr?.finished?'disabled':'')+' class="relative w-16 h-16 bg-gradient-to-br from-amber-100 to-amber-200 rounded-xl shadow-xl border-4 '+(isMyTurn&&!room.rolling&&!curr?.finished?'border-amber-500 hover:scale-110 cursor-pointer':'border-gray-600 opacity-50 cursor-not-allowed')+' transition-all '+(room.rolling?'animate-dice-roll':'')+'"><svg viewBox="0 0 100 100" class="w-full h-full p-1">'+diceDots(state.localDice)+'</svg></button></div>'+(state.hasIslandSkip?'<div class="bg-cyan-500/20 rounded-lg p-2 mb-2 text-center"><span class="text-cyan-300 text-xs">ğŸï¸ ê¹Œë°©ê¶Œ ë³´ìœ !</span></div>':'')+'<div class="border-t border-amber-700/30 pt-2"><div class="flex justify-between items-center mb-1"><p class="text-amber-300/70 text-xs">í”Œë ˆì´ì–´</p><p class="text-green-400 text-xs">ì™„ì£¼: '+finishedCount+'/'+players.length+'</p></div><div class="grid grid-cols-2 gap-1 max-h-28 overflow-y-auto">'+players.map((p,i)=>'<div class="flex items-center gap-1 px-1 py-0.5 rounded '+(p.id===curr?.id?'bg-amber-500/20':'bg-black/20')+' '+(p.finished?'opacity-50':'')+'"><div class="w-4 h-4 rounded-full text-[8px] font-bold text-white flex items-center justify-center" style="background:'+PLAYER_COLORS[i]+'">'+p.name[0]+'</div><span class="text-[10px] text-amber-100 truncate flex-1">'+p.name+'</span>'+(p.finished?'<span class="text-green-400 text-[8px]">âœ…</span>':'')+(p.islandTurn>0?'<span class="text-cyan-400 text-[8px]">ğŸï¸</span>':'')+'</div>').join('')+'</div></div><button data-action="show-aegyo" class="mt-2 w-full btn-secondary text-amber-300 py-2 rounded-xl text-sm">ğŸ’• ì• êµëŒ€ì‚¬</button></div></div></div>'+(room.showMission?renderMissionModal():'')+(room.rescueVoting?renderRescueModal():'')+(state.showLeave?renderLeaveModal():'')+(state.showAegyo?renderAegyoModal():'')+'</div>'}

function renderGameEndModal(players){
  const finished=players.filter(p=>p.finished).sort((a,b)=>a.finishOrder-b.finishOrder);
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-golden rounded-3xl p-6 max-w-md w-full animate-bounce-in text-center"><div class="text-6xl mb-4">ğŸ†</div><h3 class="title-font text-3xl text-amber-900 mb-4">ê²Œì„ ì¢…ë£Œ!</h3><div class="space-y-2 mb-6">'+finished.map((p,i)=>{const pIdx=players.findIndex(pl=>pl.id===p.id);return'<div class="flex items-center gap-3 bg-amber-100/50 rounded-xl p-2"><span class="text-2xl">'+(i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'ğŸ–ï¸')+'</span><div class="w-8 h-8 rounded-full" style="background:'+PLAYER_COLORS[pIdx]+'"></div><span class="font-bold text-amber-900">'+p.name+'</span></div>'}).join('')+'</div><button data-action="go-home" class="bg-amber-700 text-white font-bold py-3 px-8 rounded-xl">í™ˆìœ¼ë¡œ</button></div></div>'}

function renderRescueModal(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const targetPlayer=players.find(p=>p.id===room.rescueTarget);
  const votes=room.rescueVotes||{};
  const voteCount=Object.keys(votes).length;
  const eligibleVoters=players.filter(p=>p.id!==room.rescueTarget&&!p.finished).length;
  const yesVotes=Object.values(votes).filter(v=>v===true).length;
  const noVotes=Object.values(votes).filter(v=>v===false).length;
  const myVote=votes[state.odPlyerId];
  const canVote=state.odPlyerId!==room.rescueTarget&&!players.find(p=>p.id===state.odPlyerId)?.finished;
  
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-wood rounded-3xl p-6 max-w-md w-full animate-bounce-in text-center"><div class="text-5xl mb-3">ğŸ†˜</div><h3 class="title-font text-2xl text-amber-100 mb-2">êµ¬ì› íˆ¬í‘œ</h3><p class="text-amber-200 mb-4"><strong class="text-amber-400">'+(targetPlayer?.name||'?')+'</strong>ë‹˜ì„<br/>ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ëŠ” ê²ƒì—ì„œ<br/>êµ¬ì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p><p class="text-amber-300/70 text-sm mb-4">íˆ¬í‘œ í˜„í™©: '+voteCount+'/'+eligibleVoters+'</p><div class="flex justify-center gap-8 mb-4"><div class="text-center"><div class="text-3xl font-bold text-green-400">'+yesVotes+'</div><div class="text-green-300 text-sm">ì°¬ì„±</div></div><div class="text-center"><div class="text-3xl font-bold text-red-400">'+noVotes+'</div><div class="text-red-300 text-sm">ë°˜ëŒ€</div></div></div>'+(canVote&&myVote===undefined?'<div class="flex gap-3"><button data-action="rescue-vote" data-vote="yes" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl">âœ… êµ¬ì›</button><button data-action="rescue-vote" data-vote="no" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-xl">âŒ ê¸°ê°</button></div>':'<p class="text-amber-300/70">'+(myVote!==undefined?'íˆ¬í‘œ ì™„ë£Œ! ê²°ê³¼ ëŒ€ê¸° ì¤‘...':'íˆ¬í‘œ ìê²©ì´ ì—†ìŠµë‹ˆë‹¤')+'</p>')+'</div></div>'}

function renderMissionModal(){
  const room=state.room,tile=TILES.find(t=>t.id===room.currentTileId);if(!tile)return'';
  const players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const curr=players[room.turn%players.length];
  const isMyTurn=curr?.id===state.odPlyerId;
  if(room.goldenKey){
    const gk=GOLDEN_KEYS.find(k=>k.type===room.goldenKey);
    return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-golden rounded-3xl p-6 max-w-sm w-full animate-bounce-in animate-golden-glow text-center"><div class="text-6xl mb-4">'+(gk?.emoji||'ğŸ”‘')+'</div><h3 class="title-font text-2xl text-amber-900 mb-2">ğŸ”‘ í™©ê¸ˆì—´ì‡ ! ğŸ”‘</h3><p class="text-amber-800 text-lg mb-4 font-bold">'+(gk?.text||'íŠ¹ë³„!')+'</p>'+(isMyTurn?'<button data-action="close-mission" class="bg-amber-700 text-white font-bold py-3 px-8 rounded-xl">í™•ì¸</button>':'<div class="text-amber-800/70 py-3">'+curr?.name+' í™•ì¸ ì¤‘...</div>')+'</div></div>'}
  if(tile.type==='island'&&!state.hasIslandSkip){
    return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="bg-gradient-to-b from-cyan-600 to-blue-800 rounded-3xl p-6 max-w-sm w-full animate-bounce-in text-center border-4 border-cyan-400"><div class="text-6xl mb-4">ğŸï¸</div><h3 class="title-font text-2xl text-white mb-2">ë¬´ì¸ë„!</h3><p class="text-cyan-100 mb-4">ì´ë²ˆ í„´ì€ ì‰¬ì–´ê°‘ë‹ˆë‹¤</p>'+(isMyTurn?'<button data-action="close-mission" class="bg-cyan-500 text-white font-bold py-3 px-8 rounded-xl">í™•ì¸</button>':'<div class="text-cyan-200/70 py-3">'+curr?.name+' í™•ì¸ ì¤‘...</div>')+'</div></div>'}
  const randomGame=tile.type==='game'&&tile.id===28?RANDOM_GAMES[Math.floor(Math.random()*RANDOM_GAMES.length)]:'';
  const aegyo=tile.id===2?AEGYO_LIST[Math.floor(Math.random()*AEGYO_LIST.length)]:null;
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-wood rounded-3xl p-6 max-w-sm w-full animate-bounce-in text-center"><div class="text-5xl mb-4">'+tile.emoji+'</div><h3 class="title-font text-2xl text-amber-100 mb-2">'+tile.name+'</h3><p class="text-amber-200 mb-4">'+(randomGame||tile.desc)+'</p>'+(aegyo?'<div class="bg-black/30 rounded-xl p-3 mb-4 text-left max-h-32 overflow-y-auto"><p class="text-amber-300 text-xs mb-1">'+aegyo.id+'ë²ˆ '+aegyo.level+'</p><p class="text-amber-100 text-sm">'+aegyo.text+'</p></div>':'')+(isMyTurn?'<button data-action="close-mission" class="btn-beer text-white font-bold py-3 px-8 rounded-xl">í™•ì¸</button>':'<div class="text-amber-300/70 py-3">'+curr?.name+' í™•ì¸ ì¤‘...</div>')+'</div></div>'}

function renderLiarGame(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const isLiar=room.liarId===state.odPlyerId,phase=room.phase;
  const isHost=room.hostId===state.odPlyerId;
  let content='';
  if(phase==='role')content=renderLiarRole(room,players,isLiar,isHost);
  else if(phase==='discuss')content=renderLiarDiscuss(room,players,isLiar,isHost);
  else if(phase==='vote')content=renderLiarVote(room,players,isHost);
  else if(phase==='reveal')content=renderLiarReveal(room,players);
  else if(phase==='result')content=renderLiarResult(room,players,isHost);
  return '<div class="min-h-screen bg-liar p-4 relative overflow-hidden">'+renderStars()+'<div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-4"><button data-action="show-leave" class="btn-ghost px-3 py-1 text-red-400 rounded-xl">ğŸšª</button><h1 class="title-font text-3xl text-red-400 flex-1 text-center">ğŸ­ ë¼ì´ì–´ ê²Œì„ ğŸ­</h1><div class="text-white/30 text-sm w-20 text-right">'+state.roomCode+'</div></div>'+content+'</div>'+(state.showLeave?renderLeaveModal():'')+'</div>'}

function renderLiarChat(room,players){
  const chats=Object.values(room.chats||{}).sort((a,b)=>a.time-b.time);
  return '<div class="card-liar rounded-2xl p-3 mt-4"><h4 class="text-red-300 text-sm font-bold mb-2">ğŸ’¬ ì±„íŒ…</h4><div class="chat-box bg-black/30 rounded-xl p-2 mb-2 h-32 overflow-y-auto" id="chat-box">'+chats.map(c=>{const p=players.find(pl=>pl.id===c.pid);const pIdx=players.findIndex(pl=>pl.id===c.pid);return'<div class="flex items-start gap-2 mb-1"><span class="text-xs font-bold" style="color:'+PLAYER_COLORS[pIdx]+'">'+((p?.name)||'?')+':</span><span class="text-white text-xs">'+c.msg+'</span></div>'}).join('')+'</div><div class="flex gap-2"><input type="text" id="liar-chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." class="input-liar flex-1 px-3 py-2 rounded-lg text-sm" maxlength="100"><button data-action="send-chat" class="btn-liar px-4 py-2 rounded-lg text-sm">ì „ì†¡</button></div></div>'}

function renderLiarRole(room,players,isLiar,isHost){
  const flippedPlayers=room.flippedPlayers||{};
  const allFlipped=players.every(p=>flippedPlayers[p.id]);
  const myFlipped=flippedPlayers[state.odPlyerId]||state.liarFlipped;
  return '<div class="text-center"><p class="text-white/70 mb-3">ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ì—­í• ì„ í™•ì¸í•˜ì„¸ìš”!</p><div class="flex justify-center mb-4"><div class="liar-card-container w-40 h-56 cursor-pointer" data-action="flip-card"><div class="liar-card-inner w-full h-full '+(myFlipped?'flipped':'')+'"><div class="liar-card-front bg-gradient-to-br from-gray-700 to-gray-900 border-4 border-gray-600 flex items-center justify-center shadow-2xl"><span class="text-5xl">â“</span></div><div class="liar-card-back '+(isLiar?'bg-gradient-to-br from-red-600 to-red-900 border-red-500':'bg-gradient-to-br from-blue-600 to-blue-900 border-blue-500')+' border-4 flex flex-col items-center justify-center shadow-2xl p-3"><span class="text-4xl mb-2">'+(isLiar?'ğŸ¤¥':'ğŸ˜‡')+'</span><p class="text-xl font-black text-white mb-1">'+(isLiar?'ë¼ì´ì–´':'ì‹œë¯¼')+'</p>'+(!isLiar?'<div class="bg-black/30 rounded-lg px-3 py-1 w-full"><p class="text-white/70 text-xs">'+room.topic+'</p><p class="text-white text-lg font-bold">'+room.word+'</p></div>':'<p class="text-red-200 text-xs">ì œì‹œì–´ ëª¨ë¦„!</p>')+'</div></div></div></div><div class="card-liar rounded-2xl p-3 mb-4 max-w-sm mx-auto"><p class="text-white/70 text-xs mb-2">í™•ì¸ ('+Object.keys(flippedPlayers).length+'/'+players.length+')</p><div class="flex flex-wrap justify-center gap-1">'+players.map((p,i)=>'<div class="flex items-center gap-1 '+(flippedPlayers[p.id]?'bg-green-500/20':'bg-black/30')+' rounded-full px-2 py-0.5"><div class="w-4 h-4 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><span class="text-white text-xs">'+p.name+'</span>'+(flippedPlayers[p.id]?'<span class="text-green-400 text-xs">âœ“</span>':'')+'</div>').join('')+'</div></div>'+(isHost?'<button data-action="start-discuss" '+(allFlipped?'':'disabled')+' class="btn-liar text-white text-lg font-bold py-3 px-6 rounded-2xl '+(allFlipped?'':'opacity-50 cursor-not-allowed')+'">ğŸ’¬ í† ë¡  ì‹œì‘ '+(allFlipped?'':'('+(players.length-Object.keys(flippedPlayers).length)+'ëª… ëŒ€ê¸°)')+'</button>':'<p class="text-white/50 text-sm">'+(allFlipped?'í˜¸ìŠ¤íŠ¸ ëŒ€ê¸°...':'ëª¨ë‘ í™•ì¸ í•„ìš”')+'</p>')+'</div>'}

function renderLiarDiscuss(room,players,isLiar,isHost){
  return '<div><div class="card-liar rounded-2xl p-4 mb-4 max-w-lg mx-auto text-center"><div class="text-3xl mb-2">ğŸ’¬</div><p class="text-red-400 text-xl font-bold mb-2">í† ë¡  ì‹œê°„!</p><div class="bg-black/30 rounded-xl p-3 mb-3"><p class="text-white/50 text-sm">ì£¼ì œ</p><p class="text-white text-2xl font-bold">'+room.topic+'</p>'+(!isLiar?'<p class="text-green-400 mt-1">ì œì‹œì–´: <strong>'+room.word+'</strong></p>':'<p class="text-red-400 mt-1 text-sm">ğŸ¤¥ ë‹¹ì‹ ì€ ë¼ì´ì–´!</p>')+'</div><div class="flex flex-wrap justify-center gap-1 mb-3">'+players.map((p,i)=>'<div class="flex items-center gap-1 bg-black/20 rounded-full px-2 py-0.5"><span class="text-white/50 text-xs">'+(i+1)+'.</span><div class="w-3 h-3 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><span class="text-white text-xs">'+p.name+'</span></div>').join('')+'</div>'+(isHost?'<button data-action="start-vote" class="btn-liar text-white font-bold py-2 px-6 rounded-xl">ğŸ—³ï¸ íˆ¬í‘œ ì‹œì‘</button>':'')+'</div>'+renderLiarChat(room,players)+'</div>'}

function renderLiarVote(room,players,isHost){
  const myVote=state.liarVote;const votes=room.votes||{};const voteCount=Object.keys(votes).length;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-4 mb-4 max-w-lg mx-auto"><div class="text-3xl mb-2">ğŸ—³ï¸</div><p class="text-red-400 text-xl font-bold mb-2">íˆ¬í‘œ!</p><p class="text-white/50 text-sm mb-3">'+voteCount+'/'+players.length+'</p><div class="grid grid-cols-3 gap-2">'+players.map((p,i)=>'<button data-action="vote" data-target="'+p.id+'" '+(p.id===state.odPlyerId?'disabled':'')+' class="p-2 rounded-xl border-2 '+(myVote===p.id||votes[state.odPlyerId]===p.id?'bg-red-500/30 border-red-500':'bg-black/30 border-white/20 hover:border-red-500/50')+' '+(p.id===state.odPlyerId?'opacity-40':'')+'"><div class="w-8 h-8 rounded-full mx-auto mb-1" style="background:'+PLAYER_COLORS[i]+'"></div><p class="text-white text-xs">'+p.name+'</p>'+(myVote===p.id||votes[state.odPlyerId]===p.id?'<p class="text-red-400 text-xs">âœ“</p>':'')+'</button>').join('')+'</div></div>'+(isHost?'<button data-action="reveal-votes" '+(voteCount<players.length?'disabled':'')+' class="btn-liar text-white font-bold py-3 px-6 rounded-2xl '+(voteCount<players.length?'opacity-50':'')+'">ğŸ­ ê²°ê³¼ ê³µê°œ</button>':'')+'</div>'}

function renderLiarReveal(room,players){
  const votes=room.votes||{};const counts={};players.forEach(p=>counts[p.id]=0);
  Object.values(votes).forEach(v=>{if(counts[v]!==undefined)counts[v]++});
  const maxV=Math.max(...Object.values(counts),0);
  const mostVoted=Object.keys(counts).filter(k=>counts[k]===maxV);
  const liarCaught=mostVoted.includes(room.liarId);
  const liar=players.find(p=>p.id===room.liarId);
  const isLiar=room.liarId===state.odPlyerId;
  const isHost=room.hostId===state.odPlyerId;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-4 mb-4 max-w-lg mx-auto"><p class="text-red-400 text-xl font-bold mb-3">ğŸ­ íˆ¬í‘œ ê²°ê³¼</p><div class="space-y-2 mb-4">'+players.map((p,i)=>{const c=counts[p.id]||0;const pct=(c/players.length)*100;return'<div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><div class="flex-1 text-left"><p class="text-white text-sm">'+p.name+(p.id===room.liarId?' ğŸ¤¥':'')+'</p><div class="h-2 bg-black/30 rounded-full overflow-hidden"><div class="vote-bar h-full bg-red-500 rounded-full" style="width:'+pct+'%"></div></div></div><span class="text-white font-bold">'+c+'</span></div>'}).join('')+'</div><div class="bg-black/30 rounded-xl p-3"><p class="text-white/70 text-sm">ë¼ì´ì–´:</p><p class="text-2xl font-black '+(liarCaught?'text-green-400':'text-red-400')+'">'+(liar?.name||'?')+' ğŸ¤¥</p><p class="text-white/50 text-sm">'+(liarCaught?'âœ… ë¼ì´ì–´ ë°œê°!':'âŒ ë¼ì´ì–´ ìŠ¹ë¦¬!')+'</p></div></div>'+(liarCaught&&isLiar?'<div class="card-liar rounded-2xl p-3 mb-4 max-w-sm mx-auto"><p class="text-white/70 text-sm mb-2">ğŸ¯ ì œì‹œì–´ ë§ì¶”ê¸°!</p><input type="text" id="liar-guess" class="input-liar w-full px-3 py-2 rounded-xl mb-2 text-center" placeholder="ì œì‹œì–´..."><button data-action="liar-guess" class="btn-liar w-full py-2 rounded-xl">ì œì¶œ!</button></div>':'')+(isHost&&!liarCaught?'<button data-action="show-result" class="btn-liar text-white font-bold py-3 px-6 rounded-2xl">ğŸ“Š ìµœì¢… ê²°ê³¼</button>':'')+'</div>'}

function renderLiarResult(room,players,isHost){
  const liar=players.find(p=>p.id===room.liarId);
  const liarWon=room.liarGuessCorrect===true||!room.liarCaught;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-6 mb-4 max-w-lg mx-auto animate-result-pop"><div class="text-6xl mb-3">'+(liarWon?'ğŸ˜ˆ':'ğŸ‰')+'</div><p class="text-3xl font-black '+(liarWon?'text-red-400':'text-green-400')+' mb-3">'+(liarWon?'ğŸ¤¥ ë¼ì´ì–´ ìŠ¹ë¦¬!':'ğŸ˜‡ ì‹œë¯¼ ìŠ¹ë¦¬!')+'</p><div class="bg-black/30 rounded-xl p-3 space-y-1"><p class="text-white/70">ë¼ì´ì–´: <span class="text-red-400 font-bold">'+(liar?.name||'?')+'</span></p><p class="text-white/70">ì£¼ì œ: <span class="text-white font-bold">'+room.topic+'</span></p><p class="text-white/70">ì •ë‹µ: <span class="text-green-400 font-bold text-xl">'+room.word+'</span></p></div>'+(room.liarGuessCorrect!==undefined?'<p class="text-white/50 text-sm mt-2">'+(room.liarGuessCorrect?'ğŸ¯ ë¼ì´ì–´ ì •ë‹µ!':'âŒ ë¼ì´ì–´ ì˜¤ë‹µ')+'</p>':'')+'</div>'+(isHost?'<button data-action="new-round" class="btn-liar text-white text-lg font-bold py-3 px-8 rounded-2xl">ğŸ”„ ìƒˆ ë¼ìš´ë“œ</button>':'<p class="text-white/50">í˜¸ìŠ¤íŠ¸ ëŒ€ê¸°...</p>')+'</div>'}

function renderLeaveModal(){
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-dark rounded-2xl p-6 max-w-sm w-full animate-bounce-in text-center"><h3 class="text-xl font-bold text-white mb-4">ğŸšª ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</h3><p class="text-white/60 text-sm mb-6">'+(state.room?.hostId===state.odPlyerId?'í˜¸ìŠ¤íŠ¸ê°€ ë‚˜ê°€ë©´ ë°© ì‚­ì œë©ë‹ˆë‹¤.':'ê²Œì„ì—ì„œ ë‚˜ê°‘ë‹ˆë‹¤.')+'</p><div class="flex gap-3"><button data-action="cancel-leave" class="flex-1 btn-secondary text-white py-3 rounded-xl">ì·¨ì†Œ</button><button data-action="leave-room" class="flex-1 btn-danger text-white py-3 rounded-xl">ë‚˜ê°€ê¸°</button></div></div></div>'}

function bindEvents(){
  document.querySelectorAll('[data-action]').forEach(el=>{el.onclick=e=>{e.stopPropagation();handleAction(el.dataset.action,el.dataset)}});
  document.querySelectorAll('[data-slot]').forEach(el=>{el.oninput=e=>{const idx=parseInt(el.dataset.slot);if(!isNaN(idx))state.rouletteSlots[idx]=e.target.value;updateWheelVisual()}});
  const guessInput=document.getElementById('liar-guess');if(guessInput)guessInput.oninput=e=>state.liarGuess=e.target.value;
  const chatInput=document.getElementById('liar-chat-input');if(chatInput){chatInput.onkeydown=e=>{if(e.key==='Enter')sendLiarChat()};state.liarChatMsg='';chatInput.oninput=e=>state.liarChatMsg=e.target.value}
  const chatBox=document.getElementById('chat-box');if(chatBox)chatBox.scrollTop=chatBox.scrollHeight}

function updateWheelVisual(){
  const wheel=document.getElementById('roulette-wheel');const countEl=document.getElementById('slot-count');if(!wheel)return;
  const validSlots=getValidSlots();const validCount=validSlots.length;const segAngle=validCount>0?360/validCount:360;
  let svg='<circle cx="100" cy="100" r="98" fill="#1a1a2e" stroke="#6b21a8" stroke-width="4"/>';
  if(validCount>0){validSlots.forEach((s,i)=>{const st=i*segAngle-90,en=st+segAngle,la=segAngle>180?1:0;const x1=100+95*Math.cos(st*Math.PI/180),y1=100+95*Math.sin(st*Math.PI/180),x2=100+95*Math.cos(en*Math.PI/180),y2=100+95*Math.sin(en*Math.PI/180);const ma=(st+segAngle/2)*Math.PI/180,tx=100+60*Math.cos(ma),ty=100+60*Math.sin(ma);svg+='<path d="M100,100 L'+x1+','+y1+' A95,95 0 '+la+',1 '+x2+','+y2+' Z" fill="'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'" stroke="#1a1a2e" stroke-width="1"/><text x="'+tx+'" y="'+ty+'" fill="white" font-size="'+(validCount>8?8:10)+'" font-weight="bold" text-anchor="middle" dominant-baseline="middle" transform="rotate('+(st+segAngle/2+90)+','+tx+','+ty+')">'+(s.length>6?s.slice(0,6)+'â€¦':s)+'</text>'})}else{svg+='<text x="100" y="100" fill="white" font-size="12" text-anchor="middle">í•­ëª© ì…ë ¥</text>'}
  svg+='<circle cx="100" cy="100" r="22" fill="#2d1b4e" stroke="#9333ea" stroke-width="3"/><circle cx="100" cy="100" r="10" fill="#a855f7"/>';
  wheel.innerHTML=svg;if(countEl)countEl.textContent='ğŸ° í•­ëª© ('+validCount+'ê°œ)'}

function handleAction(a,d){
  if(a!=='spin'&&a!=='flip-card'&&a!=='spin-bottle')playSound('click');
  switch(a){
    case 'go-home':state.screen='home';state.game=null;leaveRoom();render();break;
    case 'select-game':const g=GAMES.find(x=>x.id===d.game);if(g){state.game=g;state.screen=g.solo?'roulette':'lobby'}render();break;
    case 'join-or-create':joinOrCreate();break;
    case 'start-game':startGame();break;
    case 'copy-code':navigator.clipboard?.writeText(state.roomCode);break;
    case 'show-leave':state.showLeave=true;render();break;
    case 'cancel-leave':state.showLeave=false;render();break;
    case 'leave-room':leaveRoom();state.screen='home';render();break;
    case 'kick':kickPlayer(d.pid);break;
    case 'roll-dice':rollDice();break;
    case 'close-mission':closeMission();break;
    case 'add-slot':state.rouletteSlots.push('');render();break;
    case 'remove-slot':if(state.rouletteSlots.length>2){state.rouletteSlots.splice(parseInt(d.idx),1);render()}break;
    case 'spin':spinRoulette();break;
    case 'show-update':state.showUpdate=true;render();break;
    case 'close-update':state.showUpdate=false;render();break;
    case 'show-aegyo':state.showAegyo=true;render();break;
    case 'close-aegyo':state.showAegyo=false;render();break;
    case 'flip-card':flipLiarCard();break;
    case 'start-discuss':playSound('discuss');updateRoom({phase:'discuss'});break;
    case 'start-vote':playSound('vote');updateRoom({phase:'vote',votes:{}});state.liarVote=null;break;
    case 'vote':playSound('vote');state.liarVote=d.target;if(roomRef)roomRef.child('votes/'+state.odPlyerId).set(d.target);render();break;
    case 'reveal-votes':revealVotes();break;
    case 'liar-guess':liarGuessWord();break;
    case 'show-result':showFinalResult();break;
    case 'new-round':newLiarRound();break;
    case 'send-chat':sendLiarChat();break;
    case 'spin-bottle':spinBottle();break;
    case 'reset-bottle':resetBottle();break;
    case 'rescue-vote':rescueVote(d.vote==='yes');break;
  }}

function sendLiarChat(){
  if(!roomRef||!state.liarChatMsg.trim())return;
  playSound('chat');
  const chatRef=roomRef.child('chats').push();
  chatRef.set({pid:state.odPlyerId,msg:state.liarChatMsg.trim(),time:Date.now()});
  state.liarChatMsg='';
  const input=document.getElementById('liar-chat-input');if(input)input.value=''}

function flipLiarCard(){
  if(state.liarFlipped)return;
  playSound('flip');state.liarFlipped=true;
  if(roomRef)roomRef.child('flippedPlayers/'+state.odPlyerId).set(true);
  render()}

function joinOrCreate(){
  const name=document.getElementById('pname')?.value?.trim();
  const code=document.getElementById('rcode')?.value?.toUpperCase()?.trim();
  if(!name)return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!');
  if(!isFirebaseReady)return alert('Firebase ì—°ê²° í•„ìš”!');
  state.playerName=name;
  if(code&&code.length===6){joinRoom(code)}else{createRoom()}}

function createRoom(){
  state.roomCode=genCode();state.odPlyerId=genCode();
  const data={hostId:state.odPlyerId,gameId:state.game.id,status:'waiting',players:{[state.odPlyerId]:{id:state.odPlyerId,name:state.playerName,order:0,position:0,islandTurn:0,finished:false,finishOrder:0}},turn:0,rolling:false,showMission:false,currentTileId:null,phase:'role',flippedPlayers:{},chats:{},bottleTarget:null,finishCount:0,rescueVoting:false,rescueTarget:null,rescueVotes:{}};
  roomRef=db.ref('rooms/'+state.roomCode);
  roomRef.set(data).then(()=>{subscribeRoom();playSound('success')})}

function joinRoom(code){
  state.roomCode=code;state.odPlyerId=genCode();
  roomRef=db.ref('rooms/'+code);
  roomRef.once('value').then(snap=>{
    const val=snap.val();
    if(!val)return alert('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    if(val.status!=='waiting')return alert('ì´ë¯¸ ê²Œì„ ì¤‘!');
    const g=GAMES.find(x=>x.id===val.gameId);
    const cnt=Object.keys(val.players||{}).length;
    if(cnt>=g.max)return alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');
    state.game=g;
    roomRef.child('players/'+state.odPlyerId).set({id:state.odPlyerId,name:state.playerName,order:cnt,position:0,islandTurn:0,finished:false,finishOrder:0}).then(()=>{subscribeRoom();playSound('join')})})}

function subscribeRoom(){
  roomRef.on('value',snap=>{
    const val=snap.val();
    if(!val||!val.players||!val.players[state.odPlyerId]){playSound('kick');alert('ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤');leaveRoom();state.screen='home';render();return}
    state.room=val;
    if(val.status==='playing'&&state.screen==='lobby'){playSound('success');state.screen='game';state.liarFlipped=false;state.liarVote=null;state.bottleAngle=0;state.bottleSpinning=false}
    if(val.diceValue)state.localDice=val.diceValue;
    render()})}

function leaveRoom(){
  if(!roomRef)return;
  if(state.room?.hostId===state.odPlyerId){roomRef.remove()}else{roomRef.child('players/'+state.odPlyerId).remove()}
  roomRef.off();roomRef=null;state.room=null;state.showLeave=false;state.hasIslandSkip=false}

function kickPlayer(pid){if(!roomRef||state.room?.hostId!==state.odPlyerId)return;roomRef.child('players/'+pid).remove();playSound('kick')}
function updateRoom(data){if(roomRef)roomRef.update(data)}

function startGame(){
  if(!roomRef||state.room?.hostId!==state.odPlyerId)return;
  const g=state.game;
  if(g.id==='liar'){
    const players=Object.values(state.room.players);
    const liarIdx=Math.floor(Math.random()*players.length);
    const topics=Object.keys(LIAR_TOPICS);
    const topic=topics[Math.floor(Math.random()*topics.length)];
    const words=LIAR_TOPICS[topic];
    const word=words[Math.floor(Math.random()*words.length)];
    updateRoom({status:'playing',liarId:players[liarIdx].id,topic,word,phase:'role',votes:null,liarGuessCorrect:null,liarCaught:null,flippedPlayers:{},chats:{}})}
  else if(g.id==='truth'){updateRoom({status:'playing',bottleTarget:null})}
  else{updateRoom({status:'playing',finishCount:0})}}

function rollDice(){
  if(!roomRef||state.room.rolling)return;
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  const curr=players[state.room.turn%players.length];
  if(curr.finished){updateRoom({turn:state.room.turn+1});return}
  if(curr.islandTurn&&curr.islandTurn>0){
    roomRef.child('players/'+curr.id+'/islandTurn').set(curr.islandTurn-1);
    updateRoom({turn:state.room.turn+1});return}
  updateRoom({rolling:true});playSound('dice');
  let cnt=0;
  const iv=setInterval(()=>{
    state.localDice=Math.floor(Math.random()*6)+1;render();cnt++;
    if(cnt>=15){clearInterval(iv);
      const final=Math.floor(Math.random()*6)+1;state.localDice=final;
      let newPos=(curr.position+final)%TILES.length;
      const tile=TILES[newPos];
      const isGolden=tile.type==='special';
      const goldenKey=isGolden?GOLDEN_KEYS[Math.floor(Math.random()*GOLDEN_KEYS.length)]:null;
      const updates={rolling:false,showMission:true,currentTileId:tile.id,lastAction:{playerId:curr.id,timestamp:Date.now()},diceValue:final};
      updates['players/'+curr.id+'/position']=newPos;
      if(tile.type==='island'&&!state.hasIslandSkip){updates['players/'+curr.id+'/islandTurn']=1}
      if(goldenKey){updates.goldenKey=goldenKey.type;if(goldenKey.type==='island-skip')state.hasIslandSkip=true}else{updates.goldenKey=null}
      roomRef.update(updates);playSound(isGolden?'golden':'mission')}},100)}

function closeMission(){
  const room=state.room;
  const tile=TILES.find(t=>t.id===room.currentTileId);
  const players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const curr=players[room.turn%players.length];
  let newPos=null;
  let nextTurn=room.turn+1;
  const notFinished=players.filter(p=>!p.finished);
  
  if(tile?.type==='bonus'&&tile.id===20)nextTurn=room.turn;
  if(tile?.type==='move'){
    if(tile.id===10)newPos=Math.max(0,curr.position-2);
    else if(tile.id===29)newPos=Math.max(0,curr.position-3);
    else if(tile.id===31){
      if(notFinished.length<=2){newPos=0}
      else{updateRoom({showMission:false,rescueVoting:true,rescueTarget:curr.id,rescueVotes:{}});return}
    }}
  if(tile?.type==='island'&&state.hasIslandSkip){state.hasIslandSkip=false;roomRef.child('players/'+curr.id+'/islandTurn').set(0)}
  
  // ì¶œë°œì  ë„ì°© = ì™„ì£¼
  if(curr.position>0&&(newPos===0||(curr.position+state.localDice>=TILES.length))){
    const finishOrder=(room.finishCount||0)+1;
    roomRef.child('players/'+curr.id).update({finished:true,finishOrder,position:0});
    updateRoom({showMission:false,currentTileId:null,goldenKey:null,turn:nextTurn,finishCount:finishOrder});return}
  
  if(newPos!==null)roomRef.child('players/'+curr.id+'/position').set(newPos);
  updateRoom({showMission:false,currentTileId:null,goldenKey:null,turn:nextTurn})}

function rescueVote(isYes){
  if(!roomRef)return;
  playSound('vote');
  roomRef.child('rescueVotes/'+state.odPlyerId).set(isYes);
  setTimeout(checkRescueResult,500)}

function checkRescueResult(){
  const room=state.room;if(!room||!room.rescueVoting)return;
  const players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const eligible=players.filter(p=>p.id!==room.rescueTarget&&!p.finished);
  const votes=room.rescueVotes||{};
  if(Object.keys(votes).length<eligible.length)return;
  const yes=Object.values(votes).filter(v=>v===true).length;
  const no=Object.values(votes).filter(v=>v===false).length;
  const rescued=yes>no;
  if(rescued){playSound('success');updateRoom({rescueVoting:false,rescueTarget:null,rescueVotes:{},turn:state.room.turn+1})}
  else{playSound('wrong');roomRef.child('players/'+room.rescueTarget+'/position').set(0);updateRoom({rescueVoting:false,rescueTarget:null,rescueVotes:{},turn:state.room.turn+1})}}

function spinBottle(){
  if(!roomRef||state.bottleSpinning||state.room.bottleTarget)return;
  playSound('bottle');state.bottleSpinning=true;
  const players=Object.values(state.room.players);
  const winIdx=Math.floor(Math.random()*players.length);
  const spins=5+Math.floor(Math.random()*3);
  const anglePerPlayer=360/players.length;
  const finalAngle=spins*360+winIdx*anglePerPlayer+anglePerPlayer/2;
  state.bottleAngle=finalAngle;render();
  setTimeout(()=>{state.bottleSpinning=false;playSound('win');updateRoom({bottleTarget:players[winIdx].id})},4000)}

function resetBottle(){if(!roomRef)return;state.bottleAngle=0;state.bottleSpinning=false;updateRoom({bottleTarget:null})}

function spinRoulette(){
  if(state.rouletteSpinning)return;
  const validSlots=getValidSlots();
  if(validSlots.length<2)return alert('ìµœì†Œ 2ê°œ ì´ìƒ!');
  playSound('spin');state.rouletteSpinning=true;state.rouletteResult=null;state.rouletteResultColor=null;
  const wheel=document.getElementById('roulette-wheel');
  if(wheel){wheel.classList.add('reset');wheel.style.transform='rotate(0deg)';state.rouletteAngle=0}
  render();
  setTimeout(()=>{
    const wheel=document.getElementById('roulette-wheel');
    if(wheel){
      wheel.classList.remove('reset');
      const segAngle=360/validSlots.length;
      const winIdx=Math.floor(Math.random()*validSlots.length);
      const spins=5+Math.floor(Math.random()*3);
      const finalAngle=spins*360+(360-winIdx*segAngle-segAngle/2);
      state.rouletteAngle=finalAngle;
      wheel.style.transform='rotate('+finalAngle+'deg)';
      setTimeout(()=>{state.rouletteSpinning=false;state.rouletteResult=validSlots[winIdx];state.rouletteResultColor=ROULETTE_COLORS[winIdx%ROULETTE_COLORS.length];playSound('win');render()},4100)}},50)}

function revealVotes(){
  if(!roomRef)return;
  const votes=state.room.votes||{};const counts={};
  Object.values(state.room.players).forEach(p=>counts[p.id]=0);
  Object.values(votes).forEach(v=>{if(counts[v]!==undefined)counts[v]++});
  const maxV=Math.max(...Object.values(counts),0);
  const mostVoted=Object.keys(counts).filter(k=>counts[k]===maxV);
  const liarCaught=mostVoted.includes(state.room.liarId);
  playSound(liarCaught?'caught':'escape');
  updateRoom({phase:'reveal',liarCaught})}

function liarGuessWord(){
  if(!roomRef)return;
  const guess=state.liarGuess.trim();if(!guess)return;
  const correct=guess===state.room.word;
  playSound(correct?'escape':'wrong');
  updateRoom({phase:'result',liarGuessCorrect:correct})}

function showFinalResult(){if(!roomRef)return;updateRoom({phase:'result'})}

function newLiarRound(){
  if(!roomRef)return;
  const players=Object.values(state.room.players);
  const liarIdx=Math.floor(Math.random()*players.length);
  const topics=Object.keys(LIAR_TOPICS);
  const topic=topics[Math.floor(Math.random()*topics.length)];
  const words=LIAR_TOPICS[topic];
  const word=words[Math.floor(Math.random()*words.length)];
  state.liarFlipped=false;state.liarVote=null;state.liarGuess='';
  updateRoom({liarId:players[liarIdx].id,topic,word,phase:'role',votes:null,liarGuessCorrect:null,liarCaught:null,flippedPlayers:{},chats:{}})}

render();
</script>
</body>
</html>
