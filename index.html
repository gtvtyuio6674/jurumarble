<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® íŒŒí‹°ê²Œì„ - ì˜¨ë¼ì¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cream: '#FFF8E7',
            warmgray: '#F5F0E8',
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Noto Sans KR', sans-serif; }
    .title-font { font-family: 'Black Han Sans', sans-serif; }
    
    .bg-pattern {
      background-color: #1a1a2e;
      background-image: 
        radial-gradient(ellipse at 20% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%236366f1' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .bg-pattern-beer {
      background-color: #2C2416;
      background-image: 
        radial-gradient(ellipse at 20% 30%, rgba(244, 168, 54, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(244, 168, 54, 0.1) 0%, transparent 50%);
    }

    @keyframes slide-in-left { 0% { transform: translateX(-100px); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
    @keyframes slide-in-right { 0% { transform: translateX(100px); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
    @keyframes slide-in-up { 0% { transform: translateY(50px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
    @keyframes fade-in-scale { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes bounce-in { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
    @keyframes dice-roll { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(20deg) scale(1.15); } 50% { transform: rotate(-20deg) scale(1.1); } 75% { transform: rotate(10deg) scale(1.15); } 100% { transform: rotate(0deg) scale(1); } }
    @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(244, 168, 54, 0.4); } 50% { box-shadow: 0 0 35px rgba(244, 168, 54, 0.7); } }
    @keyframes float { 0%, 100% { transform: translateY(0) rotate(-2deg); } 50% { transform: translateY(-15px) rotate(2deg); } }
    @keyframes pour { 0% { transform: rotate(-30deg); } 50% { transform: rotate(-45deg); } 100% { transform: rotate(-30deg); } }
    @keyframes move-token { 0% { transform: scale(1); } 50% { transform: scale(1.3) translateY(-10px); } 100% { transform: scale(1); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    
    .animate-slide-left { animation: slide-in-left 0.5s ease-out forwards; }
    .animate-slide-right { animation: slide-in-right 0.5s ease-out forwards; }
    .animate-slide-up { animation: slide-in-up 0.5s ease-out forwards; }
    .animate-fade-scale { animation: fade-in-scale 0.6s ease-out forwards; }
    .animate-bounce-in { animation: bounce-in 0.5s ease-out; }
    .animate-dice-roll { animation: dice-roll 0.15s ease-in-out infinite; }
    .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .animate-float { animation: float 4s ease-in-out infinite; }
    .animate-pour { animation: pour 1s ease-in-out infinite; }
    .animate-move { animation: move-token 0.5s ease-out; }
    .animate-shake { animation: shake 0.3s ease-in-out; }

    .delay-100 { animation-delay: 0.1s; opacity: 0; }
    .delay-200 { animation-delay: 0.2s; opacity: 0; }
    .delay-300 { animation-delay: 0.3s; opacity: 0; }
    .delay-400 { animation-delay: 0.4s; opacity: 0; }
    .delay-500 { animation-delay: 0.5s; opacity: 0; }

    .card-dark {
      background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 50%, #16162a 100%);
      border: 2px solid #3d3d5c;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .card-wood {
      background: linear-gradient(145deg, #4A3728 0%, #3D2E1F 50%, #2C2416 100%);
      border: 3px solid #5D4634;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .game-card {
      background: linear-gradient(145deg, #2d2d44 0%, #1a1a2e 100%);
      border: 2px solid #3d3d5c;
      transition: all 0.3s;
    }
    .game-card:hover {
      transform: translateY(-8px) scale(1.02);
      border-color: #6366f1;
      box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
    }

    .tile-drink { background: linear-gradient(135deg, #D97706 0%, #B45309 100%); }
    .tile-game { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
    .tile-bonus { background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%); }
    .tile-move { background: linear-gradient(135deg, #7C3AED 0%, #6D28D9 100%); }
    .tile-special { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
    .tile-free { background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%); }
    .tile-start { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }

    .btn-primary {
      background: linear-gradient(180deg, #6366f1 0%, #4f46e5 100%);
      border: 2px solid #4338ca;
      box-shadow: 0 4px 0 #3730a3, 0 6px 10px rgba(0,0,0,0.3);
      transition: all 0.1s;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #3730a3, 0 8px 15px rgba(0,0,0,0.3); }
    .btn-primary:active, .btn-primary.pressed { transform: translateY(2px); box-shadow: 0 2px 0 #3730a3, 0 3px 5px rgba(0,0,0,0.3); }

    .btn-beer {
      background: linear-gradient(180deg, #F4A836 0%, #D4891C 100%);
      border: 2px solid #B8731A;
      box-shadow: 0 4px 0 #8B5A14, 0 6px 10px rgba(0,0,0,0.3);
      transition: all 0.1s;
    }
    .btn-beer:hover { transform: translateY(-2px); }
    .btn-beer:active, .btn-beer.pressed { transform: translateY(2px); box-shadow: 0 2px 0 #8B5A14; }

    .btn-danger {
      background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
      border: 2px solid #b91c1c;
      box-shadow: 0 4px 0 #991b1b, 0 6px 10px rgba(0,0,0,0.3);
      transition: all 0.1s;
    }
    .btn-danger:hover { transform: translateY(-2px); }
    .btn-danger:active, .btn-danger.pressed { transform: translateY(2px); box-shadow: 0 2px 0 #991b1b; }

    .btn-secondary {
      background: transparent;
      border: 2px solid rgba(99, 102, 241, 0.5);
      transition: all 0.15s;
    }
    .btn-secondary:hover { background: rgba(99, 102, 241, 0.2); border-color: #6366f1; }
    .btn-secondary:active, .btn-secondary.pressed { transform: scale(0.97); }

    .btn-ghost {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.15s;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.2); }

    .input-dark {
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      color: white;
    }
    .input-dark:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.3); outline: none; }
    .input-dark::placeholder { color: rgba(255,255,255,0.4); }

    .player-token {
      box-shadow: 0 3px 6px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
      border: 2px solid rgba(255,255,255,0.5);
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #4d4d6d; border-radius: 4px; }

    .kick-btn {
      opacity: 0;
      transition: opacity 0.2s;
    }
    .player-item:hover .kick-btn {
      opacity: 1;
    }
  </style>
</head>
<body class="min-h-screen bg-pattern">
  <div id="app"></div>

  <script>
    // ============================================
    // ğŸ”Š ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ
    // ============================================
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;

    function initAudio() {
      if (!audioCtx) audioCtx = new AudioCtx();
    }

    function playSound(type) {
      initAudio();
      if (!audioCtx) return;
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      switch(type) {
        case 'click':
          oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
          gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.1);
          break;
        case 'success':
          oscillator.frequency.setValueAtTime(523, audioCtx.currentTime);
          oscillator.frequency.setValueAtTime(659, audioCtx.currentTime + 0.1);
          oscillator.frequency.setValueAtTime(784, audioCtx.currentTime + 0.2);
          gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.3);
          break;
        case 'error':
          oscillator.frequency.setValueAtTime(300, audioCtx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.2);
          gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.2);
          break;
        case 'dice':
          oscillator.type = 'square';
          oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.05);
          gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.1);
          break;
        case 'mission':
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.15);
          gainNode.gain.setValueAtTime(0.25, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.2);
          break;
        case 'join':
          oscillator.frequency.setValueAtTime(600, audioCtx.currentTime);
          oscillator.frequency.setValueAtTime(800, audioCtx.currentTime + 0.1);
          gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.2);
          break;
        case 'kick':
          oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
          oscillator.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
          gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.3);
          break;
      }
    }

    // ============================================
    // ğŸ”¥ Firebase ì„¤ì •
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyCafzk3QueRsvj4DiMht6bTyHs0_HT5Iuc",
      authDomain: "test-e3974.firebaseapp.com",
      databaseURL: "https://test-e3974-default-rtdb.firebaseio.com",
      projectId: "test-e3974",
      storageBucket: "test-e3974.firebasestorage.app",
      messagingSenderId: "572983111486",
      appId: "1:572983111486:web:ce4e3f897f8faa66c4866f",
      measurementId: "G-S8J76VQ7MF"
    };

    let db = null;
    let isFirebaseReady = false;
    
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      isFirebaseReady = firebaseConfig.apiKey !== "YOUR_API_KEY";
    } catch (e) {
      console.log("Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...");
    }

    // ============================================
    // ê²Œì„ ëª©ë¡
    // ============================================
    const GAMES = [
      {
        id: 'jurumarble',
        name: 'ì£¼ë£¨ë§ˆë¸”',
        emoji: 'ğŸº',
        description: 'ìˆ ì´ ìˆ ìˆ  ë„˜ì–´ê°€ëŠ” ë³´ë“œê²Œì„',
        color: 'from-amber-500 to-orange-600',
        bgClass: 'bg-pattern-beer',
        minPlayers: 2,
        maxPlayers: 8
      },
      {
        id: 'coming-soon-1',
        name: 'ì¤€ë¹„ ì¤‘',
        emoji: 'ğŸ¯',
        description: 'ìƒˆë¡œìš´ ê²Œì„ì´ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤!',
        color: 'from-gray-500 to-gray-600',
        disabled: true
      },
      {
        id: 'coming-soon-2',
        name: 'ì¤€ë¹„ ì¤‘',
        emoji: 'ğŸª',
        description: 'ìƒˆë¡œìš´ ê²Œì„ì´ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤!',
        color: 'from-gray-500 to-gray-600',
        disabled: true
      }
    ];

    // ============================================
    // ì£¼ë£¨ë§ˆë¸” ê²Œì„ ë°ì´í„°
    // ============================================
    const TILES = [
      { id: 0, name: "ì¶œë°œ", type: "start", emoji: "ğŸš€", description: "ê²Œì„ ì‹œì‘! ëª¨ë‘ í™”ì´íŒ…!" },
      { id: 1, name: "ë§ì€í¸ ì§ ", type: "drink", emoji: "ğŸ»", description: "ë§ì€í¸ ì‚¬ëŒê³¼ ê±´ë°°í•˜ê³  í•œ ì”!" },
      { id: 2, name: "ì£¼ì‚¬ìœ„ í•œë²ˆ ë”", type: "bonus", emoji: "ğŸ²", description: "ëŸ­í‚¤! ì£¼ì‚¬ìœ„ë¥¼ í•œ ë²ˆ ë” êµ´ë ¤ìš”" },
      { id: 3, name: "3.6.9", type: "game", emoji: "ğŸ‘", description: "3.6.9 ê²Œì„! ë°•ìˆ˜ í•œ ë²ˆì´ë¼ë„ í‹€ë¦¬ë©´ ë²Œì£¼!" },
      { id: 4, name: "í‘ê¸°ì‚¬", type: "drink", emoji: "ğŸ¦¸â€â™‚ï¸", description: "í‘ê¸°ì‚¬ë¥¼ ì§€ëª©í•˜ì„¸ìš”! ì—†ìœ¼ë©´ ë‘ ì”!" },
      { id: 5, name: "ë’¤ë¡œ 1ì¹¸", type: "move", emoji: "â¬…ï¸", description: "ì•—! í•œ ì¹¸ ë’¤ë¡œ ê°€ì„¸ìš”" },
      { id: 6, name: "007", type: "game", emoji: "ğŸ”«", description: "007ë¹µ! ê²Œì„ ì‹œì‘! ì§€ë©´ ë²Œì£¼!" },
      { id: 7, name: "í™©ê¸ˆì—´ì‡ ", type: "special", emoji: "ğŸ”‘", description: "ë²Œê¸ˆ 500ì›! ë˜ëŠ” í•œ ì” ì„ íƒ" },
      { id: 8, name: "ë‹¤ê°™ì´ ì›ìƒ·", type: "drink", emoji: "ğŸ¥‚", description: "ëª¨ë‘ ë‹¤ ê°™ì´ ì›ìƒ·!" },
      { id: 9, name: "ëˆˆì¹˜ê²Œì„", type: "game", emoji: "ğŸ‘€", description: "ëˆˆì¹˜ê²Œì„! ë§ˆì§€ë§‰ ì‚¬ëŒì´ ë²Œì£¼!" },
      { id: 10, name: "ëœë¤ê²Œì„", type: "game", emoji: "ğŸ°", description: "ëœë¤ ë¯¸ë‹ˆê²Œì„!" },
      { id: 11, name: "ë’¤ë¡œ 3ì¹¸", type: "move", emoji: "âª", description: "ì´ëŸ°... ì„¸ ì¹¸ ë’¤ë¡œ!" },
      { id: 12, name: "ì‰¬ì–´ê°€ê¸°", type: "free", emoji: "ğŸ˜´", description: "ê³µì§œ! ì‰¬ì–´ê°€ì„¸ìš”~" },
      { id: 13, name: "ëŸ¬ë¸Œìƒ·", type: "drink", emoji: "ğŸ’•", description: "ì›í•˜ëŠ” ì‚¬ëŒê³¼ ëŸ¬ë¸Œìƒ·!" },
      { id: 14, name: "ê·€ìš”ë¯¸", type: "game", emoji: "ğŸ¥°", description: "ê·€ìš”ë¯¸ 1~10! ì‹¤íŒ¨í•˜ë©´ ë²Œì£¼!" },
      { id: 15, name: "31ê²Œì„", type: "game", emoji: "ğŸ”¢", description: "ë°°ìŠ¤í‚¨ë¼ë¹ˆìŠ¤ 31! 31 ì™¸ì¹˜ë©´ ë²Œì£¼!" },
      { id: 16, name: "ì§€ëª©", type: "drink", emoji: "ğŸ‘‰", description: "ì›í•˜ëŠ” í•œ ëª… ì§€ëª©í•´ì„œ ë§ˆì‹œê²Œ!" },
      { id: 17, name: "ë§Œë‘", type: "game", emoji: "ğŸ¥Ÿ", description: "ë°”ë¹µë°”ë¹µë°”ë¹µí•˜í•˜ë¹µíˆ!" },
      { id: 18, name: "ë§¥ëšœ", type: "drink", emoji: "ğŸº", description: "ë§¥ì£¼ ëšœê»‘ íŠ•ê¸°ê¸°! ì‹¤íŒ¨ì‹œ ë²Œì£¼!" },
      { id: 19, name: "ì†ë³‘í˜¸", type: "game", emoji: "âœ‹", description: "ì†ê°€ë½ ê±¸ê¸° ê²Œì„!" },
      { id: 20, name: "ì•„íŒŒíŠ¸", type: "game", emoji: "ğŸ¢", description: "ì•„íŒŒíŠ¸ ê²Œì„! ë°•ìˆ˜ í‹€ë¦¬ë©´ ë²Œì£¼!" },
      { id: 21, name: "2ì” ë§ˆì…”", type: "drink", emoji: "ğŸ·", description: "ë„ˆ ìì‹ ì„ ì•Œë¼! 2ì” ë§ˆì…”ë¼!" },
      { id: 22, name: "ê¸°ë¶€ì²œì‚¬", type: "special", emoji: "ğŸ˜‡", description: "ë‹¤ìŒ ì‚¬ëŒì—ê²Œ ë©´ì£„ë¶€!" },
      { id: 23, name: "Back", type: "move", emoji: "ğŸ”™", description: "ì²˜ìŒìœ¼ë¡œ! 6ì” ë§ˆì…”!" },
    ];

    const RANDOM_GAMES = [
      "í›ˆë¯¼ì •ìŒ - ì´ˆì„±ìœ¼ë¡œ ë‹¨ì–´ ëŒ€ê¸°!",
      "ì†Œì£¼ë³‘ ëŒë¦¬ê¸°!",
      "ë”¸ê¸°ê²Œì„ ì‹œì‘~",
      "ì´ˆì„±í€´ì¦ˆ 5ì´ˆ!",
      "ë…¸ë˜ ê°€ì‚¬ ë§ì¶”ê¸°!",
      "ì—…ë‹¤ìš´ ê²Œì„!",
      "ì§„ì‹¤ or ê±°ì§“!",
      "ë¬¼ìŒí‘œ ê²Œì„!"
    ];

    const PLAYER_COLORS = ['#EAB308', '#3B82F6', '#22C55E', '#EF4444', '#A855F7', '#F97316', '#06B6D4', '#EC4899'];

    // ============================================
    // ìƒíƒœ ê´€ë¦¬
    // ============================================
    let state = {
      screen: 'home',
      selectedGame: null,
      roomCode: null,
      playerId: null,
      playerName: '',
      isHost: false,
      room: null,
      localDiceValue: 1,
      showLeaveConfirm: false,
      showKickConfirm: null,
      kicked: false,
    };

    let roomRef = null;
    let unsubscribe = null;

    // ============================================
    // ì„¸ì…˜ ì €ì¥/ë³µêµ¬
    // ============================================
    function saveSession() {
      if (state.roomCode && state.playerId && state.playerName) {
        localStorage.setItem('partygame_session', JSON.stringify({
          roomCode: state.roomCode,
          playerId: state.playerId,
          playerName: state.playerName,
          gameId: state.selectedGame?.id,
          timestamp: Date.now()
        }));
      }
    }

    function loadSession() {
      try {
        const data = localStorage.getItem('partygame_session');
        if (data) {
          const session = JSON.parse(data);
          if (Date.now() - session.timestamp < 24 * 60 * 60 * 1000) {
            return session;
          }
        }
      } catch (e) {}
      return null;
    }

    function clearSession() {
      localStorage.removeItem('partygame_session');
    }

    // ============================================
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    // ============================================
    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function generatePlayerId() {
      return 'player_' + Math.random().toString(36).substring(2, 9);
    }

    function getTilePosition(index) {
      const perSide = 6;
      if (index === 0) return { x: 0, y: 6 };
      if (index <= perSide) return { x: index, y: 6 };
      if (index <= perSide * 2) return { x: 6, y: 6 - (index - perSide) };
      if (index <= perSide * 3) return { x: 6 - (index - perSide * 2), y: 0 };
      return { x: 0, y: index - perSide * 3 };
    }

    function getPlayerOffset(playerIndex, totalPlayers) {
      const offsets = [[-12, -12], [12, -12], [-12, 12], [12, 12], [0, -18], [0, 18], [-18, 0], [18, 0]];
      return offsets[playerIndex] || [0, 0];
    }

    // ============================================
    // Firebase í•¨ìˆ˜
    // ============================================
    async function createRoom() {
      if (!isFirebaseReady) {
        alert('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!');
        return;
      }
      
      playSound('success');
      const roomCode = generateRoomCode();
      const playerId = generatePlayerId();
      
      const roomData = {
        code: roomCode,
        gameId: state.selectedGame.id,
        hostId: playerId,
        status: 'waiting',
        players: {
          [playerId]: {
            id: playerId,
            name: state.playerName,
            position: 0,
            order: 0,
            connected: true
          }
        },
        currentTurn: 0,
        diceValue: 1,
        rolling: false,
        showMission: false,
        currentTileId: null,
        missionRandomGame: null,
        lastAction: null,
        createdAt: Date.now()
      };

      await db.ref('rooms/' + roomCode).set(roomData);
      
      state.roomCode = roomCode;
      state.playerId = playerId;
      state.isHost = true;
      state.screen = 'lobby';
      
      saveSession();
      subscribeToRoom(roomCode);
      render();
    }

    async function joinRoom(code) {
      if (!isFirebaseReady) {
        alert('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!');
        return;
      }

      const snapshot = await db.ref('rooms/' + code).once('value');
      const room = snapshot.val();
      
      if (!room) {
        alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤!');
        return;
      }
      
      if (room.status !== 'waiting') {
        alert('ì´ë¯¸ ê²Œì„ì´ ì‹œì‘ëœ ë°©ì…ë‹ˆë‹¤!');
        return;
      }

      const playerCount = Object.keys(room.players || {}).length;
      if (playerCount >= 8) {
        alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 8ëª…)');
        return;
      }

      playSound('join');
      const playerId = generatePlayerId();
      
      await db.ref(`rooms/${code}/players/${playerId}`).set({
        id: playerId,
        name: state.playerName,
        position: 0,
        order: playerCount,
        connected: true
      });

      state.roomCode = code;
      state.playerId = playerId;
      state.isHost = false;
      state.selectedGame = GAMES.find(g => g.id === room.gameId);
      state.screen = 'lobby';
      
      saveSession();
      subscribeToRoom(code);
      render();
    }

    async function rejoinRoom() {
      const session = loadSession();
      if (!session || !isFirebaseReady) return;

      const snapshot = await db.ref('rooms/' + session.roomCode).once('value');
      const room = snapshot.val();
      
      if (!room) {
        alert('ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        clearSession();
        render();
        return;
      }

      if (!room.players[session.playerId]) {
        alert('ë°©ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        clearSession();
        render();
        return;
      }

      playSound('join');
      await db.ref(`rooms/${session.roomCode}/players/${session.playerId}/connected`).set(true);

      state.roomCode = session.roomCode;
      state.playerId = session.playerId;
      state.playerName = session.playerName;
      state.isHost = room.hostId === session.playerId;
      state.selectedGame = GAMES.find(g => g.id === session.gameId);
      state.screen = room.status === 'playing' ? 'game' : 'lobby';
      
      subscribeToRoom(session.roomCode);
      render();
    }

    function subscribeToRoom(code) {
      if (unsubscribe) unsubscribe();
      
      roomRef = db.ref('rooms/' + code);
      
      const callback = roomRef.on('value', (snapshot) => {
        const room = snapshot.val();
        
        // ë°©ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ë‚´ê°€ ì¶”ë°©ë‹¹í•œ ê²½ìš°
        if (!room || !room.players || !room.players[state.playerId]) {
          if (!state.kicked) {
            state.kicked = true;
            playSound('kick');
            alert('ë°©ì—ì„œ ë‚˜ê°€ì¡ŒìŠµë‹ˆë‹¤.');
            clearSession();
            leaveRoomImmediate();
          }
          return;
        }
        
        const wasShowingMission = state.room?.showMission;
        state.room = room;
        state.isHost = room.hostId === state.playerId;
        
        if (room.status === 'playing' && state.screen === 'lobby') {
          playSound('success');
          state.screen = 'game';
        }
        
        if (room.diceValue) {
          state.localDiceValue = room.diceValue;
        }
        
        if (!wasShowingMission && room.showMission) {
          playSound('mission');
        }
        
        render();
      });

      unsubscribe = () => roomRef.off('value', callback);
      db.ref(`rooms/${code}/players/${state.playerId}/connected`).onDisconnect().set(false);
    }

    async function leaveRoom() {
      state.showLeaveConfirm = false;
      playSound('click');
      
      if (state.roomCode && state.playerId) {
        // Firebaseì—ì„œ í”Œë ˆì´ì–´ ì‚­ì œ
        await db.ref(`rooms/${state.roomCode}/players/${state.playerId}`).remove();
        
        // ë°©ì¥ì´ ë‚˜ê°€ë©´ ë°© ì‚­ì œ ë˜ëŠ” ë°©ì¥ ìœ„ì„
        if (state.isHost && state.room) {
          const remainingPlayers = Object.keys(state.room.players).filter(id => id !== state.playerId);
          if (remainingPlayers.length === 0) {
            await db.ref(`rooms/${state.roomCode}`).remove();
          } else {
            await db.ref(`rooms/${state.roomCode}/hostId`).set(remainingPlayers[0]);
          }
        }
      }
      
      leaveRoomImmediate();
    }

    function leaveRoomImmediate() {
      if (unsubscribe) unsubscribe();
      clearSession();
      state.roomCode = null;
      state.playerId = null;
      state.room = null;
      state.isHost = false;
      state.selectedGame = null;
      state.kicked = false;
      state.screen = 'home';
      render();
    }

    async function kickPlayer(playerId) {
      state.showKickConfirm = null;
      if (!state.isHost || playerId === state.playerId) return;
      
      playSound('kick');
      await db.ref(`rooms/${state.roomCode}/players/${playerId}`).remove();
      
      // ìˆœì„œ ì¬ì •ë ¬
      const players = Object.values(state.room.players).filter(p => p.id !== playerId);
      for (let i = 0; i < players.length; i++) {
        await db.ref(`rooms/${state.roomCode}/players/${players[i].id}/order`).set(i);
      }
    }

    async function startGame() {
      if (!state.isHost) return;
      
      const players = Object.values(state.room.players);
      if (players.length < 2) {
        alert('ìµœì†Œ 2ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤!');
        return;
      }

      await db.ref(`rooms/${state.roomCode}`).update({
        status: 'playing',
        currentTurn: 0
      });
    }

    async function rollDice() {
      const room = state.room;
      const players = Object.values(room.players).sort((a, b) => a.order - b.order);
      const currentPlayer = players[room.currentTurn];
      
      if (currentPlayer.id !== state.playerId) return;
      if (room.rolling) return;
      
      playSound('dice');
      await db.ref(`rooms/${state.roomCode}/rolling`).set(true);

      let rollCount = 0;
      const rollInterval = setInterval(async () => {
        const tempValue = Math.floor(Math.random() * 6) + 1;
        await db.ref(`rooms/${state.roomCode}/diceValue`).set(tempValue);
        rollCount++;
        
        if (rollCount >= 15) {
          clearInterval(rollInterval);
          const finalValue = Math.floor(Math.random() * 6) + 1;
          const newPosition = (currentPlayer.position + finalValue) % TILES.length;
          const tile = TILES[newPosition];
          
          let randomGame = null;
          if (tile.name === 'ëœë¤ê²Œì„') {
            randomGame = RANDOM_GAMES[Math.floor(Math.random() * RANDOM_GAMES.length)];
          }
          
          await db.ref(`rooms/${state.roomCode}`).update({
            diceValue: finalValue,
            rolling: false,
            [`players/${currentPlayer.id}/position`]: newPosition,
            showMission: true,
            currentTileId: newPosition,
            missionRandomGame: randomGame,
            lastAction: {
              type: 'roll',
              playerId: currentPlayer.id,
              playerName: currentPlayer.name,
              value: finalValue,
              newPosition: newPosition,
              timestamp: Date.now()
            }
          });
        }
      }, 100);
    }

    async function closeMission(extraRoll = false) {
      const room = state.room;
      const players = Object.values(room.players).sort((a, b) => a.order - b.order);
      const currentPlayer = players[room.currentTurn];
      
      if (currentPlayer.id !== state.playerId) return;
      
      playSound('click');
      const tile = TILES[room.currentTileId];
      
      if (tile && tile.type === 'move') {
        let moveAmount = 0;
        if (tile.name === 'ë’¤ë¡œ 1ì¹¸') moveAmount = -1;
        else if (tile.name === 'ë’¤ë¡œ 3ì¹¸') moveAmount = -3;
        else if (tile.name === 'Back') moveAmount = -currentPlayer.position;
        
        const newPos = (currentPlayer.position + moveAmount + TILES.length) % TILES.length;
        await db.ref(`rooms/${state.roomCode}/players/${currentPlayer.id}/position`).set(newPos);
      }
      
      await db.ref(`rooms/${state.roomCode}`).update({
        showMission: false,
        currentTileId: null,
        missionRandomGame: null
      });
      
      if (!extraRoll && tile?.type !== 'bonus') {
        const nextTurn = (room.currentTurn + 1) % players.length;
        await db.ref(`rooms/${state.roomCode}/currentTurn`).set(nextTurn);
      }
    }

    // ============================================
    // ë Œë”ë§ í•¨ìˆ˜
    // ============================================
    function render() {
      const app = document.getElementById('app');
      
      switch (state.screen) {
        case 'home': app.innerHTML = renderHome(); break;
        case 'gameSelect': app.innerHTML = renderGameSelect(); break;
        case 'create': app.innerHTML = renderCreate(); break;
        case 'join': app.innerHTML = renderJoin(); break;
        case 'lobby': app.innerHTML = renderLobby(); break;
        case 'game': app.innerHTML = renderGame(); break;
      }

      bindEvents();
    }

    function bindEvents() {
      document.querySelectorAll('[data-action]').forEach(el => {
        const action = el.dataset.action;
        const sound = el.dataset.sound || 'click';
        
        el.onclick = (e) => {
          e.stopPropagation();
          playSound(sound);
          el.classList.add('pressed');
          setTimeout(() => el.classList.remove('pressed'), 150);
          
          setTimeout(() => {
            switch(action) {
              case 'go-home': state.screen = 'home'; state.selectedGame = null; render(); break;
              case 'go-gameselect': state.screen = 'gameSelect'; render(); break;
              case 'go-create': state.screen = 'create'; render(); break;
              case 'go-join': state.screen = 'join'; render(); break;
              case 'select-game':
                const gameId = el.dataset.gameId;
                const game = GAMES.find(g => g.id === gameId);
                if (game && !game.disabled) {
                  state.selectedGame = game;
                  state.screen = 'gameSelect';
                  render();
                }
                break;
              case 'create-room':
                state.playerName = document.getElementById('hostName')?.value || '';
                if (state.playerName.trim()) createRoom();
                else alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                break;
              case 'join-room':
                state.playerName = document.getElementById('guestName')?.value || '';
                const code = document.getElementById('roomCode')?.value?.toUpperCase() || '';
                if (state.playerName.trim() && code.length === 6) joinRoom(code);
                else alert('ë‹‰ë„¤ì„ê³¼ ë°© ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”!');
                break;
              case 'rejoin': rejoinRoom(); break;
              case 'clear-session': clearSession(); render(); break;
              case 'start-game': startGame(); break;
              case 'roll-dice': rollDice(); break;
              case 'close-mission': closeMission(false); break;
              case 'extra-roll': closeMission(true); break;
              case 'copy-code':
                navigator.clipboard.writeText(state.roomCode);
                el.innerText = 'âœ“';
                setTimeout(() => el.innerText = 'ğŸ“‹', 1000);
                break;
              case 'show-leave-confirm': state.showLeaveConfirm = true; render(); break;
              case 'hide-leave-confirm': state.showLeaveConfirm = false; render(); break;
              case 'leave-room': leaveRoom(); break;
              case 'show-kick-confirm':
                state.showKickConfirm = el.dataset.playerId;
                render();
                break;
              case 'hide-kick-confirm': state.showKickConfirm = null; render(); break;
              case 'kick-player': kickPlayer(state.showKickConfirm); break;
            }
          }, 100);
        };
      });
    }

    function renderHome() {
      const session = loadSession();

      return `
        <div class="min-h-screen flex items-center justify-center p-8 relative z-10">
          <div class="text-center max-w-4xl mx-auto">
            <div class="mb-8 animate-fade-scale">
              <span class="text-8xl">ğŸ®</span>
            </div>
            
            <h1 class="title-font text-6xl text-white mb-2 animate-fade-scale delay-100" 
                style="text-shadow: 0 4px 8px rgba(0,0,0,0.5);">
              íŒŒí‹°ê²Œì„
            </h1>
            <p class="text-xl text-indigo-200/70 mb-12 animate-fade-scale delay-200">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” ì˜¨ë¼ì¸ íŒŒí‹°ê²Œì„</p>
            
            ${session ? `
              <div class="mb-8 animate-slide-up delay-200">
                <button data-action="rejoin" data-sound="success"
                  class="btn-primary px-8 py-4 text-white font-bold text-xl rounded-2xl">
                  ğŸ”„ ë‹¤ì‹œ ì°¸ì—¬í•˜ê¸°
                </button>
                <p class="text-indigo-300/60 text-sm mt-2">
                  ${session.playerName}ë‹˜ Â· ë°© ì½”ë“œ: ${session.roomCode}
                  <button data-action="clear-session" class="ml-2 text-red-400 hover:text-red-300">âœ•</button>
                </p>
              </div>
            ` : ''}

            <h2 class="text-2xl font-bold text-white mb-6 animate-fade-scale delay-300">ê²Œì„ ì„ íƒ</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              ${GAMES.map((game, i) => `
                <div data-action="select-game" data-game-id="${game.id}" data-sound="${game.disabled ? 'error' : 'success'}"
                  class="game-card rounded-2xl p-6 cursor-pointer animate-slide-up ${game.disabled ? 'opacity-50 cursor-not-allowed' : ''}"
                  style="animation-delay: ${0.3 + i * 0.1}s; opacity: 0;">
                  <div class="text-6xl mb-4">${game.emoji}</div>
                  <h3 class="text-xl font-bold text-white mb-2">${game.name}</h3>
                  <p class="text-indigo-300/70 text-sm">${game.description}</p>
                  ${!game.disabled ? `<p class="text-indigo-400 text-xs mt-2">${game.minPlayers}-${game.maxPlayers}ëª…</p>` : ''}
                </div>
              `).join('')}
            </div>

            ${!isFirebaseReady ? `
              <div class="mt-8 p-4 bg-red-900/50 border border-red-500/50 rounded-xl text-red-200 max-w-md mx-auto animate-fade-scale delay-500">
                <p class="font-bold">âš ï¸ Firebase ì„¤ì • í•„ìš”</p>
                <p class="text-sm mt-1">ì½”ë“œ ìƒë‹¨ì˜ firebaseConfigë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderGameSelect() {
      const game = state.selectedGame;
      if (!game) { state.screen = 'home'; render(); return ''; }

      return `
        <div class="min-h-screen ${game.bgClass || 'bg-pattern'} flex items-center justify-center p-8 relative z-10">
          <div class="text-center">
            <button data-action="go-home" class="absolute top-6 left-6 btn-ghost px-4 py-2 text-white rounded-xl">
              â† ê²Œì„ ëª©ë¡
            </button>

            <div class="mb-8 animate-fade-scale">
              <span class="text-9xl animate-float">${game.emoji}</span>
            </div>
            
            <h1 class="title-font text-7xl text-white mb-2 animate-fade-scale delay-100" 
                style="text-shadow: 0 4px 8px rgba(0,0,0,0.5);">
              ${game.name}
            </h1>
            <p class="text-xl text-white/70 mb-12 animate-fade-scale delay-200">${game.description}</p>
            
            <div class="flex flex-col gap-4 max-w-sm mx-auto">
              <button data-action="go-create" data-sound="click"
                class="btn-beer w-full py-5 px-8 text-white font-bold text-xl rounded-2xl animate-slide-left delay-300">
                ğŸ® ë°© ë§Œë“¤ê¸°
              </button>
              <button data-action="go-join"
                class="btn-secondary w-full py-5 px-8 text-white font-bold text-xl rounded-2xl animate-slide-right delay-400">
                ğŸšª ì°¸ê°€í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderCreate() {
      const game = state.selectedGame;
      return `
        <div class="min-h-screen ${game?.bgClass || 'bg-pattern'} flex items-center justify-center p-8 relative z-10">
          <div class="card-dark rounded-3xl p-8 max-w-md w-full animate-fade-scale">
            <button data-action="go-gameselect" class="text-indigo-400/70 hover:text-indigo-300 mb-4 flex items-center gap-2">
              <span>â†</span> <span>ë’¤ë¡œ</span>
            </button>
            
            <div class="text-center mb-6">
              <span class="text-5xl">${game?.emoji || 'ğŸ®'}</span>
              <h2 class="title-font text-3xl text-white mt-2">ë°© ë§Œë“¤ê¸°</h2>
            </div>
            
            <div class="space-y-4">
              <div class="animate-slide-up delay-100">
                <label class="block text-indigo-300 font-bold mb-2">ë‹‰ë„¤ì„</label>
                <input type="text" id="hostName" maxlength="10" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                  class="input-dark w-full px-4 py-3 rounded-xl text-lg"
                  value="${state.playerName}">
              </div>
              
              <button data-action="create-room" data-sound="success"
                class="btn-primary w-full py-4 text-white font-bold text-xl rounded-2xl animate-slide-up delay-200">
                ğŸ² ë°© ìƒì„±í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderJoin() {
      const game = state.selectedGame;
      return `
        <div class="min-h-screen ${game?.bgClass || 'bg-pattern'} flex items-center justify-center p-8 relative z-10">
          <div class="card-dark rounded-3xl p-8 max-w-md w-full animate-fade-scale">
            <button data-action="go-gameselect" class="text-indigo-400/70 hover:text-indigo-300 mb-4 flex items-center gap-2">
              <span>â†</span> <span>ë’¤ë¡œ</span>
            </button>
            
            <div class="text-center mb-6">
              <span class="text-5xl">${game?.emoji || 'ğŸ®'}</span>
              <h2 class="title-font text-3xl text-white mt-2">ë°© ì°¸ê°€í•˜ê¸°</h2>
            </div>
            
            <div class="space-y-4">
              <div class="animate-slide-up delay-100">
                <label class="block text-indigo-300 font-bold mb-2">ë‹‰ë„¤ì„</label>
                <input type="text" id="guestName" maxlength="10" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
                  class="input-dark w-full px-4 py-3 rounded-xl text-lg"
                  value="${state.playerName}">
              </div>
              
              <div class="animate-slide-up delay-200">
                <label class="block text-indigo-300 font-bold mb-2">ë°© ì½”ë“œ</label>
                <input type="text" id="roomCode" maxlength="6" placeholder="6ìë¦¬ ì½”ë“œ"
                  class="input-dark w-full px-4 py-3 rounded-xl text-lg text-center tracking-[0.3em] uppercase font-mono">
              </div>
              
              <button data-action="join-room" data-sound="join"
                class="btn-primary w-full py-4 text-white font-bold text-xl rounded-2xl animate-slide-up delay-300">
                ğŸš€ ì…ì¥í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderLobby() {
      if (!state.room) return '<div class="min-h-screen flex items-center justify-center"><span class="text-white text-2xl">ë¡œë”© ì¤‘...</span></div>';
      
      const game = state.selectedGame;
      const players = Object.values(state.room.players || {}).sort((a, b) => a.order - b.order);
      
      return `
        <div class="min-h-screen ${game?.bgClass || 'bg-pattern'} flex items-center justify-center p-8 relative z-10">
          <div class="card-dark rounded-3xl p-8 max-w-lg w-full animate-fade-scale">
            <div class="flex justify-between items-start mb-4">
              <div></div>
              <button data-action="show-leave-confirm" class="btn-ghost px-3 py-1 text-red-400 hover:text-red-300 rounded-lg text-sm">
                ğŸšª ë‚˜ê°€ê¸°
              </button>
            </div>
            
            <div class="text-center mb-6">
              <span class="text-5xl">${game?.emoji || 'ğŸ®'}</span>
              <h2 class="title-font text-3xl text-white mt-2">ëŒ€ê¸°ì‹¤</h2>
              <div class="flex items-center justify-center gap-3 mt-4">
                <span class="text-indigo-300/70">ë°© ì½”ë“œ</span>
                <span class="text-2xl font-black text-indigo-400 tracking-[0.2em] font-mono bg-black/30 px-4 py-1 rounded-lg">${state.roomCode}</span>
                <button data-action="copy-code" class="text-indigo-400/70 hover:text-indigo-300 text-xl">ğŸ“‹</button>
              </div>
            </div>
            
            <div class="mb-6">
              <p class="text-indigo-300/70 text-center mb-3">ì°¸ê°€ì (${players.length}/8)</p>
              <div class="grid grid-cols-2 gap-3">
                ${players.map((p, i) => `
                  <div class="player-item flex items-center gap-3 p-3 rounded-xl transition-all ${p.id === state.playerId ? 'bg-indigo-500/20 ring-2 ring-indigo-500' : 'bg-black/20'} ${!p.connected ? 'opacity-50' : ''}">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg player-token"
                      style="background-color: ${PLAYER_COLORS[i]}">
                      ${p.name[0]}
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="font-bold text-white truncate">${p.name}</p>
                      <div class="flex items-center gap-1">
                        ${p.id === state.room.hostId ? '<span class="text-xs text-amber-400">ğŸ‘‘ ë°©ì¥</span>' : ''}
                        ${p.id === state.playerId ? '<span class="text-xs text-green-400">â† ë‚˜</span>' : ''}
                        ${!p.connected ? '<span class="text-xs text-red-400">âš ï¸</span>' : ''}
                      </div>
                    </div>
                    ${state.isHost && p.id !== state.playerId ? `
                      <button data-action="show-kick-confirm" data-player-id="${p.id}" 
                        class="kick-btn text-red-400 hover:text-red-300 text-sm px-2 py-1 rounded hover:bg-red-500/20">
                        ì¶”ë°©
                      </button>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
            
            ${state.isHost ? `
              <button data-action="start-game" data-sound="success"
                ${players.length < 2 ? 'disabled' : ''}
                class="w-full py-4 font-bold text-xl rounded-2xl transition-all ${players.length < 2 
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed' 
                  : 'btn-primary text-white'}">
                ${players.length < 2 ? 'â³ ìµœì†Œ 2ëª… í•„ìš”' : 'ğŸ® ê²Œì„ ì‹œì‘!'}
              </button>
            ` : `
              <div class="text-center py-4 text-indigo-300/70 bg-black/20 rounded-xl">
                <span class="animate-pulse">â³ ë°©ì¥ì´ ê²Œì„ì„ ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤...</span>
              </div>
            `}
          </div>
          
          ${state.showLeaveConfirm ? renderLeaveConfirmModal() : ''}
          ${state.showKickConfirm ? renderKickConfirmModal() : ''}
        </div>
      `;
    }

    function renderGame() {
      if (!state.room) return '';
      
      const game = state.selectedGame;
      const room = state.room;
      const players = Object.values(room.players).sort((a, b) => a.order - b.order);
      const currentPlayer = players[room.currentTurn];
      const isMyTurn = currentPlayer?.id === state.playerId;
      const tileSize = 80;
      const gap = 4;

      return `
        <div class="min-h-screen ${game?.bgClass || 'bg-pattern'} p-4 lg:p-6 relative z-10">
          <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4">
              <div></div>
              <h1 class="title-font text-4xl lg:text-5xl text-amber-400" style="text-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                ${game?.emoji || 'ğŸ®'} ${game?.name || 'ê²Œì„'} ${game?.emoji || 'ğŸ®'}
              </h1>
              <button data-action="show-leave-confirm" class="btn-ghost px-4 py-2 text-red-400 hover:text-red-300 rounded-xl">
                ğŸšª ë‚˜ê°€ê¸°
              </button>
            </div>
            
            <div class="flex flex-col xl:flex-row items-center xl:items-start justify-center gap-6">
              <!-- ê²Œì„ ë³´ë“œ -->
              <div class="relative rounded-3xl p-3 shadow-2xl card-wood" 
                style="width: ${(tileSize + gap) * 7 + 24}px; height: ${(tileSize + gap) * 7 + 24}px;">
                
                <div class="absolute rounded-2xl flex items-center justify-center bg-gradient-to-br from-amber-900/50 to-amber-950/50 border border-amber-700/30"
                  style="left: ${tileSize + gap + 12}px; top: ${tileSize + gap + 12}px; width: ${(tileSize + gap) * 5 - gap}px; height: ${(tileSize + gap) * 5 - gap}px;">
                  <div class="text-center">
                    <div class="text-5xl mb-2 ${room.rolling ? 'animate-pour' : ''}">${game?.emoji || 'ğŸ®'}</div>
                    <div class="title-font text-2xl text-amber-400">${game?.name || 'ê²Œì„'}</div>
                    ${room.rolling ? '<p class="text-amber-300/70 text-sm mt-2 animate-pulse">ì£¼ì‚¬ìœ„ êµ´ë¦¬ëŠ” ì¤‘...</p>' : ''}
                  </div>
                </div>

                ${TILES.map((tile, index) => {
                  const pos = getTilePosition(index);
                  const playersHere = players.filter(p => p.position === index);
                  
                  return `
                    <div class="absolute rounded-xl flex flex-col items-center justify-center tile-${tile.type} border border-white/20"
                      style="width: ${tileSize}px; height: ${tileSize}px; left: ${pos.x * (tileSize + gap) + 12}px; top: ${pos.y * (tileSize + gap) + 12}px;">
                      <span class="text-xl">${tile.emoji}</span>
                      <span class="text-[10px] font-bold text-white text-center leading-tight px-1 drop-shadow">${tile.name}</span>
                      
                      ${playersHere.map((p, pi) => {
                        const pIndex = players.findIndex(pl => pl.id === p.id);
                        const [ox, oy] = getPlayerOffset(pi, playersHere.length);
                        const isMoving = room.lastAction?.playerId === p.id && Date.now() - room.lastAction?.timestamp < 1000;
                        return `
                          <div class="absolute w-7 h-7 rounded-full flex items-center justify-center text-[10px] font-bold text-white player-token ${isMoving ? 'animate-move' : ''}"
                            style="background-color: ${PLAYER_COLORS[pIndex]}; transform: translate(${ox}px, ${oy}px); z-index: 10;">
                            ${p.name[0]}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  `;
                }).join('')}
              </div>

              <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
              <div class="card-wood rounded-3xl p-5 shadow-xl w-full xl:w-80">
                <div class="text-center mb-5 p-4 rounded-2xl ${isMyTurn ? 'bg-amber-500/20 animate-pulse-glow' : 'bg-black/20'}">
                  <p class="text-amber-300/70 text-sm mb-1">í˜„ì¬ ì°¨ë¡€</p>
                  <p class="text-2xl font-black ${isMyTurn ? 'text-amber-400' : 'text-amber-100'}">${currentPlayer?.name || ''}</p>
                  ${isMyTurn ? '<p class="text-amber-400 text-sm mt-1">ğŸ² ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ì„¸ìš”!</p>' : '<p class="text-amber-300/50 text-sm mt-1">ì°¨ë¡€ë¥¼ ê¸°ë‹¤ë¦¬ì„¸ìš”...</p>'}
                </div>
                
                <div class="flex justify-center mb-5">
                  <button data-action="roll-dice" data-sound="dice"
                    ${!isMyTurn || room.rolling ? 'disabled' : ''}
                    class="relative w-24 h-24 bg-gradient-to-br from-cream to-warmgray rounded-2xl shadow-xl border-4 ${isMyTurn && !room.rolling ? 'border-amber-500 hover:scale-110 hover:rotate-6 cursor-pointer' : 'border-gray-600 opacity-50 cursor-not-allowed'} transition-all ${room.rolling ? 'animate-dice-roll' : ''}">
                    <svg viewBox="0 0 100 100" class="w-full h-full p-2">
                      ${renderDiceDots(state.localDiceValue)}
                    </svg>
                  </button>
                </div>
                
                ${room.rolling ? `
                  <div class="text-center mb-4 text-amber-300 animate-pulse">
                    ğŸ² ${currentPlayer?.name}ë‹˜ì´ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ëŠ” ì¤‘...
                  </div>
                ` : ''}

                <div class="border-t border-amber-700/30 pt-4">
                  <p class="text-amber-300/70 text-sm mb-3 text-center">í”Œë ˆì´ì–´ í˜„í™©</p>
                  <div class="space-y-2 max-h-52 overflow-y-auto pr-1">
                    ${players.map((p, index) => `
                      <div class="flex items-center gap-3 px-3 py-2 rounded-xl transition-all ${p.id === currentPlayer?.id ? 'bg-amber-500/20 scale-[1.02]' : 'bg-black/20'} ${p.id === state.playerId ? 'ring-1 ring-amber-500/50' : ''} ${!p.connected ? 'opacity-50' : ''}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold player-token"
                          style="background-color: ${PLAYER_COLORS[index]}">
                          ${p.name[0]}
                        </div>
                        <span class="flex-1 font-medium ${p.id === currentPlayer?.id ? 'text-amber-400' : 'text-amber-100'}">
                          ${p.name} ${p.id === state.playerId ? '<span class="text-green-400 text-xs">(ë‚˜)</span>' : ''}
                        </span>
                        <span class="text-amber-300/50 text-sm">${p.position}ì¹¸</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
                
                ${room.lastAction ? `
                  <div class="mt-4 pt-4 border-t border-amber-700/30">
                    <p class="text-amber-300/50 text-xs text-center">
                      ğŸ² ${room.lastAction.playerName}ë‹˜ì´ ${room.lastAction.value}ì„(ë¥¼) êµ´ë ¤ ${room.lastAction.newPosition}ë²ˆ ì¹¸ìœ¼ë¡œ ì´ë™
                    </p>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>

          ${room.showMission && room.currentTileId !== null ? renderMissionModal() : ''}
          ${state.showLeaveConfirm ? renderLeaveConfirmModal() : ''}
        </div>
      `;
    }

    function renderDiceDots(value) {
      const dots = {
        1: [[50, 50]],
        2: [[30, 30], [70, 70]],
        3: [[30, 30], [50, 50], [70, 70]],
        4: [[30, 30], [70, 30], [30, 70], [70, 70]],
        5: [[30, 30], [70, 30], [50, 50], [30, 70], [70, 70]],
        6: [[30, 30], [70, 30], [30, 50], [70, 50], [30, 70], [70, 70]],
      };
      
      return (dots[value] || dots[1]).map(([cx, cy]) => 
        `<circle cx="${cx}" cy="${cy}" r="9" fill="#8B5A14" stroke="#6B4512" stroke-width="1"/>`
      ).join('');
    }

    function renderMissionModal() {
      const room = state.room;
      const tile = TILES[room.currentTileId];
      if (!tile) return '';
      
      const players = Object.values(room.players).sort((a, b) => a.order - b.order);
      const currentPlayer = players[room.currentTurn];
      const isMyTurn = currentPlayer?.id === state.playerId;
      
      const colors = {
        drink: 'from-amber-600 to-orange-700',
        game: 'from-emerald-600 to-green-700',
        bonus: 'from-blue-600 to-indigo-700',
        move: 'from-purple-600 to-pink-700',
        special: 'from-yellow-500 to-amber-600',
        free: 'from-gray-500 to-gray-600',
        start: 'from-emerald-600 to-green-700'
      };
      
      const color = colors[tile.type] || colors.drink;
      let description = tile.description;
      
      if (tile.name === 'ëœë¤ê²Œì„' && room.missionRandomGame) {
        description = room.missionRandomGame;
      }

      return `
        <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
          <div class="relative animate-bounce-in">
            <div class="absolute -inset-4 bg-gradient-to-r ${color} rounded-3xl blur-xl opacity-60"></div>
            <div class="relative card-wood rounded-3xl p-8 max-w-sm w-full text-center">
              <div class="text-7xl mb-4">${tile.emoji}</div>
              <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r ${color} mb-2">
                ${tile.name}
              </h2>
              <p class="text-amber-300 mb-4">
                <span class="text-amber-400 font-bold">${currentPlayer?.name}</span>ë‹˜ì˜ ë¯¸ì…˜!
              </p>
              <div class="bg-black/30 rounded-2xl p-4 mb-6 border border-amber-700/30">
                <p class="text-amber-100 text-lg font-medium">${description}</p>
              </div>
              
              ${isMyTurn ? `
                <div class="flex gap-3">
                  ${tile.type === 'bonus' ? `
                    <button data-action="extra-roll" data-sound="success"
                      class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-xl hover:scale-105 transition-transform shadow-lg">
                      ğŸ² í•œ ë²ˆ ë”!
                    </button>
                  ` : ''}
                  <button data-action="close-mission"
                    class="flex-1 py-3 bg-gradient-to-r ${color} text-white font-bold rounded-xl hover:scale-105 transition-transform shadow-lg">
                    ${tile.type === 'bonus' ? 'ë„˜ì–´ê°€ê¸°' : 'í™•ì¸!'}
                  </button>
                </div>
              ` : `
                <div class="py-3 bg-black/30 text-amber-300/70 rounded-xl border border-amber-700/30">
                  â³ ${currentPlayer?.name}ë‹˜ì´ í™•ì¸ ì¤‘...
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    function renderLeaveConfirmModal() {
      return `
        <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
          <div class="card-dark rounded-2xl p-6 max-w-sm w-full text-center animate-bounce-in">
            <div class="text-5xl mb-4">ğŸšª</div>
            <h3 class="text-xl font-bold text-white mb-2">ì •ë§ ë‚˜ê°€ì‹œê² ì–´ìš”?</h3>
            <p class="text-indigo-300/70 text-sm mb-6">ë‚˜ê°€ë©´ ë‹¤ì‹œ ì°¸ì—¬í•  ìˆ˜ ì—†ì–´ìš”!</p>
            <div class="flex gap-3">
              <button data-action="hide-leave-confirm" class="flex-1 py-3 btn-secondary text-white font-bold rounded-xl">
                ì·¨ì†Œ
              </button>
              <button data-action="leave-room" data-sound="kick" class="flex-1 py-3 btn-danger text-white font-bold rounded-xl">
                ë‚˜ê°€ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderKickConfirmModal() {
      const player = state.room?.players?.[state.showKickConfirm];
      if (!player) return '';

      return `
        <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
          <div class="card-dark rounded-2xl p-6 max-w-sm w-full text-center animate-bounce-in">
            <div class="text-5xl mb-4">âš ï¸</div>
            <h3 class="text-xl font-bold text-white mb-2">${player.name}ë‹˜ì„ ì¶”ë°©í• ê¹Œìš”?</h3>
            <p class="text-indigo-300/70 text-sm mb-6">ì¶”ë°©ëœ í”Œë ˆì´ì–´ëŠ” ë‹¤ì‹œ ì°¸ì—¬í•  ìˆ˜ ì—†ì–´ìš”.</p>
            <div class="flex gap-3">
              <button data-action="hide-kick-confirm" class="flex-1 py-3 btn-secondary text-white font-bold rounded-xl">
                ì·¨ì†Œ
              </button>
              <button data-action="kick-player" data-sound="kick" class="flex-1 py-3 btn-danger text-white font-bold rounded-xl">
                ì¶”ë°©í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ì´ˆê¸° ë Œë”ë§
    render();
  </script>
</body>
</html>
