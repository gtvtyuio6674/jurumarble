<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ® íŒŒí‹°ê²Œì„ - ì˜¨ë¼ì¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    *{font-family:'Noto Sans KR',sans-serif}.title-font{font-family:'Black Han Sans',sans-serif}
    .bg-party{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%)}
    .bg-beer{background:#2C2416;background-image:radial-gradient(ellipse at 20% 30%,rgba(244,168,54,0.15) 0%,transparent 50%),radial-gradient(ellipse at 80% 70%,rgba(244,168,54,0.1) 0%,transparent 50%)}
    .bg-roulette{background:linear-gradient(135deg,#0a000f 0%,#150822 25%,#1a0a2e 50%,#150822 75%,#0a000f 100%)}
    .bg-liar{background:linear-gradient(135deg,#0f0c1a 0%,#1a1525 50%,#0d0a14 100%)}
    @keyframes float{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-15px) rotate(2deg)}}
    @keyframes float-reverse{0%,100%{transform:translateY(0) rotate(2deg)}50%{transform:translateY(-20px) rotate(-2deg)}}
    @keyframes bounce-in{0%{transform:scale(0.3);opacity:0}50%{transform:scale(1.05)}70%{transform:scale(0.9)}100%{transform:scale(1);opacity:1}}
    @keyframes fade-scale{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
    @keyframes slide-up{0%{transform:translateY(50px);opacity:0}100%{transform:translateY(0);opacity:1}}
    @keyframes dice-roll{0%{transform:rotate(0deg) scale(1)}25%{transform:rotate(20deg) scale(1.15)}50%{transform:rotate(-20deg) scale(1.1)}75%{transform:rotate(10deg) scale(1.15)}100%{transform:rotate(0deg) scale(1)}}
    @keyframes move-token{0%{transform:scale(1)}50%{transform:scale(1.3) translateY(-10px)}100%{transform:scale(1)}}
    @keyframes result-pop{0%{transform:scale(0) rotate(-180deg);opacity:0}50%{transform:scale(1.2) rotate(10deg)}100%{transform:scale(1) rotate(0deg);opacity:1}}
    @keyframes golden-glow{0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.5),0 0 40px rgba(255,215,0,0.3)}50%{box-shadow:0 0 40px rgba(255,215,0,0.8),0 0 60px rgba(255,215,0,0.5)}}
    @keyframes sparkle{0%,100%{opacity:0;transform:scale(0)}50%{opacity:1;transform:scale(1)}}
    @keyframes winner-glow{0%,100%{text-shadow:0 0 10px currentColor,0 0 20px currentColor}50%{text-shadow:0 0 20px currentColor,0 0 40px currentColor,0 0 60px currentColor}}
    .animate-float{animation:float 4s ease-in-out infinite}
    .animate-float-reverse{animation:float-reverse 5s ease-in-out infinite}
    .animate-bounce-in{animation:bounce-in 0.5s ease-out}
    .animate-fade-scale{animation:fade-scale 0.6s ease-out forwards}
    .animate-slide-up{animation:slide-up 0.5s ease-out forwards}
    .animate-dice-roll{animation:dice-roll 0.15s ease-in-out infinite}
    .animate-move{animation:move-token 0.5s ease-out}
    .animate-result-pop{animation:result-pop 0.6s ease-out forwards}
    .animate-golden-glow{animation:golden-glow 1.5s ease-in-out infinite}
    .animate-sparkle{animation:sparkle 2s ease-in-out infinite}
    .animate-winner{animation:winner-glow 1s ease-in-out infinite}
    .delay-100{animation-delay:0.1s;opacity:0}.delay-200{animation-delay:0.2s;opacity:0}.delay-300{animation-delay:0.3s;opacity:0}
    .card-wood{background:linear-gradient(145deg,#4A3728 0%,#3D2E1F 50%,#2C2416 100%);border:3px solid #5D4634;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    .card-dark{background:linear-gradient(145deg,#2d2d44 0%,#1a1a2e 50%,#16162a 100%);border:2px solid #3d3d5c;box-shadow:0 10px 30px rgba(0,0,0,0.4)}
    .card-purple{background:linear-gradient(145deg,#1a0a2e 0%,#150820 50%,#0d0015 100%);border:2px solid #4c2882;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .card-golden{background:linear-gradient(145deg,#b8860b 0%,#daa520 50%,#ffd700 100%);border:3px solid #ffec8b}
    .card-liar{background:linear-gradient(145deg,#1f1a2e 0%,#15101f 50%,#0a0510 100%);border:2px solid #4a3d6a;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .game-card{background:linear-gradient(145deg,rgba(255,255,255,0.15) 0%,rgba(255,255,255,0.05) 100%);border:2px solid rgba(255,255,255,0.2);transition:all 0.4s}
    .game-card:hover{transform:translateY(-10px) scale(1.03);border-color:rgba(255,255,255,0.5);box-shadow:0 25px 50px rgba(0,0,0,0.4),0 0 30px var(--glow)}
    .tile-drink{background:linear-gradient(135deg,#D97706 0%,#B45309 100%)}.tile-game{background:linear-gradient(135deg,#059669 0%,#047857 100%)}
    .tile-bonus{background:linear-gradient(135deg,#2563EB 0%,#1D4ED8 100%)}.tile-move{background:linear-gradient(135deg,#7C3AED 0%,#6D28D9 100%)}
    .tile-special{background:linear-gradient(135deg,#F59E0B 0%,#D97706 100%)}.tile-free{background:linear-gradient(135deg,#6B7280 0%,#4B5563 100%)}
    .tile-start{background:linear-gradient(135deg,#10B981 0%,#059669 100%)}.tile-performance{background:linear-gradient(135deg,#EC4899 0%,#DB2777 100%)}
    .btn-primary{background:linear-gradient(180deg,#6366f1 0%,#4f46e5 100%);border:2px solid #4338ca;box-shadow:0 4px 0 #3730a3}
    .btn-beer{background:linear-gradient(180deg,#F4A836 0%,#D4891C 100%);border:2px solid #B8731A;box-shadow:0 4px 0 #8B5A14}
    .btn-purple{background:linear-gradient(180deg,#a855f7 0%,#9333ea 100%);border:2px solid #7e22ce;box-shadow:0 4px 0 #6b21a8}
    .btn-liar{background:linear-gradient(180deg,#ef4444 0%,#dc2626 100%);border:2px solid #b91c1c;box-shadow:0 4px 0 #991b1b}
    .btn-danger{background:linear-gradient(180deg,#ef4444 0%,#dc2626 100%);border:2px solid #b91c1c;box-shadow:0 4px 0 #991b1b}
    .btn-secondary{background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.3)}
    .btn-ghost{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)}
    .input-dark{background:rgba(0,0,0,0.5);border:2px solid rgba(139,92,246,0.3);color:white}
    .input-dark:focus{border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.2);outline:none}
    .input-beer{background:rgba(0,0,0,0.3);border:2px solid rgba(244,168,54,0.3);color:white}
    .input-beer:focus{border-color:#F4A836;box-shadow:0 0 0 3px rgba(244,168,54,0.3);outline:none}
    .input-liar{background:rgba(0,0,0,0.4);border:2px solid rgba(239,68,68,0.3);color:white}
    .input-liar:focus{border-color:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,0.2);outline:none}
    .player-token{box-shadow:0 3px 6px rgba(0,0,0,0.4),inset 0 2px 4px rgba(255,255,255,0.3);border:2px solid rgba(255,255,255,0.5)}
    .roulette-wheel{transition:transform 4s cubic-bezier(0.2,0.8,0.3,1)}
    .roulette-wheel.reset{transition:none !important}
    .kick-btn{opacity:0;transition:opacity 0.2s}.player-item:hover .kick-btn{opacity:1}
    .sparkle-container{position:absolute;inset:0;pointer-events:none;overflow:hidden}
    .sparkle{position:absolute;border-radius:50%}
    .liar-card-container{perspective:1000px}
    .liar-card-inner{position:relative;width:100%;height:100%;transition:transform 0.8s;transform-style:preserve-3d}
    .liar-card-inner.flipped{transform:rotateY(180deg)}
    .liar-card-front,.liar-card-back{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:1rem}
    .liar-card-back{transform:rotateY(180deg)}
    .vote-bar{transition:width 1s ease-out}
    .update-scroll{max-height:60vh;overflow-y:auto}
    .update-scroll::-webkit-scrollbar{width:6px}
    .update-scroll::-webkit-scrollbar-track{background:rgba(0,0,0,0.2);border-radius:3px}
    .update-scroll::-webkit-scrollbar-thumb{background:rgba(139,92,246,0.5);border-radius:3px}
  </style>
</head>
<body class="min-h-screen">
<div id="app"></div>
<script>
const AudioCtx=window.AudioContext||window.webkitAudioContext;let audioCtx=null;
function initAudio(){if(!audioCtx)audioCtx=new AudioCtx()}
function playSound(type){initAudio();if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);const t=audioCtx.currentTime;const sounds={click:()=>{o.frequency.setValueAtTime(800,t);o.frequency.exponentialRampToValueAtTime(600,t+0.1);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start();o.stop(t+0.1)},success:()=>{o.frequency.setValueAtTime(523,t);o.frequency.setValueAtTime(659,t+0.1);o.frequency.setValueAtTime(784,t+0.2);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.start();o.stop(t+0.3)},spin:()=>{o.type='sawtooth';o.frequency.setValueAtTime(100,t);o.frequency.exponentialRampToValueAtTime(2000,t+0.5);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);o.start();o.stop(t+0.5)},win:()=>{[523,659,784,1047].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.3,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);os.start();os.stop(audioCtx.currentTime+0.2)},i*100)})},dice:()=>{o.type='square';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(800,t+0.05);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start();o.stop(t+0.1)},mission:()=>{o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(800,t+0.15);g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);o.start();o.stop(t+0.2)},join:()=>{o.frequency.setValueAtTime(600,t);o.frequency.setValueAtTime(800,t+0.1);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);o.start();o.stop(t+0.2)},kick:()=>{o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(150,t+0.3);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);o.start();o.stop(t+0.3)},golden:()=>{[880,1108,1318,1760].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.2,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);os.start();os.stop(audioCtx.currentTime+0.15)},i*80)})},reveal:()=>{[392,494,587,784].forEach((f,i)=>{setTimeout(()=>{const os=audioCtx.createOscillator(),ga=audioCtx.createGain();os.connect(ga);ga.connect(audioCtx.destination);os.frequency.setValueAtTime(f,audioCtx.currentTime);ga.gain.setValueAtTime(0.25,audioCtx.currentTime);ga.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.25);os.start();os.stop(audioCtx.currentTime+0.25)},i*120)})},wrong:()=>{o.type='sawtooth';o.frequency.setValueAtTime(200,t);o.frequency.linearRampToValueAtTime(80,t+0.4);g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);o.start();o.stop(t+0.4)},vote:()=>{o.frequency.setValueAtTime(600,t);o.frequency.setValueAtTime(700,t+0.05);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);o.start();o.stop(t+0.1)}};if(sounds[type])sounds[type]()}

const firebaseConfig={apiKey:"AIzaSyCafzk3QueRsvj4DiMht6bTyHs0_HT5Iuc",authDomain:"test-e3974.firebaseapp.com",databaseURL:"https://test-e3974-default-rtdb.firebaseio.com",projectId:"test-e3974",storageBucket:"test-e3974.firebasestorage.app",messagingSenderId:"572983111486",appId:"1:572983111486:web:ce4e3f897f8faa66c4866f"};
let db=null,isFirebaseReady=false;
try{firebase.initializeApp(firebaseConfig);db=firebase.database();isFirebaseReady=true}catch(e){}

const UPDATE_LOGS=[
  {date:"2025ë…„ 12ì›” 10ì¼",version:"v1.2.0",changes:["ğŸ¡ ë£°ë › í•­ëª© ì‹¤ì‹œê°„ ë°˜ì˜","ğŸ¡ ë£°ë › íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ê°œì„ ","ğŸ¡ ê²°ê³¼ íœ  ì•„ë˜ í‘œì‹œë¡œ ë³€ê²½","ğŸ­ ë¼ì´ì–´ ê²Œì„ ì™„ì „ êµ¬í˜„ (4-10ëª…)","ğŸº ì£¼ë£¨ë§ˆë¸” 12ëª… í™•ì¥ & 32ì¹¸","ğŸº í¼í¬ë¨¼ìŠ¤ íƒ€ì¼ 8ì¢… ì¶”ê°€","ğŸ“‹ ì—…ë°ì´íŠ¸ ë‚´ì—­ ê¸°ëŠ¥ ì¶”ê°€"]},
  {date:"2025ë…„ 12ì›” 9ì¼",version:"v1.1.0",changes:["ğŸ”‘ í™©ê¸ˆì—´ì‡  ì¹´ë“œ 18ì¢…","ğŸ² ì£¼ì‚¬ìœ„ ì• ë‹ˆë©”ì´ì…˜ ê°œì„ ","ğŸ‘¥ ê°•í‡´ ê¸°ëŠ¥","ğŸ”Š ì‚¬ìš´ë“œ íš¨ê³¼"]},
  {date:"2025ë…„ 12ì›” 8ì¼",version:"v1.0.0",changes:["ğŸ® íŒŒí‹°ê²Œì„ ìµœì´ˆ ì¶œì‹œ!","ğŸº ì£¼ë£¨ë§ˆë¸”","ğŸ¡ ë£°ë ›","ğŸ”¥ Firebase ë©€í‹°í”Œë ˆì´"]}
];

const GAMES=[
  {id:'jurumarble',name:'ì£¼ë£¨ë§ˆë¸”',emoji:'ğŸº',desc:'ìˆ ì´ ìˆ ìˆ  ë„˜ì–´ê°€ëŠ” ë³´ë“œê²Œì„',color:'from-amber-500 to-orange-600',glow:'rgba(244,168,54,0.4)',bg:'bg-beer',min:2,max:12},
  {id:'roulette',name:'ë£°ë ›',emoji:'ğŸ¡',desc:'ìš´ëª…ì˜ ì›íŒ ëŒë¦¬ê¸°!',color:'from-purple-500 to-pink-600',glow:'rgba(168,85,247,0.4)',bg:'bg-roulette',solo:true},
  {id:'liar',name:'ë¼ì´ì–´ ê²Œì„',emoji:'ğŸ­',desc:'ê±°ì§“ë§ìŸì´ë¥¼ ì°¾ì•„ë¼!',color:'from-red-500 to-rose-600',glow:'rgba(239,68,68,0.4)',bg:'bg-liar',min:4,max:10}
];

const GOLDEN_KEYS=[
  {emoji:'ğŸº',text:'ëª¨ë‘ í•œ ì”ì”©!',type:'all-drink'},{emoji:'ğŸ‰',text:'ì´ë²ˆ í„´ ë©´ì œ!',type:'skip'},{emoji:'ğŸ’¸',text:'ë²Œê¸ˆ 1000ì›',type:'penalty'},
  {emoji:'ğŸ”„',text:'ì™¼ìª½ ì‚¬ëŒê³¼ ìë¦¬ êµí™˜',type:'swap'},{emoji:'ğŸ»',text:'ì§€ëª©í•œ ì‚¬ëŒê³¼ ê±´ë°°!',type:'cheers'},{emoji:'ğŸ‘‘',text:'ë‹¤ìŒ ë²Œì¹™ ë©´ì œê¶Œ!',type:'immunity'},
  {emoji:'ğŸ²',text:'ì£¼ì‚¬ìœ„ í•œ ë²ˆ ë”!',type:'extra-roll'},{emoji:'â®ï¸',text:'3ì¹¸ ë’¤ë¡œ',type:'back-3'},{emoji:'â­ï¸',text:'3ì¹¸ ì•ìœ¼ë¡œ',type:'forward-3'},
  {emoji:'ğŸƒ',text:'ì˜¤ë¥¸ìª½ ì‚¬ëŒ ëŒ€ì‹  ë²Œì¹™',type:'take-penalty'},{emoji:'ğŸ’°',text:'100ì›ì”© ë°›ê¸°',type:'collect'},{emoji:'ğŸ¤',text:'ë…¸ë˜ í•œ ì†Œì ˆ',type:'sing'},
  {emoji:'ğŸ¤¸',text:'ì§€ëª©í•´ì„œ 2ì”!',type:'point-drink'},{emoji:'ğŸ˜ˆ',text:'ëˆˆì¹˜ê²Œì„! ê¼´ì°Œ 2ì”',type:'nunchi'},{emoji:'ğŸ”€',text:'ì „ì› ìë¦¬ ì„ê¸°',type:'shuffle'},
  {emoji:'ğŸ¾',text:'ì•„ë¬´ì¼ë„ ì—†ìŒ!',type:'nothing'},{emoji:'â˜ ï¸',text:'í˜¼ì 3ì”!',type:'solo-3'},{emoji:'ğŸ’€',text:'ì¶œë°œì ìœ¼ë¡œ!',type:'go-start'}
];

const TILES=[
  {id:0,name:"ì¶œë°œ",type:"start",emoji:"ğŸš€",desc:"ê²Œì„ ì‹œì‘!"},{id:1,name:"ë§ì€í¸ ì§ ",type:"drink",emoji:"ğŸ»",desc:"ë§ì€í¸ê³¼ ê±´ë°°!"},
  {id:2,name:"ì• êµ 3ì´ˆ",type:"performance",emoji:"ğŸ¥°",desc:"ê·€ì—¬ìš´ ì• êµ 3ì´ˆ!"},{id:3,name:"3.6.9",type:"game",emoji:"ğŸ‘",desc:"í‹€ë¦¬ë©´ ë²Œì£¼!"},
  {id:4,name:"í‘ê¸°ì‚¬",type:"drink",emoji:"ğŸ¦¸â€â™‚ï¸",desc:"í‘ê¸°ì‚¬ ì§€ëª©!"},{id:5,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:6,name:"007",type:"game",emoji:"ğŸ”«",desc:"007ë¹µ!"},{id:7,name:"ëŒ„ìŠ¤íƒ€ì„",type:"performance",emoji:"ğŸ’ƒ",desc:"10ì´ˆ í”„ë¦¬ëŒ„ìŠ¤!"},
  {id:8,name:"ë‹¤ê°™ì´ ì›ìƒ·",type:"drink",emoji:"ğŸ¥‚",desc:"ëª¨ë‘ ì›ìƒ·!"},{id:9,name:"ëˆˆì¹˜ê²Œì„",type:"game",emoji:"ğŸ‘€",desc:"ë§ˆì§€ë§‰ ì‚¬ëŒ ë²Œì£¼!"},
  {id:10,name:"ë’¤ë¡œ 2ì¹¸",type:"move",emoji:"â¬…ï¸",desc:"ë‘ ì¹¸ ë’¤ë¡œ!"},{id:11,name:"ì§„ì‹¤ê²Œì„",type:"game",emoji:"ğŸ’¬",desc:"ì§„ì‹¤ or ë²Œì£¼!"},
  {id:12,name:"ì‰¬ì–´ê°€ê¸°",type:"free",emoji:"ğŸ˜´",desc:"ì‰¬ì–´ê°€ì„¸ìš”~"},{id:13,name:"ëŸ¬ë¸Œìƒ·",type:"drink",emoji:"ğŸ’•",desc:"ì›í•˜ëŠ” ì‚¬ëŒê³¼!"},
  {id:14,name:"ì„±ëŒ€ëª¨ì‚¬",type:"performance",emoji:"ğŸ­",desc:"ìœ ëª…ì¸ ì„±ëŒ€ëª¨ì‚¬!"},{id:15,name:"31ê²Œì„",type:"game",emoji:"ğŸ”¢",desc:"31 ì™¸ì¹˜ë©´ ë²Œì£¼!"},
  {id:16,name:"ì§€ëª© 2ì”",type:"drink",emoji:"ğŸ‘‰",desc:"í•œ ëª… ì§€ëª©!"},{id:17,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:18,name:"ìœ™í¬ê³µê²©",type:"performance",emoji:"ğŸ˜‰",desc:"ì˜¤ë¥¸ìª½ì—ê²Œ ìœ™í¬!"},{id:19,name:"ì†ë³‘í˜¸",type:"game",emoji:"âœ‹",desc:"ì†ê°€ë½ ê±¸ê¸°!"},
  {id:20,name:"ì£¼ì‚¬ìœ„ ë”",type:"bonus",emoji:"ğŸ²",desc:"í•œ ë²ˆ ë”!"},{id:21,name:"í­íƒ„ì£¼",type:"drink",emoji:"ğŸ’£",desc:"í­íƒ„ì£¼!"},
  {id:22,name:"ì¹­ì°¬ë¦´ë ˆì´",type:"performance",emoji:"ğŸ‘",desc:"ì™¼ìª½ ì‚¬ëŒ ì¹­ì°¬!"},{id:23,name:"ì•„íŒŒíŠ¸",type:"game",emoji:"ğŸ¢",desc:"ì•„íŒŒíŠ¸ ê²Œì„!"},
  {id:24,name:"ê·€ìš”ë¯¸",type:"game",emoji:"ğŸ¥°",desc:"ê·€ìš”ë¯¸ 1~5!"},{id:25,name:"í™©ê¸ˆì—´ì‡ ",type:"special",emoji:"ğŸ”‘",desc:"í™©ê¸ˆì—´ì‡ !"},
  {id:26,name:"ë§¥ëšœ",type:"drink",emoji:"ğŸº",desc:"ëšœê»‘ íŠ•ê¸°ê¸°!"},{id:27,name:"ê³ ë°±ì—°ê¸°",type:"performance",emoji:"ğŸ’Œ",desc:"ê³ ë°±ì—°ê¸°!"},
  {id:28,name:"ëœë¤ê²Œì„",type:"game",emoji:"ğŸ°",desc:"ëœë¤ ë¯¸ë‹ˆê²Œì„!"},{id:29,name:"ë’¤ë¡œ 3ì¹¸",type:"move",emoji:"âª",desc:"ì„¸ ì¹¸ ë’¤ë¡œ!"},
  {id:30,name:"ì…€í”„ì¹­ì°¬",type:"performance",emoji:"ğŸ˜",desc:"ìê¸° ì¥ì  3ê°œ!"},{id:31,name:"ì²˜ìŒìœ¼ë¡œ",type:"move",emoji:"ğŸ”™",desc:"ì¶œë°œì ìœ¼ë¡œ!"}
];

const LIAR_TOPICS={
  'ìŒì‹':['í”¼ì','ì¹˜í‚¨','í–„ë²„ê±°','ì´ˆë°¥','ë¼ë©´','ë–¡ë³¶ì´','ì‚¼ê²¹ì‚´','ì§œì¥ë©´','ê¹€ì¹˜ì°Œê°œ','ë¶ˆê³ ê¸°','íŒŒìŠ¤íƒ€','ìŠ¤í…Œì´í¬','íƒ€ì½”','ì¹´ë ˆ','ë¹„ë¹”ë°¥'],
  'ë™ë¬¼':['ê°•ì•„ì§€','ê³ ì–‘ì´','ì‚¬ì','í˜¸ë‘ì´','ì½”ë¼ë¦¬','ê¸°ë¦°','í­ê·„','ëŒê³ ë˜','ë…ìˆ˜ë¦¬','ë±€','í† ë¼','íŒë‹¤','ê³°','ëŠ‘ëŒ€','ì—¬ìš°'],
  'ì§ì—…':['ì˜ì‚¬','ì„ ìƒë‹˜','ê²½ì°°ê´€','ì†Œë°©ê´€','ìš”ë¦¬ì‚¬','ë³€í˜¸ì‚¬','ê°€ìˆ˜','ë°°ìš°','í”„ë¡œê·¸ë˜ë¨¸','ìš´ë™ì„ ìˆ˜','í™”ê°€','ì‘ê°€','ê¸°ì','íŒŒì¼ëŸ¿','ìˆ˜ì˜ì‚¬'],
  'ì¥ì†Œ':['í•™êµ','ë³‘ì›','ê³µì›','ì˜í™”ê´€','ë„ì„œê´€','ë§ˆíŠ¸','ì¹´í˜','í•´ë³€','ë†€ì´ê³µì›','ê³µí•­','í˜¸í…”','ë°•ë¬¼ê´€','ìˆ˜ì˜ì¥','í—¬ìŠ¤ì¥','í¸ì˜ì '],
  'ì˜í™”':['ì–´ë²¤ì ¸ìŠ¤','íƒ€ì´íƒ€ë‹‰','í•´ë¦¬í¬í„°','ê²¨ìš¸ì™•êµ­','ê¸°ìƒì¶©','ì¸í„°ìŠ¤í…”ë¼','ì•„ë°”íƒ€','ë§¤íŠ¸ë¦­ìŠ¤','ë°˜ì§€ì˜ì œì™•','ìŠ¤íŒŒì´ë”ë§¨','ì¡°ì»¤','ì¸ì…‰ì…˜'],
  'ìŠ¤í¬ì¸ ':['ì¶•êµ¬','ì•¼êµ¬','ë†êµ¬','í…Œë‹ˆìŠ¤','ìˆ˜ì˜','ê³¨í”„','ë°°ë“œë¯¼í„´','íƒêµ¬','ë³¼ë§','íƒœê¶Œë„','ìŠ¤í‚¤','ìŠ¤ì¼€ì´íŠ¸','ë³µì‹±','ë°°êµ¬','ëŸ­ë¹„'],
  'ë‚˜ë¼':['í•œêµ­','ì¼ë³¸','ì¤‘êµ­','ë¯¸êµ­','ì˜êµ­','í”„ë‘ìŠ¤','ë…ì¼','ì´íƒˆë¦¬ì•„','í˜¸ì£¼','ë¸Œë¼ì§ˆ','ìºë‚˜ë‹¤','ìŠ¤í˜ì¸','ì¸ë„','ëŸ¬ì‹œì•„','ë©•ì‹œì½”'],
  'ë¸Œëœë“œ':['ì‚¼ì„±','ì• í”Œ','ë‚˜ì´í‚¤','ì•„ë””ë‹¤ìŠ¤','êµ¬ì°Œ','ìƒ¤ë„¬','ìŠ¤íƒ€ë²…ìŠ¤','ë§¥ë„ë‚ ë“œ','ì½”ì¹´ì½œë¼','í…ŒìŠ¬ë¼','ì•„ë§ˆì¡´','êµ¬ê¸€','ë„·í”Œë¦­ìŠ¤','ìœ íŠœë¸Œ']
};

const RANDOM_GAMES=["í›ˆë¯¼ì •ìŒ!","ë”¸ê¸°ê²Œì„!","ì´ˆì„±í€´ì¦ˆ!","ì—…ë‹¤ìš´!","ì§„ì‹¤orê±°ì§“!","ë¬¼ìŒí‘œê²Œì„!","ë°•ìˆ˜ì¹˜ê¸°!","ëˆˆì‹¸ì›€!"];
const PLAYER_COLORS=['#EAB308','#3B82F6','#22C55E','#EF4444','#A855F7','#F97316','#06B6D4','#EC4899','#84CC16','#F43F5E','#8B5CF6','#14B8A6'];
const ROULETTE_COLORS=['#c53030','#c05621','#b7791f','#276749','#0d9488','#2b6cb0','#6b46c1','#b83280','#c53030','#5a7a23','#0891b2','#7c3aed'];

let state={screen:'home',game:null,roomCode:null,odPlyerId:null,playerName:'',room:null,localDice:1,showLeave:false,showUpdate:false,rouletteSlots:['í•­ëª©1','í•­ëª©2','í•­ëª©3','í•­ëª©4','í•­ëª©5','í•­ëª©6'],rouletteAngle:0,rouletteSpinning:false,rouletteResult:null,rouletteResultColor:null,liarFlipped:false,liarVote:null,liarGuess:''};
let roomRef=null;

// ìœ íš¨í•œ ìŠ¬ë¡¯ ê°œìˆ˜ (ë‚´ìš©ì´ ìˆëŠ” ê²ƒë§Œ)
function getValidSlots(){
  return state.rouletteSlots.filter(s=>s&&s.trim().length>0);
}

function genCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}
function getTilePos(idx){const s=8;if(idx<s)return{x:s-idx,y:0};if(idx<s*2)return{x:0,y:idx-s};if(idx<s*3)return{x:idx-s*2,y:s};return{x:s,y:s*4-idx}}
function getOffset(i){const o=[[-8,-8],[8,-8],[-8,8],[8,8],[0,-12],[0,12],[-12,0],[12,0]];return o[i%8]}
function diceDots(v){const d={1:[[50,50]],2:[[30,30],[70,70]],3:[[30,30],[50,50],[70,70]],4:[[30,30],[70,30],[30,70],[70,70]],5:[[30,30],[70,30],[50,50],[30,70],[70,70]],6:[[30,25],[70,25],[30,50],[70,50],[30,75],[70,75]]};return(d[v]||d[1]).map(([x,y])=>'<circle cx="'+x+'" cy="'+y+'" r="8" fill="#1a1a2e"/>').join('')}

function render(){const a=document.getElementById('app');a.innerHTML=state.screen==='home'?renderHome():state.screen==='lobby'?renderLobby():state.screen==='roulette'?renderRoulette():state.screen==='game'?renderGame():'';bindEvents()}

function renderHome(){
  return '<div class="min-h-screen bg-party flex flex-col items-center justify-center p-4 relative overflow-hidden"><div class="absolute top-10 left-10 text-6xl opacity-20 animate-float">ğŸ®</div><div class="absolute bottom-20 right-10 text-5xl opacity-20 animate-float-reverse">ğŸ²</div><div class="text-center mb-8 animate-fade-scale"><h1 class="title-font text-6xl lg:text-8xl text-white mb-2" style="text-shadow:0 0 30px rgba(99,102,241,0.5);">ğŸ® íŒŒí‹°ê²Œì„ ğŸ®</h1><p class="text-xl text-indigo-200">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜í•˜ëŠ” íŒŒí‹°ê²Œì„!</p></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl w-full">'+GAMES.map((g,i)=>'<div data-action="select-game" data-game="'+g.id+'" class="game-card rounded-3xl p-6 cursor-pointer animate-slide-up" style="animation-delay:'+i*0.1+'s;--glow:'+g.glow+'"><div class="text-6xl mb-4">'+g.emoji+'</div><h3 class="title-font text-2xl text-white mb-2">'+g.name+'</h3><p class="text-white/60 text-sm mb-3">'+g.desc+'</p><span class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-gradient-to-r '+g.color+' text-white">'+(g.solo?'ì†”ë¡œ':g.min+'-'+g.max+'ëª…')+'</span></div>').join('')+'</div><button data-action="show-update" class="fixed bottom-4 right-4 btn-ghost text-white/50 hover:text-white px-4 py-2 rounded-xl text-sm">ğŸ“‹ ì—…ë°ì´íŠ¸ ë‚´ì—­</button>'+(state.showUpdate?renderUpdateModal():'')+'</div>'}

function renderUpdateModal(){
  return '<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" data-action="close-update"><div class="card-dark rounded-2xl p-6 max-w-lg w-full animate-bounce-in" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-white">ğŸ“‹ ì—…ë°ì´íŠ¸ ë‚´ì—­</h3><button data-action="close-update" class="text-white/50 hover:text-white text-2xl">&times;</button></div><div class="update-scroll space-y-6">'+UPDATE_LOGS.map(l=>'<div class="border-l-4 border-indigo-500 pl-4"><div class="flex items-center gap-2 mb-2"><span class="text-indigo-400 font-bold">'+l.version+'</span><span class="text-white/50 text-sm">'+l.date+'</span></div><ul class="space-y-1">'+l.changes.map(c=>'<li class="text-white/80 text-sm">'+c+'</li>').join('')+'</ul></div>').join('')+'</div></div></div>'}

function renderLobby(){
  const g=state.game;if(!g)return'';
  const colors=g.id==='jurumarble'?{bg:'bg-beer',btn:'btn-beer',input:'input-beer'}:g.id==='liar'?{bg:'bg-liar',btn:'btn-liar',input:'input-liar'}:{bg:'bg-party',btn:'btn-primary',input:'input-dark'};
  if(!state.room){
    return '<div class="min-h-screen '+colors.bg+' flex items-center justify-center p-4"><div class="card-dark rounded-3xl p-8 w-full max-w-md animate-fade-scale"><button data-action="go-home" class="btn-ghost text-white/70 px-3 py-1 rounded-lg mb-4">â† ë’¤ë¡œ</button><div class="text-center mb-6"><span class="text-5xl">'+g.emoji+'</span><h2 class="title-font text-3xl text-white mt-2">'+g.name+'</h2></div><div class="mb-4"><label class="block text-white/70 text-sm mb-2">ë‹‰ë„¤ì„</label><input type="text" id="pname" maxlength="8" placeholder="ë‹‰ë„¤ì„" class="'+colors.input+' w-full px-4 py-3 rounded-xl text-lg"></div><div class="mb-6"><label class="block text-white/70 text-sm mb-2">ë°© ì½”ë“œ (ì°¸ê°€ì‹œ)</label><input type="text" id="rcode" maxlength="6" placeholder="ì—†ìœ¼ë©´ ìƒˆ ë°© ìƒì„±" class="'+colors.input+' w-full px-4 py-3 rounded-xl text-center tracking-widest uppercase"></div><button data-action="join-or-create" class="'+colors.btn+' w-full text-white text-xl font-bold py-4 rounded-2xl">ğŸ® ì…ì¥í•˜ê¸°</button></div></div>'}
  const players=Object.values(state.room.players||{}).sort((a,b)=>a.order-b.order);
  const isHost=state.room.hostId===state.odPlyerId;
  const canStart=players.length>=g.min;
  return '<div class="min-h-screen '+colors.bg+' p-4"><div class="max-w-2xl mx-auto"><div class="card-dark rounded-3xl p-6 animate-fade-scale"><div class="flex justify-between items-start mb-4"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg">ğŸšª ë‚˜ê°€ê¸°</button><div class="text-center"><span class="text-4xl">'+g.emoji+'</span><h2 class="title-font text-2xl text-white">'+g.name+'</h2></div><div></div></div><div class="bg-black/30 rounded-2xl p-4 mb-4 text-center"><p class="text-white/50 text-sm">ë°© ì½”ë“œ</p><p class="title-font text-4xl text-white tracking-wider">'+state.roomCode+'</p><button data-action="copy-code" class="mt-2 text-indigo-400 text-sm">ğŸ“‹ ë³µì‚¬</button></div><div class="mb-4"><p class="text-white/70 text-sm mb-2">í”Œë ˆì´ì–´ ('+players.length+'/'+g.max+')</p><div class="grid grid-cols-2 gap-2">'+players.map((p,i)=>'<div class="player-item flex items-center gap-2 bg-black/20 rounded-xl p-2 '+(p.id===state.odPlyerId?'ring-2 ring-indigo-500':'')+'"><div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" style="background:'+PLAYER_COLORS[i]+'">'+p.name[0]+'</div><span class="flex-1 text-white text-sm truncate">'+p.name+'</span>'+(p.id===state.room.hostId?'<span class="text-yellow-400 text-xs">ğŸ‘‘</span>':'')+(isHost&&p.id!==state.odPlyerId?'<button data-action="kick" data-pid="'+p.id+'" class="kick-btn text-red-400 text-xs px-1 rounded hover:bg-red-500/20">ê°•í‡´</button>':'')+'</div>').join('')+'</div></div>'+(isHost?'<button data-action="start-game" '+(canStart?'':'disabled')+' class="'+colors.btn+' w-full text-white text-xl font-bold py-4 rounded-2xl '+(canStart?'':'opacity-50 cursor-not-allowed')+'">'+(canStart?'ğŸ® ê²Œì„ ì‹œì‘':'â³ '+g.min+'ëª… ì´ìƒ í•„ìš”')+'</button>':'<div class="text-center text-white/50 py-4">í˜¸ìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘...</div>')+'</div></div>'+(state.showLeave?renderLeaveModal():'')+'</div>'}

function renderRoulette(){
  const validSlots=getValidSlots();
  const validCount=validSlots.length;
  const canSpin=!state.rouletteSpinning&&validCount>=2;
  const segAngle=validCount>0?360/validCount:360;
  
  return '<div class="min-h-screen bg-roulette p-4 relative overflow-hidden"><div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-6"><button data-action="go-home" class="btn-ghost text-white/70 px-4 py-2 rounded-xl">â† ë’¤ë¡œ</button><h1 class="title-font text-4xl text-purple-400">ğŸ¡ ë£°ë › ğŸ¡</h1><div></div></div><div class="flex flex-col lg:flex-row gap-6 items-center"><div class="relative flex flex-col items-center"><div class="absolute -top-2 left-1/2 -translate-x-1/2 z-20 text-4xl" style="filter:drop-shadow(0 0 10px rgba(255,255,255,0.8));">â–¼</div><div class="relative w-72 h-72 lg:w-80 lg:h-80"><svg viewBox="0 0 200 200" class="roulette-wheel w-full h-full" id="roulette-wheel" style="transform:rotate('+state.rouletteAngle+'deg)"><circle cx="100" cy="100" r="98" fill="#1a1a2e" stroke="#4c1d95" stroke-width="4"/>'+(validCount>0?validSlots.map((s,i)=>{const st=i*segAngle-90,en=st+segAngle,la=segAngle>180?1:0;const x1=100+95*Math.cos(st*Math.PI/180),y1=100+95*Math.sin(st*Math.PI/180),x2=100+95*Math.cos(en*Math.PI/180),y2=100+95*Math.sin(en*Math.PI/180);const ma=(st+segAngle/2)*Math.PI/180,tx=100+60*Math.cos(ma),ty=100+60*Math.sin(ma);return'<path d="M100,100 L'+x1+','+y1+' A95,95 0 '+la+',1 '+x2+','+y2+' Z" fill="'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'" stroke="#1a1a2e" stroke-width="1"/><text x="'+tx+'" y="'+ty+'" fill="white" font-size="'+(validCount>8?8:10)+'" font-weight="bold" text-anchor="middle" dominant-baseline="middle" transform="rotate('+(st+segAngle/2+90)+','+tx+','+ty+')">'+(s.length>6?s.slice(0,6)+'â€¦':s)+'</text>'}).join(''):'<text x="100" y="100" fill="white" font-size="12" text-anchor="middle">í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”</text>')+'<circle cx="100" cy="100" r="20" fill="#2d1b4e" stroke="#7c3aed" stroke-width="3"/><circle cx="100" cy="100" r="8" fill="#a855f7"/></svg></div><div class="mt-4 w-full text-center min-h-[80px] flex items-center justify-center">'+(state.rouletteResult?'<div class="animate-result-pop"><p class="text-purple-300 text-sm mb-1">ğŸ‰ ë‹¹ì²¨! ğŸ‰</p><p class="title-font text-3xl animate-winner" style="color:'+state.rouletteResultColor+'">'+state.rouletteResult+'</p></div>':'<p class="text-white/30 text-sm">'+(state.rouletteSpinning?'ğŸŒ€ ëŒì•„ê°€ëŠ” ì¤‘...':(validCount<2?'âš ï¸ í•­ëª© 2ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”':'ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤'))+'</p>')+'</div><button data-action="spin" '+(canSpin?'':'disabled')+' class="mt-4 w-full btn-purple text-white text-xl font-bold py-4 rounded-2xl '+(canSpin?'':'opacity-50 cursor-not-allowed')+'">'+(state.rouletteSpinning?'ğŸŒ€ ëŒì•„ê°€ëŠ” ì¤‘...':'ğŸ¯ ëŒë¦¬ê¸°!')+'</button></div><div class="card-purple rounded-2xl p-4 flex-1 w-full max-w-md"><h3 class="text-purple-300 font-bold mb-4" id="slot-count">ğŸ° í•­ëª© ('+validCount+'ê°œ)</h3><div class="space-y-2 max-h-64 overflow-y-auto mb-4">'+state.rouletteSlots.map((s,i)=>{const isValid=s&&s.trim().length>0;return'<div class="flex gap-2 items-center"><div class="w-4 h-4 rounded '+(isValid?'':'opacity-30')+'" style="background:'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'"></div><input type="text" data-slot="'+i+'" value="'+s+'" placeholder="í•­ëª© '+(i+1)+'" class="input-dark flex-1 px-3 py-2 rounded-lg text-sm"><button data-action="remove-slot" data-idx="'+i+'" class="text-red-400 hover:text-red-300 px-2 '+(state.rouletteSlots.length<=2?'opacity-30 cursor-not-allowed':'')+'">âœ•</button></div>'}).join('')+'</div><button data-action="add-slot" class="w-full btn-secondary text-purple-300 py-2 rounded-xl">+ í•­ëª© ì¶”ê°€</button></div></div></div></div>'}

function renderGame(){if(!state.room)return'';if(state.game?.id==='liar')return renderLiarGame();return renderJurumarble()}

function renderJurumarble(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const curr=players[room.turn%players.length];
  const isMyTurn=curr?.id===state.odPlyerId;
  const sz=60,gap=2,side=8,bsz=(side+1)*(sz+gap)+16;
  return '<div class="min-h-screen bg-beer p-2 relative overflow-hidden"><div class="max-w-6xl mx-auto relative z-10"><div class="flex justify-between items-center mb-2 px-2"><button data-action="show-leave" class="btn-ghost text-red-400 px-3 py-1 rounded-lg text-sm">ğŸšª</button><h1 class="title-font text-2xl text-amber-400">ğŸº ì£¼ë£¨ë§ˆë¸”</h1><div class="text-amber-300/50 text-xs">'+state.roomCode+'</div></div><div class="flex flex-col xl:flex-row gap-3 items-center justify-center"><div class="relative rounded-2xl p-2" style="width:'+bsz+'px;height:'+bsz+'px;background:linear-gradient(145deg,#3D2E1F,#2C2416);">'+TILES.map((t,idx)=>{const pos=getTilePos(idx),here=players.filter(p=>p.position===idx);return'<div class="absolute rounded-lg flex flex-col items-center justify-center tile-'+t.type+' border border-white/20" style="width:'+sz+'px;height:'+sz+'px;left:'+(pos.x*(sz+gap)+8)+'px;top:'+(pos.y*(sz+gap)+8)+'px;"><span class="text-sm">'+t.emoji+'</span><span class="text-[7px] font-bold text-white text-center px-0.5 drop-shadow leading-tight">'+t.name+'</span>'+here.map((p,pi)=>{const pIdx=players.findIndex(pl=>pl.id===p.id);const[ox,oy]=getOffset(pi);return'<div class="absolute w-5 h-5 rounded-full flex items-center justify-center text-[7px] font-bold text-white player-token '+(room.lastAction?.playerId===p.id&&Date.now()-room.lastAction?.timestamp<1000?'animate-move':'')+'" style="background-color:'+PLAYER_COLORS[pIdx]+';transform:translate('+ox+'px,'+oy+'px);z-index:10;">'+p.name[0]+'</div>'}).join('')+'</div>'}).join('')+'</div><div class="card-wood rounded-2xl p-3 w-full xl:w-60"><div class="text-center mb-3 p-2 rounded-lg '+(isMyTurn?'bg-amber-500/20':'bg-black/20')+'"><p class="text-amber-300/70 text-xs mb-1">í˜„ì¬ ì°¨ë¡€</p><p class="text-lg font-black '+(isMyTurn?'text-amber-400':'text-amber-100')+'">'+(curr?.name||'')+'</p>'+(isMyTurn?'<p class="text-amber-400 text-xs mt-1">ğŸ² ì£¼ì‚¬ìœ„!</p>':'')+'</div><div class="flex justify-center mb-3"><button data-action="roll-dice" '+(!isMyTurn||room.rolling?'disabled':'')+' class="relative w-14 h-14 bg-gradient-to-br from-amber-100 to-amber-200 rounded-xl shadow-xl border-4 '+(isMyTurn&&!room.rolling?'border-amber-500 hover:scale-110 cursor-pointer':'border-gray-600 opacity-50 cursor-not-allowed')+' transition-all '+(room.rolling?'animate-dice-roll':'')+'"><svg viewBox="0 0 100 100" class="w-full h-full p-1">'+diceDots(state.localDice)+'</svg></button></div><div class="border-t border-amber-700/30 pt-2"><p class="text-amber-300/70 text-xs mb-1 text-center">í”Œë ˆì´ì–´ ('+players.length+'/12)</p><div class="grid grid-cols-2 gap-1 max-h-28 overflow-y-auto">'+players.map((p,i)=>'<div class="flex items-center gap-1 px-1 py-0.5 rounded '+(p.id===curr?.id?'bg-amber-500/20':'bg-black/20')+' '+(p.id===state.odPlyerId?'ring-1 ring-amber-500/50':'')+'"><div class="w-4 h-4 rounded-full flex items-center justify-center text-white text-[8px] font-bold" style="background-color:'+PLAYER_COLORS[i]+'">'+p.name[0]+'</div><span class="text-[9px] '+(p.id===curr?.id?'text-amber-400':'text-amber-100')+' truncate">'+p.name+'</span></div>').join('')+'</div></div></div></div></div>'+(room.showMission?renderMissionModal():'')+(state.showLeave?renderLeaveModal():'')+'</div>'}

function renderMissionModal(){
  const room=state.room,tile=TILES.find(t=>t.id===room.currentTileId);if(!tile)return'';
  const players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const curr=players[room.turn%players.length];
  const isMyTurn=curr?.id===state.odPlyerId;
  if(room.goldenKey){
    const gk=GOLDEN_KEYS.find(k=>k.type===room.goldenKey);
    return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-golden rounded-3xl p-6 max-w-sm w-full animate-bounce-in animate-golden-glow text-center"><div class="text-6xl mb-4">'+(gk?.emoji||'ğŸ”‘')+'</div><h3 class="title-font text-2xl text-amber-900 mb-2">ğŸ”‘ í™©ê¸ˆì—´ì‡ ! ğŸ”‘</h3><p class="text-amber-800 mb-6">'+(gk?.text||'íŠ¹ë³„í•œ ì¼ì´!')+'</p>'+(isMyTurn?'<button data-action="close-mission" class="bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-8 rounded-xl">í™•ì¸</button>':'<div class="text-amber-800/70 py-3">'+curr?.name+'ë‹˜ì´ í™•ì¸ ì¤‘...</div>')+'</div></div>'}
  return '<div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4"><div class="card-wood rounded-3xl p-6 max-w-sm w-full animate-bounce-in text-center"><div class="text-6xl mb-4">'+tile.emoji+'</div><h3 class="title-font text-2xl text-amber-100 mb-2">'+tile.name+'</h3><p class="text-amber-200 mb-6">'+(tile.type==='game'&&tile.id===28?RANDOM_GAMES[Math.floor(Math.random()*RANDOM_GAMES.length)]:tile.desc)+'</p>'+(isMyTurn?'<button data-action="close-mission" class="btn-beer text-white font-bold py-3 px-8 rounded-xl">í™•ì¸</button>':'<div class="text-amber-300/70 py-3">'+curr?.name+'ë‹˜ì´ í™•ì¸ ì¤‘...</div>')+'</div></div>'}

function renderLiarGame(){
  const room=state.room,players=Object.values(room.players).sort((a,b)=>a.order-b.order);
  const isLiar=room.liarId===state.odPlyerId,phase=room.phase;
  const isHost=room.hostId===state.odPlyerId;
  let content='';
  if(phase==='role')content=renderLiarRole(room,players,isLiar,isHost);
  else if(phase==='discuss')content=renderLiarDiscuss(room,players,isLiar,isHost);
  else if(phase==='vote')content=renderLiarVote(room,players,isHost);
  else if(phase==='reveal')content=renderLiarReveal(room,players);
  else if(phase==='result')content=renderLiarResult(room,players,isHost);
  return '<div class="min-h-screen bg-liar p-4 relative overflow-hidden"><div class="absolute top-10 left-10 text-5xl opacity-15 animate-float">ğŸ­</div><div class="absolute bottom-10 right-10 text-4xl opacity-10 animate-float-reverse">ğŸ•µï¸</div><div class="max-w-4xl mx-auto relative z-10"><div class="flex justify-between items-center mb-6"><button data-action="show-leave" class="btn-ghost px-4 py-2 text-red-400 rounded-xl">ğŸšª</button><h1 class="title-font text-4xl text-red-400" style="text-shadow:0 0 20px rgba(239,68,68,0.3);">ğŸ­ ë¼ì´ì–´ ê²Œì„ ğŸ­</h1><div class="text-white/30 text-sm">'+state.roomCode+'</div></div>'+content+'</div>'+(state.showLeave?renderLeaveModal():'')+'</div>'}

function renderLiarRole(room,players,isLiar,isHost){
  return '<div class="text-center"><p class="text-white/70 mb-4">ì¹´ë“œë¥¼ í´ë¦­í•´ì„œ ì—­í• ì„ í™•ì¸í•˜ì„¸ìš”!</p><div class="flex justify-center mb-8"><div class="liar-card-container w-48 h-72 cursor-pointer" data-action="flip-card"><div class="liar-card-inner w-full h-full '+(state.liarFlipped?'flipped':'')+'"><div class="liar-card-front bg-gradient-to-br from-gray-700 to-gray-900 border-4 border-gray-600 flex items-center justify-center shadow-2xl"><span class="text-6xl">â“</span></div><div class="liar-card-back '+(isLiar?'bg-gradient-to-br from-red-600 to-red-900 border-red-500':'bg-gradient-to-br from-blue-600 to-blue-900 border-blue-500')+' border-4 flex flex-col items-center justify-center shadow-2xl p-4"><span class="text-5xl mb-3">'+(isLiar?'ğŸ¤¥':'ğŸ˜‡')+'</span><p class="text-2xl font-black text-white mb-2">'+(isLiar?'ë¼ì´ì–´':'ì‹œë¯¼')+'</p>'+(!isLiar?'<div class="mt-2 bg-black/30 rounded-xl px-4 py-2 w-full"><p class="text-white/70 text-xs">ì£¼ì œ: '+room.topic+'</p><p class="text-white text-xl font-bold mt-1">'+room.word+'</p></div>':'<p class="text-white/70 text-sm mt-2">ì£¼ì œ: '+room.topic+'</p><p class="text-red-200 text-xs mt-1">ì œì‹œì–´ë¥¼ ëª¨ë¦…ë‹ˆë‹¤!</p>')+'</div></div></div></div><div class="card-liar rounded-2xl p-4 mb-6 max-w-md mx-auto"><p class="text-white/70 text-sm mb-2">ì°¸ê°€ì '+players.length+'ëª…</p><div class="flex flex-wrap justify-center gap-2">'+players.map((p,i)=>'<div class="flex items-center gap-1 bg-black/30 rounded-full px-3 py-1"><div class="w-5 h-5 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><span class="text-white text-sm">'+p.name+'</span></div>').join('')+'</div></div>'+(isHost?'<button data-action="start-discuss" class="btn-liar text-white text-xl font-bold py-4 px-8 rounded-2xl">ğŸ’¬ í† ë¡  ì‹œì‘</button>':'<p class="text-white/50">í˜¸ìŠ¤íŠ¸ê°€ í† ë¡ ì„ ì‹œì‘í•  ë•Œê¹Œì§€ ëŒ€ê¸°...</p>')+'</div>'}

function renderLiarDiscuss(room,players,isLiar,isHost){
  return '<div class="text-center"><div class="card-liar rounded-2xl p-6 mb-6 max-w-lg mx-auto"><div class="text-4xl mb-4 animate-float">ğŸ’¬</div><p class="text-red-400 text-2xl font-bold mb-2">í† ë¡  ì‹œê°„!</p><p class="text-white/70 mb-4">ê°ì ìˆœì„œëŒ€ë¡œ ì œì‹œì–´ì— ëŒ€í•œ íŒíŠ¸ë¥¼ ë§í•˜ì„¸ìš”.<br/>ë¼ì´ì–´ëŠ” ë“¤í‚¤ì§€ ì•Šê²Œ ì—°ê¸°í•˜ì„¸ìš”!</p><div class="bg-black/30 rounded-xl p-4 mb-4"><p class="text-white/50 text-sm">ì£¼ì œ</p><p class="text-white text-3xl font-bold">'+room.topic+'</p>'+(!isLiar?'<p class="text-green-400 mt-2 text-lg">ì œì‹œì–´: <strong>'+room.word+'</strong></p>':'<p class="text-red-400 mt-2 text-sm">ğŸ¤¥ ë‹¹ì‹ ì€ ë¼ì´ì–´!</p>')+'</div><div class="mb-4"><p class="text-white/50 text-sm mb-2">ë°œì–¸ ìˆœì„œ</p><div class="flex flex-wrap justify-center gap-2">'+players.map((p,i)=>'<div class="flex items-center gap-1 bg-black/20 rounded-full px-3 py-1"><span class="text-white/50 text-xs">'+(i+1)+'.</span><div class="w-4 h-4 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><span class="text-white text-sm">'+p.name+'</span></div>').join('')+'</div></div></div>'+(isHost?'<button data-action="start-vote" class="btn-liar text-white text-xl font-bold py-4 px-8 rounded-2xl">ğŸ—³ï¸ íˆ¬í‘œ ì‹œì‘</button>':'<p class="text-white/50">í˜¸ìŠ¤íŠ¸ê°€ íˆ¬í‘œë¥¼ ì‹œì‘í•  ë•Œê¹Œì§€...</p>')+'</div>'}

function renderLiarVote(room,players,isHost){
  const myVote=state.liarVote;
  const votes=room.votes||{};
  const voteCount=Object.keys(votes).length;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-6 mb-6 max-w-lg mx-auto"><div class="text-4xl mb-4">ğŸ—³ï¸</div><p class="text-red-400 text-2xl font-bold mb-2">íˆ¬í‘œ ì‹œê°„!</p><p class="text-white/70 mb-4">ë¼ì´ì–´ë¼ê³  ìƒê°í•˜ëŠ” ì‚¬ëŒì—ê²Œ íˆ¬í‘œí•˜ì„¸ìš”!</p><p class="text-white/50 text-sm mb-4">íˆ¬í‘œ í˜„í™©: '+voteCount+' / '+players.length+'</p><div class="grid grid-cols-2 sm:grid-cols-3 gap-3">'+players.map((p,i)=>'<button data-action="vote" data-target="'+p.id+'" '+(p.id===state.odPlyerId?'disabled':'')+' class="p-3 rounded-xl border-2 transition-all '+(myVote===p.id?'bg-red-500/30 border-red-500 ring-2 ring-red-400':votes[state.odPlyerId]===p.id?'bg-red-500/20 border-red-500':'bg-black/30 border-white/20 hover:border-red-500/50')+' '+(p.id===state.odPlyerId?'opacity-40 cursor-not-allowed':'cursor-pointer')+'"><div class="w-10 h-10 rounded-full mx-auto mb-2" style="background:'+PLAYER_COLORS[i]+'"></div><p class="text-white font-medium text-sm">'+p.name+'</p>'+(myVote===p.id||votes[state.odPlyerId]===p.id?'<p class="text-red-400 text-xs mt-1">âœ“ íˆ¬í‘œí•¨</p>':'')+'</button>').join('')+'</div></div>'+(isHost?'<button data-action="reveal-votes" '+(voteCount<players.length?'disabled':'')+' class="btn-liar text-white text-xl font-bold py-4 px-8 rounded-2xl '+(voteCount<players.length?'opacity-50 cursor-not-allowed':'')+'">ğŸ­ ê²°ê³¼ ê³µê°œ '+(voteCount<players.length?'('+voteCount+'/'+players.length+')':'')+'</button>':'')+'</div>'}

function renderLiarReveal(room,players){
  const votes=room.votes||{};
  const counts={};players.forEach(p=>counts[p.id]=0);
  Object.values(votes).forEach(v=>{if(counts[v]!==undefined)counts[v]++});
  const maxV=Math.max(...Object.values(counts),0);
  const mostVoted=Object.keys(counts).filter(k=>counts[k]===maxV);
  const liarCaught=mostVoted.includes(room.liarId);
  const liar=players.find(p=>p.id===room.liarId);
  const isLiar=room.liarId===state.odPlyerId;
  const isHost=room.hostId===state.odPlyerId;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-6 mb-6 max-w-lg mx-auto"><p class="text-red-400 text-2xl font-bold mb-4">ğŸ­ íˆ¬í‘œ ê²°ê³¼</p><div class="space-y-3 mb-6">'+players.map((p,i)=>{const c=counts[p.id]||0;const pct=players.length>0?(c/players.length)*100:0;return'<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full" style="background:'+PLAYER_COLORS[i]+'"></div><div class="flex-1 text-left"><p class="text-white font-medium text-sm">'+p.name+' '+(p.id===room.liarId?'<span class="text-red-400">ğŸ¤¥</span>':'')+'</p><div class="h-2 bg-black/30 rounded-full overflow-hidden mt-1"><div class="vote-bar h-full bg-gradient-to-r from-red-500 to-red-600 rounded-full" style="width:'+pct+'%"></div></div></div><span class="text-white font-bold">'+c+'í‘œ</span></div>'}).join('')+'</div><div class="bg-black/30 rounded-xl p-4"><p class="text-white/70 mb-2">ë¼ì´ì–´ëŠ”...</p><p class="text-3xl font-black '+(liarCaught?'text-green-400':'text-red-400')+'">'+(liar?.name||'?')+' ğŸ¤¥</p><p class="text-white/50 text-sm mt-2">'+(liarCaught?'âœ… ë¼ì´ì–´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!':'âŒ ë¼ì´ì–´ë¥¼ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤!')+'</p></div></div>'+(liarCaught&&isLiar?'<div class="card-liar rounded-2xl p-4 mb-4 max-w-md mx-auto"><p class="text-white/70 mb-2">ğŸ¯ ë§ˆì§€ë§‰ ê¸°íšŒ! ì œì‹œì–´ë¥¼ ë§ì¶°ë³´ì„¸ìš”</p><input type="text" id="liar-guess" class="input-liar w-full px-4 py-3 rounded-xl mb-3 text-center text-xl" placeholder="ì œì‹œì–´ ì…ë ¥..."><button data-action="liar-guess" class="btn-liar text-white font-bold py-3 px-6 rounded-xl w-full">ì •ë‹µ ì œì¶œ!</button></div>':'')+(isHost&&!liarCaught?'<button data-action="show-result" class="btn-liar text-white text-xl font-bold py-4 px-8 rounded-2xl">ğŸ“Š ìµœì¢… ê²°ê³¼</button>':'')+(isHost&&liarCaught&&!isLiar?'<p class="text-white/50 mt-4">ë¼ì´ì–´ê°€ ì œì‹œì–´ë¥¼ ë§ì¶”ëŠ” ì¤‘...</p>':'')+'</div>'}

function renderLiarResult(room,players,isHost){
  const liar=players.find(p=>p.id===room.liarId);
  const liarWon=room.liarGuessCorrect===true||!room.liarCaught;
  return '<div class="text-center"><div class="card-liar rounded-2xl p-6 mb-6 max-w-lg mx-auto animate-result-pop"><div class="text-7xl mb-4">'+(liarWon?'ğŸ˜ˆ':'ğŸ‰')+'</div><p class="text-4xl font-black '+(liarWon?'text-red-400':'text-green-400')+' mb-4">'+(liarWon?'ğŸ¤¥ ë¼ì´ì–´ ìŠ¹ë¦¬!':'ğŸ˜‡ ì‹œë¯¼ ìŠ¹ë¦¬!')+'</p><div class="bg-black/30 rounded-xl p-4 mb-4 space-y-2"><p class="text-white/70">ë¼ì´ì–´: <span class="text-red-400 font-bold">'+(liar?.name||'?')+'</span></p><p class="text-white/70">ì£¼ì œ: <span class="text-white font-bold">'+room.topic+'</span></p><p class="text-white/70">ì •ë‹µ: <span class="text-green-400 font-bold text-2xl">'+room.word+'</span></p></div>'+(room.liarGuessCorrect!==undefined?'<p class="text-white/50 text-sm">'+(room.liarGuessCorrect?'ğŸ¯ ë¼ì´ì–´ê°€ ì œì‹œì–´ë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!':'âŒ ë¼ì´ì–´ê°€ ì œì‹œì–´ë¥¼ í‹€ë ¸ìŠµë‹ˆë‹¤.')+'</p>':'')+'</div>'+(isHost?'<button data-action="new-round" class="btn-liar text-white text-xl font-bold py-4 px-8 rounded-2xl">ğŸ”„ ìƒˆ ë¼ìš´ë“œ</button>':'<p class="text-white/50">í˜¸ìŠ¤íŠ¸ê°€ ìƒˆ ë¼ìš´ë“œë¥¼ ì‹œì‘í•  ë•Œê¹Œì§€...</p>')+'</div>'}

function renderLeaveModal(){
  return '<div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4"><div class="card-dark rounded-2xl p-6 max-w-sm w-full animate-bounce-in text-center"><h3 class="text-xl font-bold text-white mb-4">ğŸšª ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</h3><p class="text-white/60 text-sm mb-6">'+(state.room?.hostId===state.odPlyerId?'í˜¸ìŠ¤íŠ¸ê°€ ë‚˜ê°€ë©´ ë°©ì´ ì‚­ì œë©ë‹ˆë‹¤.':'ê²Œì„ì—ì„œ ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.')+'</p><div class="flex gap-3"><button data-action="cancel-leave" class="flex-1 btn-secondary text-white py-3 rounded-xl">ì·¨ì†Œ</button><button data-action="leave-room" class="flex-1 btn-danger text-white py-3 rounded-xl">ë‚˜ê°€ê¸°</button></div></div></div>'}

function bindEvents(){
  document.querySelectorAll('[data-action]').forEach(el=>{el.onclick=e=>{e.stopPropagation();handleAction(el.dataset.action,el.dataset)}});
  document.querySelectorAll('[data-slot]').forEach(el=>{
    el.oninput=e=>{
      const idx=parseInt(el.dataset.slot);
      if(!isNaN(idx)&&idx>=0&&idx<state.rouletteSlots.length){
        state.rouletteSlots[idx]=e.target.value;
        updateWheelVisual();
      }
    }
  });
  const guessInput=document.getElementById('liar-guess');
  if(guessInput)guessInput.oninput=e=>state.liarGuess=e.target.value}

function updateWheelVisual(){
  const wheel=document.getElementById('roulette-wheel');
  const countEl=document.getElementById('slot-count');
  if(!wheel)return;
  
  const validSlots=getValidSlots();
  const validCount=validSlots.length;
  const segAngle=validCount>0?360/validCount:360;
  
  let svg='<circle cx="100" cy="100" r="98" fill="#1a1a2e" stroke="#4c1d95" stroke-width="4"/>';
  if(validCount>0){
    validSlots.forEach((s,i)=>{
      const st=i*segAngle-90,en=st+segAngle,la=segAngle>180?1:0;
      const x1=100+95*Math.cos(st*Math.PI/180),y1=100+95*Math.sin(st*Math.PI/180);
      const x2=100+95*Math.cos(en*Math.PI/180),y2=100+95*Math.sin(en*Math.PI/180);
      const ma=(st+segAngle/2)*Math.PI/180,tx=100+60*Math.cos(ma),ty=100+60*Math.sin(ma);
      svg+='<path d="M100,100 L'+x1+','+y1+' A95,95 0 '+la+',1 '+x2+','+y2+' Z" fill="'+ROULETTE_COLORS[i%ROULETTE_COLORS.length]+'" stroke="#1a1a2e" stroke-width="1"/>';
      svg+='<text x="'+tx+'" y="'+ty+'" fill="white" font-size="'+(validCount>8?8:10)+'" font-weight="bold" text-anchor="middle" dominant-baseline="middle" transform="rotate('+(st+segAngle/2+90)+','+tx+','+ty+')">'+(s.length>6?s.slice(0,6)+'â€¦':s)+'</text>'
    });
  }else{
    svg+='<text x="100" y="100" fill="white" font-size="12" text-anchor="middle">í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”</text>';
  }
  svg+='<circle cx="100" cy="100" r="20" fill="#2d1b4e" stroke="#7c3aed" stroke-width="3"/><circle cx="100" cy="100" r="8" fill="#a855f7"/>';
  wheel.innerHTML=svg;
  
  if(countEl)countEl.textContent='ğŸ° í•­ëª© ('+validCount+'ê°œ)';
  
  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  const spinBtn=document.querySelector('[data-action="spin"]');
  if(spinBtn){
    const canSpin=!state.rouletteSpinning&&validCount>=2;
    spinBtn.disabled=!canSpin;
    spinBtn.className='mt-4 w-full btn-purple text-white text-xl font-bold py-4 rounded-2xl '+(canSpin?'':'opacity-50 cursor-not-allowed');
  }
  
  // ê²°ê³¼ ì˜ì—­ ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  if(!state.rouletteResult&&!state.rouletteSpinning){
    const resultArea=document.querySelector('.min-h-\\[80px\\] p');
    if(resultArea&&validCount<2){
      resultArea.textContent='âš ï¸ í•­ëª© 2ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”';
    }else if(resultArea){
      resultArea.textContent='ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤';
    }
  }
}

function handleAction(a,d){
  if(a!=='spin'&&a!=='flip-card')playSound('click');
  switch(a){
    case 'go-home':state.screen='home';state.game=null;leaveRoom();render();break;
    case 'select-game':const g=GAMES.find(x=>x.id===d.game);if(g){state.game=g;state.screen=g.solo?'roulette':'lobby'}render();break;
    case 'join-or-create':joinOrCreate();break;
    case 'start-game':startGame();break;
    case 'copy-code':navigator.clipboard?.writeText(state.roomCode);break;
    case 'show-leave':state.showLeave=true;render();break;
    case 'cancel-leave':state.showLeave=false;render();break;
    case 'leave-room':leaveRoom();state.screen='home';render();break;
    case 'kick':kickPlayer(d.pid);break;
    case 'roll-dice':rollDice();break;
    case 'close-mission':closeMission();break;
    case 'add-slot':state.rouletteSlots.push('');render();break;
    case 'remove-slot':
      // ë°°ì—´ ê¸¸ì´ê°€ 2ë³´ë‹¤ í¬ë©´ ì‚­ì œ ê°€ëŠ¥
      if(state.rouletteSlots.length>2){
        const idx=parseInt(d.idx);
        if(!isNaN(idx)&&idx>=0&&idx<state.rouletteSlots.length){
          state.rouletteSlots.splice(idx,1);
          render();
        }
      }
      break;
    case 'spin':spinRoulette();break;
    case 'show-update':state.showUpdate=true;render();break;
    case 'close-update':state.showUpdate=false;render();break;
    case 'flip-card':if(!state.liarFlipped){playSound('reveal');state.liarFlipped=true;render()}break;
    case 'start-discuss':updateRoom({phase:'discuss'});break;
    case 'start-vote':updateRoom({phase:'vote',votes:{}});state.liarVote=null;break;
    case 'vote':playSound('vote');state.liarVote=d.target;if(roomRef)roomRef.child('votes/'+state.odPlyerId).set(d.target);render();break;
    case 'reveal-votes':revealVotes();break;
    case 'liar-guess':liarGuessWord();break;
    case 'show-result':showFinalResult();break;
    case 'new-round':newLiarRound();break}}

function joinOrCreate(){
  const name=document.getElementById('pname')?.value?.trim();
  const code=document.getElementById('rcode')?.value?.toUpperCase()?.trim();
  if(!name)return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!');
  if(!isFirebaseReady)return alert('Firebase ì—°ê²° í•„ìš”!');
  state.playerName=name;
  if(code&&code.length===6){joinRoom(code)}else{createRoom()}}

function createRoom(){
  state.roomCode=genCode();state.odPlyerId=genCode();
  const data={hostId:state.odPlyerId,gameId:state.game.id,status:'waiting',players:{[state.odPlyerId]:{id:state.odPlyerId,name:state.playerName,order:0,position:0}},turn:0,rolling:false,showMission:false,currentTileId:null,phase:'role'};
  roomRef=db.ref('rooms/'+state.roomCode);
  roomRef.set(data).then(()=>{subscribeRoom();playSound('success')})}

function joinRoom(code){
  state.roomCode=code;state.odPlyerId=genCode();
  roomRef=db.ref('rooms/'+code);
  roomRef.once('value').then(snap=>{
    const val=snap.val();
    if(!val)return alert('ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    if(val.status!=='waiting')return alert('ì´ë¯¸ ê²Œì„ ì¤‘!');
    const g=GAMES.find(x=>x.id===val.gameId);
    const cnt=Object.keys(val.players||{}).length;
    if(cnt>=g.max)return alert('ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');
    state.game=g;
    roomRef.child('players/'+state.odPlyerId).set({id:state.odPlyerId,name:state.playerName,order:cnt,position:0}).then(()=>{subscribeRoom();playSound('join')})})}

function subscribeRoom(){
  roomRef.on('value',snap=>{
    const val=snap.val();
    if(!val||!val.players||!val.players[state.odPlyerId]){playSound('kick');alert('ë°©ì—ì„œ ë‚˜ê°');leaveRoom();state.screen='home';render();return}
    state.room=val;
    if(val.status==='playing'&&state.screen==='lobby'){playSound('success');state.screen='game';state.liarFlipped=false;state.liarVote=null}
    if(val.diceValue)state.localDice=val.diceValue;
    render()})}

function leaveRoom(){
  if(!roomRef)return;
  if(state.room?.hostId===state.odPlyerId){roomRef.remove()}else{roomRef.child('players/'+state.odPlyerId).remove()}
  roomRef.off();roomRef=null;state.room=null;state.showLeave=false}

function kickPlayer(pid){if(!roomRef||state.room?.hostId!==state.odPlyerId)return;roomRef.child('players/'+pid).remove();playSound('kick')}
function updateRoom(data){if(roomRef)roomRef.update(data)}

function startGame(){
  if(!roomRef||state.room?.hostId!==state.odPlyerId)return;
  const g=state.game;
  if(g.id==='liar'){
    const players=Object.values(state.room.players);
    const liarIdx=Math.floor(Math.random()*players.length);
    const topics=Object.keys(LIAR_TOPICS);
    const topic=topics[Math.floor(Math.random()*topics.length)];
    const words=LIAR_TOPICS[topic];
    const word=words[Math.floor(Math.random()*words.length)];
    updateRoom({status:'playing',liarId:players[liarIdx].id,topic,word,phase:'role',votes:null,liarGuessCorrect:null,liarCaught:null})}
  else{updateRoom({status:'playing'})}}

function rollDice(){
  if(!roomRef||state.room.rolling)return;
  updateRoom({rolling:true});playSound('dice');
  let cnt=0;
  const iv=setInterval(()=>{
    state.localDice=Math.floor(Math.random()*6)+1;render();cnt++;
    if(cnt>=15){clearInterval(iv);
      const final=Math.floor(Math.random()*6)+1;state.localDice=final;
      const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
      const curr=players[state.room.turn%players.length];
      const newPos=(curr.position+final)%TILES.length;
      const tile=TILES[newPos];
      const isGolden=tile.type==='special';
      const goldenKey=isGolden?GOLDEN_KEYS[Math.floor(Math.random()*GOLDEN_KEYS.length)]:null;
      const updates={rolling:false,showMission:true,currentTileId:tile.id,lastAction:{playerId:curr.id,timestamp:Date.now()}};
      updates['players/'+curr.id+'/position']=newPos;
      if(goldenKey)updates.goldenKey=goldenKey.type;else updates.goldenKey=null;
      roomRef.update(updates);playSound(isGolden?'golden':'mission')}},100)}

function closeMission(){
  const tile=TILES.find(t=>t.id===state.room.currentTileId);
  const players=Object.values(state.room.players).sort((a,b)=>a.order-b.order);
  const curr=players[state.room.turn%players.length];
  let newPos=null;
  if(tile?.type==='move'){
    if(tile.id===10)newPos=Math.max(0,curr.position-2);
    else if(tile.id===29)newPos=Math.max(0,curr.position-3);
    else if(tile.id===31)newPos=0}
  if(state.room.goldenKey){
    const gk=GOLDEN_KEYS.find(k=>k.type===state.room.goldenKey);
    if(gk?.type==='back-3')newPos=Math.max(0,curr.position-3);
    if(gk?.type==='forward-3')newPos=Math.min(TILES.length-1,curr.position+3);
    if(gk?.type==='go-start')newPos=0}
  if(newPos!==null)roomRef.child('players/'+curr.id+'/position').set(newPos);
  updateRoom({showMission:false,currentTileId:null,goldenKey:null,turn:state.room.turn+1})}

function spinRoulette(){
  if(state.rouletteSpinning)return;
  const validSlots=getValidSlots();
  if(validSlots.length<2)return alert('ìµœì†Œ 2ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”!');
  
  playSound('spin');
  state.rouletteSpinning=true;
  state.rouletteResult=null;
  state.rouletteResultColor=null;
  
  const wheel=document.getElementById('roulette-wheel');
  if(wheel){
    wheel.classList.add('reset');
    wheel.style.transform='rotate(0deg)';
    state.rouletteAngle=0;
  }
  render();
  
  setTimeout(()=>{
    const wheel=document.getElementById('roulette-wheel');
    if(wheel){
      wheel.classList.remove('reset');
      const segAngle=360/validSlots.length;
      const winIdx=Math.floor(Math.random()*validSlots.length);
      const spins=5+Math.floor(Math.random()*3);
      const finalAngle=spins*360+(360-winIdx*segAngle-segAngle/2);
      state.rouletteAngle=finalAngle;
      wheel.style.transform='rotate('+finalAngle+'deg)';
      setTimeout(()=>{
        state.rouletteSpinning=false;
        state.rouletteResult=validSlots[winIdx];
        state.rouletteResultColor=ROULETTE_COLORS[winIdx%ROULETTE_COLORS.length];
        playSound('win');
        render()},4100)}},50)}

function revealVotes(){
  if(!roomRef)return;
  const votes=state.room.votes||{};
  const counts={};
  Object.values(state.room.players).forEach(p=>counts[p.id]=0);
  Object.values(votes).forEach(v=>{if(counts[v]!==undefined)counts[v]++});
  const maxV=Math.max(...Object.values(counts),0);
  const mostVoted=Object.keys(counts).filter(k=>counts[k]===maxV);
  const liarCaught=mostVoted.includes(state.room.liarId);
  playSound('reveal');
  updateRoom({phase:'reveal',liarCaught})}

function liarGuessWord(){
  if(!roomRef)return;
  const guess=state.liarGuess.trim();
  if(!guess)return;
  const correct=guess===state.room.word;
  playSound(correct?'win':'wrong');
  updateRoom({phase:'result',liarGuessCorrect:correct})}

function showFinalResult(){if(!roomRef)return;updateRoom({phase:'result'})}

function newLiarRound(){
  if(!roomRef)return;
  const players=Object.values(state.room.players);
  const liarIdx=Math.floor(Math.random()*players.length);
  const topics=Object.keys(LIAR_TOPICS);
  const topic=topics[Math.floor(Math.random()*topics.length)];
  const words=LIAR_TOPICS[topic];
  const word=words[Math.floor(Math.random()*words.length)];
  state.liarFlipped=false;state.liarVote=null;state.liarGuess='';
  updateRoom({liarId:players[liarIdx].id,topic,word,phase:'role',votes:null,liarGuessCorrect:null,liarCaught:null})}

render();
</script>
</body>
</html>
